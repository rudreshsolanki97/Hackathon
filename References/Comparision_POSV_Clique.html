<!DOCTYPE html>
<!-- ExamDiff Pro HTML Template Version: 2.0 -->
<!-- Copyright (C) 1997-2018 PrestoSoft LLC -->
<!-- Generated by ExamDiff Pro build 10.0.1.2 -->
<!-- saved from url=(0014)about:internet -->
<html>

<head>
    <title>ExamDiff Pro Diff Report</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,700" rel="stylesheet">
    <style type="text/css">
        /* Test element for CSS calc() function*/
        #css3-calc {
            width: 10px;
            width: calc(10px + 10px);
            display: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #fff;
            font-family: Lucida Console, monospace;
            font-size: 13px;
            font-style: normal;
            font-weight: 400;
        }

        table td, table th {
            padding: 0;
        }

        .error {
            font-size: 24px;
            margin: 20px;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
        }

        #container {
            width: 100% - 20px);
            padding: 10px;
            border-radius: 5px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -khtml-border-radius: 5px;
        }

        .pane {
            float: left;
            margin: 10px 0 10px 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }

        #navigation {
            width: 100%;
            table-layout: fixed;
            border-spacing: 0;
        }

        #currentDiff {
            width: calc(100% - 20px);
            margin: 0 10px;
            font-family: 'Roboto', sans-serif;
        }

        #diff-select {
            padding: 4px 0;
            border-radius: 3px;
            margin-left: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .6);
        }

        .title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #454545;
            font-size: 15px;
            font-weight: 700;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            padding: 6px;
            position: relative;
            z-index: 1;
            margin-bottom: 4px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.5);
        }

        .file {
            overflow: auto;
            position: relative;
            z-index: 0;
        }

        .panes {
            border-spacing: 0;
            border-collapse: collapse;
        }

        .content {
            width: 100%;
        }

        .content div {
            min-width: 100%;
        }

        .header {
            background-color: #F0F0F0;
            height: 17px;
            border-bottom: 1px solid #999;
            color: #444;
        }

        .diffBar {
            vertical-align: top;
            width: 6px;
            min-width: 6px;
            background-color: #eee;
        }

        .diffs {
            position: relative;
        }

        .diff {
            position: absolute;
            left: -3px;
            min-width: 9px;
            background-color: #C0C0C0;
        }

        .diff.active {
            background-color: yellow;
            z-index: 1;
        }

        .nums {
            float: left;
        }

        .num {
            display: block;
            height: 13px;
            text-align: right;
            padding-left: 2px;
            padding-right: 4px;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-transform: translateZ(0);
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #legend {
            height: 13px;
            clear: both;
            padding-top: 3px;
            padding-bottom: 15px;
            font-family: 'Roboto', sans-serif;
        }

        #legend #numDiffs {
            float: left;
            margin-left: 3px;
        }

        #legend #colors {
            float: right;
            margin-left: 1em;
        }

        #legend #colors div {
            float: left;
            margin-right: 1em;
            padding: 5px 8px;
            border-radius: 15px;
        }

        #legend #colors div:last-child {
            margin-right: 0;
        }

        #inspector {
            clear: both;
            margin: 5px 0 10px 0;
            position: relative;
            top: 2px;
            overflow: auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            overflow-y: hidden;
        }

        #inspector .content div {
            width: 100%;
        }

        .inspectorLine {
            border-spacing: 0 1px;
        }

        #inspectorLeft {
            border-bottom: 1px dotted #444;
        }

        #generated_by {
            text-align: right;
            font-size: 0.7rem;
            font-family: Arial;
            color: #888;
            padding-top: 1px;
        }

        #generated_by a {
            color: #888;
        }

        .li, .la, .ld, .lc, .ln, .lo, .lg, .lh {
            position: relative;
            height: 13px;
            box-sizing: border-box;
            white-space:pre;;
        }

        .lib, .lab, .ldb, .lcb, .lnb, .lob, .lgb {
            position: absolute;
            bottom: 0px;
            height: 1px;
            border-bottom: 1px solid #000;
        }

        .lbin {
            white-space: pre;
            color: #000000;
            background-color: #FFFFFF;
            height: 13px;
        }

        .li, .si {
            color: #000000;
            background-color: #FFFFFF;
            text-decoration: none;
        }

        .la, .sa {
            color: #800000;
            background-color: #C0C0C0;
            text-decoration: none;
        }

        .ld, .sd {
            color: #0000FF;
            background-color: #E0E0E0;
            text-decoration: none;
        }

        .lc, .sc {
            color: #402000;
            background-color: #F2F2C6;
            text-decoration: none;
        }

        .ln, .sn {
            color: #800080;
            background-color: #A6CAF0;
            text-decoration: none;
        }

        .lo, .so {
            color: #FF0000;
            background-color: #C0DCC0;
            text-decoration: none;
        }

        .lg, .sig {
            color: #008000;
            background-color: #F0F0F0;
            text-decoration: none;
        }

        .sc2 {
            color: #FF0F87;
            background-color: #C6E2FF;
            text-decoration: none;
        }

        .lh {
            font-weight: 700;
            color: #3A33BC;
            display: inline-block;
            position: relative;
            white-space: nowrap;
        }

        .lh:before {
            position: absolute;
            display: block;
            top: 0;
            left: 0;
            bottom: 0;
            content: attr(data-content);
            background-color: #FFF;
            color: #FFF;
            z-index: -1;
            padding-right: .5em;
        }

        .lh:after {
            position: absolute;
            content: '';
            display: block;
            left: 0;
            right: 0;
            top: 50%;
            background-color: #3A33BC;
            height: 1px;
            min-height: 1px;
            z-index: -2;
        }

        .directory .content div {
            padding-left: 3px;
            box-sizing: border-box;
        }

        .directory .content span {
            margin-right: 3px;
        }

        .directory .l {
            width: 3248px;
        }

        /* ==========  Select Field ========== */

        /* Style Select Field */
        select {
            font-family: inherit;
            background-color: transparent;
            width: 100%;
            padding: 4px 0;
            font-size: 12px;
            color: rgb(0, 0, 0);
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.12);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA4UlEQVQ4T82TSwrCQBBEq5P7OEIynsFTqCAqHkH84AfUK4iJ4j1cunImYOJ1NC0GE9TEuMgmsxyoV1RXN6Hgo4J6lARQsWttBuRVn/sA+E8soyrlBiGdLt75EEUQUk7AmDGH28DzejkQQ9jSAdBi8CjQepnMIIYQwbko1c2ApMRP848hviBTIrhfEENYlgsymrFzHDPVgrDkGIQZwDtf687TJBEThoFSq/cZZdYoLDkCYY7wvmfTNInR4AxxKsI7+QVZRH+Mge+pdVY7uYskbPsIopuvVP1XtSXZxCIHVTjCA1kmWxGf+pdLAAAAAElFTkSuQmCC);
            background-repeat: no-repeat;
            background-position: right center;
        }

        select::-ms-expand {
            display: none;
        }

        select:hover {
            box-shadow: inset 0 -2px black;
            transition: all ease-in-out 50ms;
        }

        /* Remove focus */
        select:focus {
            outline: none;
        }

        .button {
            width: 32px;
            padding: 3px;
        }

        #tdBtnFirst {
            padding-left: 0;
        }

        .button button {
            width: 100%;
            position: relative;
            display: block;
            padding: 0;
            overflow: hidden;
            border-width: 0;
            outline: none;
            border-radius: 2px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .6);
            height: 25px;
            background-color: #EEE;
            background-repeat: no-repeat;
            background-position: center;
            color: #444;
            cursor: pointer;
            transition: background-color .3s;
        }

        .button button:hover {
            background-color: #BBB;
        }

        .button button > * {
            position: relative;
        }

        .button button span {
            display: block;
            padding: 12px 24px;
        }

        .button button:before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            display: block;
            width: 0;
            padding-top: 0;
            border-radius: 100%;
            background-color: rgba(236, 240, 241, .3);
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        .button button:active:before {
            width: 120%;
            padding-top: 120%;
            transition: width .2s ease-out, padding-top .2s ease-out;
        }

        /* Navigation button arrows */
        #btnFirst {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA2klEQVQ4T6XTOU4DQRBG4c8RKVwCDsByCEjAuQlZHCOuQYBYRIqvYLAhs7kI4ggmgQiV1COV0MxoYDps6b36u6p6oOcZ9OS1CTbwgAu8p0JjrOEq7poEAb9iG484LoKAb/CFrRDXCQJ+wQ4WOMAnMnyIWV2C9VK5E/xb8Gc4CwKO2LtdYufJVT0IwRx7/xWENEuW2C/NO8ctvhHNe65LUN01Sc5wVyRHeKqAujFmyVtJskKWDDFtW6QsmWBUKp7iviTZbFqk/JyIfYmP9O6TssrXbQk6/7Hev/EHnWxAEQGOq7sAAAAASUVORK5CYII=);
        }

        #btnPrevious {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAkElEQVQ4T7XTyQ3CMBRF0ZNWSDVQDwQ6YCgiEqUA3cCSYY0sYSlCcmwT4bXv9ZPf/42Jp5nIKxVscEX//WCJIMBb3NHiNpTkBBF+Yo5LTYI1dkjCQZZK0GGfg1OCFQ4l8N8EQTxMscA5NS9jLRRJcjVGyQshyammxng3Sh6Y1Q5SlCw/4PGXBKP7lvuD7LK+AZL8IhHkloozAAAAAElFTkSuQmCC);
        }

        #btnNext {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAjklEQVQ4T7XTuQ0CMRCF4W9DQIKQdjg6IaAAoAyOYoBy6AWtRGAhjwdY4djz+x3jzsDTDZwXAbaY4pg9UAPM8cAEB5xakEjBAneMM0grgxKyx7mmJAuxhOxweYdkgP5+E/J3wPIV5ghfW1jhhnC49xdZWOOaDUeAcpGqsssmIgUbzGq1/VJj8zt8UmMT8ASLkBYRatHp6AAAAABJRU5ErkJggg==);
        }

        #btnLast {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA2ElEQVQ4T6XTO06CYRCF4YcCqWQLug2094YL0N5La+EiTNwBoqVWop0uQdyBrgJcgZnkIxnxI0D+qee8M5lzpqVhtRrqZcA1fjBI0G3c4hyT2rAZYAtf6OAyQR5xik/s1yB5g0O8YiNBNvGG3UWQ+Rsc4WUdSO2IfYxWhSxy4RjPq0CaAPYwrQHy9AvcoVuOuYNxcWQats4Dsji8HxbxO3r4wEFMnmUiA7L4DPfLxHmDCNI32iV1IY56wkmZHEGKpP6pvMFVaXhIHQG+KcH6J67dYO3favyNv9m0OhE4k2c+AAAAAElFTkSuQmCC);
        }

        .num {
            border-right: 0 !important;
        }

        .s1-90{color:#0000FF;background-color:#FFFFFF;}
.s1-89{color:#008000;background-color:#FFFFFF;}
.s1-86{color:#0000FF;background-color:#FFFFFF;}
.s1-88{color:#000000;background-color:#FFFFFF;}
.s1-87{color:#000000;background-color:#FFFFFF;}
.s1-85{color:#A31515;background-color:#FFFFFF;}
.s1-100{color:#ACA899;background-color:#FFFFFF;}
.s2-90{color:#0000FF;background-color:#FFFFFF;}
.s2-89{color:#008000;background-color:#FFFFFF;}
.s2-86{color:#0000FF;background-color:#FFFFFF;}
.s2-88{color:#000000;background-color:#FFFFFF;}
.s2-87{color:#000000;background-color:#FFFFFF;}
.s2-85{color:#A31515;background-color:#FFFFFF;}
.s2-100{color:#ACA899;background-color:#FFFFFF;}
.num{color:#808080;background-color:#F8F8F8;border-right-width:2px;border-right-style:groove;border-right-color:#E0E0E0;}

    </style>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js">

    </script>

    <script type="text/javascript">
        var $mode = 'text';
        var $orientation = 'vertical';
        var $useLineInspector = true;
        var $lineHeight = 13;
        var $lineWidth = 3248
        var $scrollTimeout;
        var $diffs = [
null,
{d:'Diff 1: Change 1 line (1, first file) to 2 lines (1 - 2, second file)',l:[0,1]},
{d:'Diff 2: Change 1 line (3, first file) to 1 line (4, second file)',l:[3,3]},
{d:'Diff 3: Change 1 line (8, first file) to 1 line (9, second file)',l:[8,8]},
{d:'Diff 4: Change 4 lines (14 - 17, first file) to 4 lines (15 - 18, second file)',l:[14,17]},
{d:'Diff 5: Delete 1 line (22, first file) after line 22 (second file)',l:[22,22]},
{d:'Diff 6: Delete 1 line (25, first file) after line 24 (second file)',l:[25,25]},
{d:'Diff 7: Delete 1 line (33, first file) after line 31 (second file)',l:[33,33]},
{d:'Diff 8: Change 1 line (44, first file) to 1 line (42, second file)',l:[44,44]},
{d:'Diff 9: Add 1 line (46, second file) after line 47 (first file)',l:[48,48]},
{d:'Diff 10: Delete 1 line (51, first file) after line 50 (second file)',l:[53,53]},
{d:'Diff 11: Change 6 lines (54 - 59, first file) to 1 line (53, second file)',l:[56,61]},
{d:'Diff 12: Delete 1 line (62, first file) after line 55 (second file)',l:[64,64]},
{d:'Diff 13: Change 1 line (103, first file) to 1 line (96, second file)',l:[105,105]},
{d:'Diff 14: Change 2 lines (110 - 111, first file) to 1 line (103, second file)',l:[112,113]},
{d:'Diff 15: Change 1 line (114, first file) to 3 lines (106 - 108, second file)',l:[116,118]},
{d:'Diff 16: Change 2 lines (122 - 123, first file) to 1 line (116, second file)',l:[126,127]},
{d:'Diff 17: Add 3 lines (119 - 121, second file) after line 124 (first file)',l:[130,132]},
{d:'Diff 18: Change 11 lines (134 - 144, first file) to 6 lines (131 - 136, second file)',l:[142,152]},
{d:'Diff 19: Change 3 lines (149 - 151, first file) to 3 lines (141 - 143, second file)',l:[157,159]},
{d:'Diff 20: Delete 3 lines (182 - 184, first file) after line 172 (second file)',l:[190,192]},
{d:'Diff 21: Change 1 line (211, first file) to 1 line (199, second file)',l:[219,219]},
{d:'Diff 22: Change 2 lines (213 - 214, first file) to 2 lines (201 - 202, second file)',l:[221,222]},
{d:'Diff 23: Delete 2 lines (219 - 220, first file) after line 206 (second file)',l:[227,228]},
{d:'Diff 24: Change 1 line (224, first file) to 1 line (211, second file)',l:[233,233]},
{d:'Diff 25: Change 4 lines (227 - 230, first file) to 2 lines (214 - 215, second file)',l:[236,239]},
{d:'Diff 26: Change 1 line (233, first file) to 1 line (218, second file)',l:[242,242]},
{d:'Diff 27: Change 1 line (235, first file) to 1 line (220, second file)',l:[244,244]},
{d:'Diff 28: Change 4 lines (243 - 246, first file) to 3 lines (228 - 230, second file)',l:[252,255]},
{d:'Diff 29: Delete 2 lines (251 - 252, first file) after line 234 (second file)',l:[260,261]},
{d:'Diff 30: Change 1 line (259, first file) to 1 line (241, second file)',l:[268,268]},
{d:'Diff 31: Change 2 lines (264 - 265, first file) to 2 lines (246 - 247, second file)',l:[273,274]},
{d:'Diff 32: Change 1 line (271, first file) to 1 line (253, second file)',l:[280,280]},
{d:'Diff 33: Change 1 line (277, first file) to 1 line (259, second file)',l:[286,286]},
{d:'Diff 34: Delete 11 lines (289 - 299, first file) after line 269 (second file)',l:[298,308]},
{d:'Diff 35: Change 1 line (305, first file) to 1 line (275, second file)',l:[314,314]},
{d:'Diff 36: Change 1 line (369, first file) to 1 line (338, second file)',l:[378,378]},
{d:'Diff 37: Delete 3 lines (388 - 390, first file) after line 356 (second file)',l:[397,399]},
{d:'Diff 38: Change 5 lines (398 - 402, first file) to 3 lines (364 - 366, second file)',l:[407,411]},
{d:'Diff 39: Delete 16 lines (404 - 419, first file) after line 367 (second file)',l:[413,428]},
{d:'Diff 40: Change 8 lines (421 - 428, first file) to 2 lines (369 - 370, second file)',l:[430,437]},
{d:'Diff 41: Delete 75 lines (435 - 509, first file) after line 375 (second file)',l:[444,518]},
{d:'Diff 42: Change 1 line (512, first file) to 1 line (378, second file)',l:[521,521]},
{d:'Diff 43: Change 2 lines (525 - 526, first file) to 1 line (391, second file)',l:[534,535]},
{d:'Diff 44: Change 1 line (528, first file) to 1 line (393, second file)',l:[537,537]},
{d:'Diff 45: Change 7 lines (533 - 539, first file) to 7 lines (398 - 404, second file)',l:[542,548]},
{d:'Diff 46: Change 1 line (541, first file) to 1 line (406, second file)',l:[550,550]},
{d:'Diff 47: Change 1 line (543, first file) to 1 line (408, second file)',l:[552,552]},
{d:'Diff 48: Change 1 line (547, first file) to 1 line (412, second file)',l:[556,556]},
{d:'Diff 49: Add 1 line (415, second file) after line 549 (first file)',l:[559,559]},
{d:'Diff 50: Change 1 line (580, first file) to 1 line (446, second file)',l:[590,590]},
{d:'Diff 51: Change 1 line (591, first file) to 1 line (457, second file)',l:[601,601]},
{d:'Diff 52: Change 1 line (600, first file) to 1 line (466, second file)',l:[610,610]},
{d:'Diff 53: Change 3 lines (608 - 610, first file) to 1 line (474, second file)',l:[618,620]},
{d:'Diff 54: Change 1 line (623, first file) to 1 line (487, second file)',l:[633,633]},
{d:'Diff 55: Change 15 lines (627 - 641, first file) to 2 lines (491 - 492, second file)',l:[637,651]},
{d:'Diff 56: Delete 7 lines (643 - 649, first file) after line 493 (second file)',l:[653,659]},
{d:'Diff 57: Change 1 line (651, first file) to 1 line (495, second file)',l:[661,661]},
{d:'Diff 58: Change 5 lines (653 - 657, first file) to 2 lines (497 - 498, second file)',l:[663,667]},
{d:'Diff 59: Add 5 lines (502 - 506, second file) after line 660 (first file)',l:[671,675]},
{d:'Diff 60: Add 2 lines (508 - 509, second file) after line 661 (first file)',l:[677,678]},
{d:'Diff 61: Delete 12 lines (664 - 675, first file) after line 510 (second file)',l:[681,692]},
{d:'Diff 62: Delete 5 lines (677 - 681, first file) after line 511 (second file)',l:[694,698]},
{d:'Diff 63: Delete 24 lines (685 - 708, first file) after line 513 (second file)',l:[702,725]},
{d:'Diff 64: Change 1 line (712, first file) to 1 line (517, second file)',l:[729,729]},
{d:'Diff 65: Change 1 line (745, first file) to 1 line (550, second file)',l:[762,762]},
{d:'Diff 66: Delete 1 line (752, first file) after line 556 (second file)',l:[769,769]},
{d:'Diff 67: Change 21 lines (754 - 774, first file) to 1 line (559, second file)',l:[772,792]},
{d:'Diff 68: Delete 6 lines (792 - 797, first file) after line 576 (second file)',l:[810,815]},
{d:'Diff 69: Delete 30 lines (801 - 830, first file) after line 578 (second file)',l:[819,848]},
{d:'Diff 70: Change 11 lines (834 - 844, first file) to 1 line (582, second file)',l:[852,862]},
{d:'Diff 71: Change 1 line (856, first file) to 1 line (593, second file)',l:[874,874]},
{d:'Diff 72: Change 1 line (866, first file) to 1 line (603, second file)',l:[884,884]},
{d:'Diff 73: Change 1 line (872, first file) to 1 line (609, second file)',l:[890,890]},
{d:'Diff 74: Change 1 line (876, first file) to 2 lines (613 - 614, second file)',l:[894,895]},
{d:'Diff 75: Change 1 line (886, first file) to 1 line (624, second file)',l:[905,905]},
{d:'Diff 76: Delete 1 line (888, first file) after line 625 (second file)',l:[907,907]},
{d:'Diff 77: Change 10 lines (890 - 899, first file) to 1 line (627, second file)',l:[909,918]},
{d:'Diff 78: Delete 2 lines (902 - 903, first file) after line 629 (second file)',l:[921,922]},
{d:'Diff 79: Change 5 lines (907 - 911, first file) to 1 line (633, second file)',l:[926,930]},
{d:'Diff 80: Change 4 lines (913 - 916, first file) to 1 line (635, second file)',l:[932,935]},
{d:'Diff 81: Change 4 lines (920 - 923, first file) to 8 lines (639 - 646, second file)',l:[939,946]},
{d:'Diff 82: Change 1 line (928, first file) to 1 line (651, second file)',l:[951,951]},
{d:'Diff 83: Change 1 line (932, first file) to 7 lines (654 - 660, second file)',l:[955,961]},
{d:'Diff 84: Add 9 lines (663 - 671, second file) after line 933 (first file)',l:[964,972]},
{d:'Diff 85: Change 1 line (938, first file) to 1 line (676, second file)',l:[977,977]},
{d:'Diff 86: Add 9 lines (694 - 702, second file) after line 954 (first file)',l:[995,1003]},
{d:'Diff 87: Change 1 line (958, first file) to 1 line (706, second file)',l:[1007,1007]},
{d:'Diff 88: Change 1 line (960, first file) to 1 line (708, second file)',l:[1009,1009]},
{d:'Diff 89: Change 1 line (962, first file) to 1 line (710, second file)',l:[1011,1011]},
{d:'Diff 90: Delete 102 lines (965 - 1066, first file) after line 712 (second file)',l:[1014,1115]}
];

        try {
            $(document).ready(function () {
                // Check css calc() support. We'll use it to reject older browsers.
                $('body').append('<div id="css3-calc"></div>');
                if ($('#css3-calc').width() == 10) {
                    $('body').empty().append('<div class="error">This browser does not support ExamDiff Pro HTML diff reports. Please upgrade your browser to the latest Firefox, Chrome, Microsoft Edge, or Internet Explorer.</div>');
                } else {
                    $('#css3-calc').remove(); // Remove the test element

                    $(window).bind('load resize', fitToWindow);

                    populateDiffs();
                    registerEventHandlers();

                    if ($useLineInspector) {
                        $('#inspector').show();
                        setLineInspector(0);
                    }

                    $(window).load(function () {
                        firstDiff();
                    });
                }
            });
        } catch (e) {
            $('body').empty().append('<div class="error">This HTML diff report did not load correctly, most likely due to lack of an Internet connection.\n\nIf you wish for ExamDiff Pro diff reports to be viewed on computers without Internet access, make sure to check the "Enable offline report viewing" option under Options | HTML.</div>');
        }

        function getCssValue(obj, name) {
            return parseInt(obj.css(name), 10);
        }

        function fitToWindow() {
            var containerPaddingTop = getCssValue($('#container'), 'padding-top');
            var containerPaddingBottom = getCssValue($('#container'), 'padding-bottom');
            var paneMarginTop = getCssValue($('.pane'), 'margin-top');
            var paneMarginBottom = getCssValue($('.pane'), 'margin-bottom');

            var panesHeight = $(window).height() - containerPaddingTop - containerPaddingBottom - $('#navigation').outerHeight(true) - $('#legend').outerHeight(true) - $('#generated_by').outerHeight(true);
            if ($useLineInspector) {
                panesHeight -= $('#inspector').outerHeight(true);
            }

            var fileHeight;
            if ($orientation == 'vertical') {
                fileHeight = panesHeight - $('.title').outerHeight(true) - paneMarginTop - paneMarginBottom;
            } else {
                fileHeight = (panesHeight - 2 * $('.title').outerHeight(true) - paneMarginTop - 2 * paneMarginBottom) / 2;
            }

            $('.file').height(fileHeight);

            if ($orientation == 'vertical') {
                // 5px is half of getCssValue($('.pane'), 'margin-left');
                $('.pane').css('width', 'calc(50% - 5px)');
                $('#pane1').css('margin-left', '0');
            } else {
                $('.pane').css('width', '100%').css('margin-left', '0');
                $('#pane2').css('margin-top', '0');
            }
        }

        function populateDiffs() {
            if ($diffs.length > 1) {
                for (var i = 1; i < $diffs.length; i++) {
                    $('#currentDiff').append($('<option></option>').attr('value', i).text($diffs[i].d));
                    $('.diffs').append($('<div class="diff"></div>')
                        .attr('title', $diffs[i].d)
                        .css('top', ($diffs[i].l[0] * $lineHeight) + 'px')
                        .height((($diffs[i].l[1] - $diffs[i].l[0] + 1) * $lineHeight)));
                    $('.d' + i).attr('title', $diffs[i].d);
                }

                if ($mode == 'directory') {
                    var headerHeight = $('.header').outerHeight(true);
                    $('.diffs').css('margin-top', headerHeight + 'px');
                }

                $('.diffBar').show();
            } else {
                $('#currentDiff').append($('<option></option>').attr('value', 0).text('(No differences)'));
            }
        }

        function registerEventHandlers() {
            $('#currentDiff').bind('change keyup', function () {
                goto(currentDiff());
            });

            $('#file1').scroll(function (event) {
                syncScroll(event);
            });
            $('#file2').scroll(function (event) {
                syncScroll(event);
            });

            $('.file .l').click(function () {
                updateCurrentDiff(this);
                updateLineInspector(this);
            })

            $('#btnFirst').click(firstDiff);
            $('#btnPrevious').click(previousDiff);
            $('#btnNext').click(nextDiff);
            $('#btnLast').click(lastDiff);
        }

        function syncScroll(e) {
            clearTimeout($scrollTimeout);

            if (!e) e = window.event;
            var $source = $(e.target);
            var $target = ($source.attr('id') == 'file1') ? $('#file2') : $('#file1')

            $target.off("scroll").scrollTop($source.scrollTop());
            $target.off("scroll").scrollLeft($source.scrollLeft());

            $scrollTimeout = setTimeout(function () {
                $target.scroll(syncScroll);
            }, 100, e);
        }

        function goto(diff) {
            if (diff > 0 && diff <= $diffs.length) {
                markCurrentDiff(diff);
                setLineInspector($diffs[diff].l[0]);

                if ($('.comparison .diffBar').css('display') != 'none') {
                    var block = $('.diff').eq(diff - 1);
                    var tableMidpoint = $('.file').height() / 2;

                    if (block.height() > $('.pane').height()) {
                        // Scroll to the top of the diff block
                        $('.file').scrollTop(block.position().top - $lineHeight);
                    } else {
                        // Scroll so that diff block is centered
                        var midpoint = block.position().top + (block.height() / 2);
                        $('.file').scrollTop(midpoint - tableMidpoint);
                    }
                } else {
                    // If diff bar's not shown, just scroll first diff line to top
                    var scrollPos = $('.d' + diff).first().position().top - $('.l').first().position().top;
                    if ($mode == 'directory') {
                        var headerHeight = $('.header').outerHeight(true);
                        scrollPos += headerHeight; // to account for header
                    }
                    $('.file').scrollTop(scrollPos);
                }
            }
        }

        function markCurrentDiff(diff) {
            $('#currentDiff').val(diff);

            $('.diff').removeClass('active');
            $('.comparison .diffs').each(function (i, diffBar) {
                $(diffBar).children().eq(diff - 1).addClass('active');
            });
        }

        function updateCurrentDiff(clickedDiv) {
            var lineNum = $(clickedDiv).parent().children('.l').index($(clickedDiv));
            markCurrentDiff(closestDiffToLine(lineNum));
        }

        function updateLineInspector(clickedDiv) {
            var lineNum = $(clickedDiv).parent().children('.l').index($(clickedDiv));
            setLineInspector(lineNum);
        }

        function setLineInspector(lineNum) {
            var leftLine = $($('#file1 .l').get(lineNum));
            var rightLine = $($('#file2 .l').get(lineNum));

            $('#inspectorLeftContent').html(leftLine.html())
                .attr('class', leftLine.attr('class'));
            $('#inspectorRightContent').html(rightLine.html())
                .attr('class', rightLine.attr('class'));

            if ($('.comparison .num').size() > 0) {
                var leftNum = $($('#file1 .num').get(lineNum));
                var rightNum = $($('#file2 .num').get(lineNum));
                var maxNumWidth = Math.max(leftNum.width(), rightNum.width());

                $('#inspector .left .num').html(leftNum.html())
                    .width(maxNumWidth);
                $('#inspector .right .num').html(rightNum.html())
                    .width(maxNumWidth);
            } else {
                $('#inspector .num').html('')
                    .css('width', 0).css('border', 0).css('padding', 0);
            }

            var maxWidth = Math.max(calcDivWidth(leftLine), calcDivWidth(rightLine));
            $('#inspectorLeftContent').width(maxWidth);
            $('#inspectorRightContent').width(maxWidth);
        }

        function calcDivWidth(divElement){
            var width = 0;
            divElement.children().each(function(){
                var $span = $(this);
                width += $span.width();
            });
            return width;
        }

        function closestDiffToLine(num) {
            var closest = {
                diff: null,
                dist: Infinity
            };

            for (var i = 1; i < $diffs.length; i++) {
                if ($diffs[i].l[0] <= num && $diffs[i].l[1] >= num) {
                    closest = { diff: i, dist: 0 };
                } else {
                    var dist = ($diffs[i].l[0] <= num) ? (num - $diffs[i].l[1]) : ($diffs[i].l[0] - num);
                    if (dist <= closest.dist) {
                        closest = { diff: i, dist: dist };
                    }
                }
            }

            return closest.diff;
        }

        function currentDiff() {
            return parseInt($('#currentDiff').val());
        }

        function firstDiff() {
            goto(1);
        }

        function previousDiff() {
            var diff = currentDiff();
            if (diff > 1) {
                diff--;
            }
            goto(diff);
        }

        function nextDiff() {
            var diff = currentDiff();
            if (diff < ($diffs.length - 1)) {
                diff++;
            }
            goto(diff);
        }

        function lastDiff() {
            goto($diffs.length - 1);
        }
    </script>
</head>

<body>
    <div id="container" style="">
        <!-- $JS_ONLY_BEGIN$ -->
        <table id="navigation">
            <tr>
                <td class="button" id="tdBtnFirst"><button title="First Difference" id="btnFirst"></button></td>
                <td class="button"><button title="Previous Difference" id="btnPrevious"></button></td>
                <td class="button"><button title="Next Difference" id="btnNext"></button></td>
                <td class="button"><button title="Last Difference" id="btnLast"></button></td>
                <td>
                    <div id="diff-select">
                        <select id="currentDiff" size="1"></select>
                    </div>
                </td>
            </tr>
        </table>
        <!-- $JS_ONLY_END$ -->

        <div class="text comparison">
            <div id="pane1" class="pane" style="">
                <div id="title1" class="title" style="" title="https://raw.githubusercontent.com/tomochain/tomochain/master/consensus/posv/posv.go">https://raw.githubusercontent.com/tomochain/tomochain/master/consensus/posv/posv.go</div>
                <div id="file1" class="file" style=" ">
                    <table class="panes">
                        <tr>
                            <td class="diffBar" style="display: none;">
                                <div class="diffs"></div>
                            </td>
                            <td class="nums">
                                <div class="num">   1 </div>
<div class="num">     </div>
<div class="num">   2 </div>
<div class="num">   3 </div>
<div class="num">   4 </div>
<div class="num">   5 </div>
<div class="num">   6 </div>
<div class="num">   7 </div>
<div class="num">   8 </div>
<div class="num">   9 </div>
<div class="num">  10 </div>
<div class="num">  11 </div>
<div class="num">  12 </div>
<div class="num">  13 </div>
<div class="num">  14 </div>
<div class="num">  15 </div>
<div class="num">  16 </div>
<div class="num">  17 </div>
<div class="num">  18 </div>
<div class="num">  19 </div>
<div class="num">  20 </div>
<div class="num">  21 </div>
<div class="num">  22 </div>
<div class="num">  23 </div>
<div class="num">  24 </div>
<div class="num">  25 </div>
<div class="num">  26 </div>
<div class="num">  27 </div>
<div class="num">  28 </div>
<div class="num">  29 </div>
<div class="num">  30 </div>
<div class="num">  31 </div>
<div class="num">  32 </div>
<div class="num">  33 </div>
<div class="num">  34 </div>
<div class="num">  35 </div>
<div class="num">  36 </div>
<div class="num">  37 </div>
<div class="num">  38 </div>
<div class="num">  39 </div>
<div class="num">  40 </div>
<div class="num">  41 </div>
<div class="num">  42 </div>
<div class="num">  43 </div>
<div class="num">  44 </div>
<div class="num">  45 </div>
<div class="num">  46 </div>
<div class="num">  47 </div>
<div class="num">     </div>
<div class="num">  48 </div>
<div class="num">  49 </div>
<div class="num">     </div>
<div class="num">  50 </div>
<div class="num">  51 </div>
<div class="num">  52 </div>
<div class="num">  53 </div>
<div class="num">  54 </div>
<div class="num">  55 </div>
<div class="num">  56 </div>
<div class="num">  57 </div>
<div class="num">  58 </div>
<div class="num">  59 </div>
<div class="num">  60 </div>
<div class="num">  61 </div>
<div class="num">  62 </div>
<div class="num">  63 </div>
<div class="num">  64 </div>
<div class="num">  65 </div>
<div class="num">  66 </div>
<div class="num">  67 </div>
<div class="num">  68 </div>
<div class="num">  69 </div>
<div class="num">  70 </div>
<div class="num">  71 </div>
<div class="num">  72 </div>
<div class="num">  73 </div>
<div class="num">  74 </div>
<div class="num">  75 </div>
<div class="num">  76 </div>
<div class="num">  77 </div>
<div class="num">  78 </div>
<div class="num">  79 </div>
<div class="num">  80 </div>
<div class="num">  81 </div>
<div class="num">  82 </div>
<div class="num">  83 </div>
<div class="num">  84 </div>
<div class="num">  85 </div>
<div class="num">  86 </div>
<div class="num">  87 </div>
<div class="num">  88 </div>
<div class="num">  89 </div>
<div class="num">  90 </div>
<div class="num">  91 </div>
<div class="num">  92 </div>
<div class="num">  93 </div>
<div class="num">  94 </div>
<div class="num">  95 </div>
<div class="num">  96 </div>
<div class="num">  97 </div>
<div class="num">  98 </div>
<div class="num">  99 </div>
<div class="num"> 100 </div>
<div class="num"> 101 </div>
<div class="num"> 102 </div>
<div class="num"> 103 </div>
<div class="num"> 104 </div>
<div class="num"> 105 </div>
<div class="num"> 106 </div>
<div class="num"> 107 </div>
<div class="num"> 108 </div>
<div class="num"> 109 </div>
<div class="num"> 110 </div>
<div class="num"> 111 </div>
<div class="num"> 112 </div>
<div class="num"> 113 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 114 </div>
<div class="num"> 115 </div>
<div class="num"> 116 </div>
<div class="num"> 117 </div>
<div class="num"> 118 </div>
<div class="num"> 119 </div>
<div class="num"> 120 </div>
<div class="num"> 121 </div>
<div class="num"> 122 </div>
<div class="num"> 123 </div>
<div class="num"> 124 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 125 </div>
<div class="num"> 126 </div>
<div class="num"> 127 </div>
<div class="num"> 128 </div>
<div class="num"> 129 </div>
<div class="num"> 130 </div>
<div class="num"> 131 </div>
<div class="num"> 132 </div>
<div class="num"> 133 </div>
<div class="num"> 134 </div>
<div class="num"> 135 </div>
<div class="num"> 136 </div>
<div class="num"> 137 </div>
<div class="num"> 138 </div>
<div class="num"> 139 </div>
<div class="num"> 140 </div>
<div class="num"> 141 </div>
<div class="num"> 142 </div>
<div class="num"> 143 </div>
<div class="num"> 144 </div>
<div class="num"> 145 </div>
<div class="num"> 146 </div>
<div class="num"> 147 </div>
<div class="num"> 148 </div>
<div class="num"> 149 </div>
<div class="num"> 150 </div>
<div class="num"> 151 </div>
<div class="num"> 152 </div>
<div class="num"> 153 </div>
<div class="num"> 154 </div>
<div class="num"> 155 </div>
<div class="num"> 156 </div>
<div class="num"> 157 </div>
<div class="num"> 158 </div>
<div class="num"> 159 </div>
<div class="num"> 160 </div>
<div class="num"> 161 </div>
<div class="num"> 162 </div>
<div class="num"> 163 </div>
<div class="num"> 164 </div>
<div class="num"> 165 </div>
<div class="num"> 166 </div>
<div class="num"> 167 </div>
<div class="num"> 168 </div>
<div class="num"> 169 </div>
<div class="num"> 170 </div>
<div class="num"> 171 </div>
<div class="num"> 172 </div>
<div class="num"> 173 </div>
<div class="num"> 174 </div>
<div class="num"> 175 </div>
<div class="num"> 176 </div>
<div class="num"> 177 </div>
<div class="num"> 178 </div>
<div class="num"> 179 </div>
<div class="num"> 180 </div>
<div class="num"> 181 </div>
<div class="num"> 182 </div>
<div class="num"> 183 </div>
<div class="num"> 184 </div>
<div class="num"> 185 </div>
<div class="num"> 186 </div>
<div class="num"> 187 </div>
<div class="num"> 188 </div>
<div class="num"> 189 </div>
<div class="num"> 190 </div>
<div class="num"> 191 </div>
<div class="num"> 192 </div>
<div class="num"> 193 </div>
<div class="num"> 194 </div>
<div class="num"> 195 </div>
<div class="num"> 196 </div>
<div class="num"> 197 </div>
<div class="num"> 198 </div>
<div class="num"> 199 </div>
<div class="num"> 200 </div>
<div class="num"> 201 </div>
<div class="num"> 202 </div>
<div class="num"> 203 </div>
<div class="num"> 204 </div>
<div class="num"> 205 </div>
<div class="num"> 206 </div>
<div class="num"> 207 </div>
<div class="num"> 208 </div>
<div class="num"> 209 </div>
<div class="num"> 210 </div>
<div class="num"> 211 </div>
<div class="num"> 212 </div>
<div class="num"> 213 </div>
<div class="num"> 214 </div>
<div class="num"> 215 </div>
<div class="num"> 216 </div>
<div class="num"> 217 </div>
<div class="num"> 218 </div>
<div class="num"> 219 </div>
<div class="num"> 220 </div>
<div class="num">     </div>
<div class="num"> 221 </div>
<div class="num"> 222 </div>
<div class="num"> 223 </div>
<div class="num"> 224 </div>
<div class="num"> 225 </div>
<div class="num"> 226 </div>
<div class="num"> 227 </div>
<div class="num"> 228 </div>
<div class="num"> 229 </div>
<div class="num"> 230 </div>
<div class="num"> 231 </div>
<div class="num"> 232 </div>
<div class="num"> 233 </div>
<div class="num"> 234 </div>
<div class="num"> 235 </div>
<div class="num"> 236 </div>
<div class="num"> 237 </div>
<div class="num"> 238 </div>
<div class="num"> 239 </div>
<div class="num"> 240 </div>
<div class="num"> 241 </div>
<div class="num"> 242 </div>
<div class="num"> 243 </div>
<div class="num"> 244 </div>
<div class="num"> 245 </div>
<div class="num"> 246 </div>
<div class="num"> 247 </div>
<div class="num"> 248 </div>
<div class="num"> 249 </div>
<div class="num"> 250 </div>
<div class="num"> 251 </div>
<div class="num"> 252 </div>
<div class="num"> 253 </div>
<div class="num"> 254 </div>
<div class="num"> 255 </div>
<div class="num"> 256 </div>
<div class="num"> 257 </div>
<div class="num"> 258 </div>
<div class="num"> 259 </div>
<div class="num"> 260 </div>
<div class="num"> 261 </div>
<div class="num"> 262 </div>
<div class="num"> 263 </div>
<div class="num"> 264 </div>
<div class="num"> 265 </div>
<div class="num"> 266 </div>
<div class="num"> 267 </div>
<div class="num"> 268 </div>
<div class="num"> 269 </div>
<div class="num"> 270 </div>
<div class="num"> 271 </div>
<div class="num"> 272 </div>
<div class="num"> 273 </div>
<div class="num"> 274 </div>
<div class="num"> 275 </div>
<div class="num"> 276 </div>
<div class="num"> 277 </div>
<div class="num"> 278 </div>
<div class="num"> 279 </div>
<div class="num"> 280 </div>
<div class="num"> 281 </div>
<div class="num"> 282 </div>
<div class="num"> 283 </div>
<div class="num"> 284 </div>
<div class="num"> 285 </div>
<div class="num"> 286 </div>
<div class="num"> 287 </div>
<div class="num"> 288 </div>
<div class="num"> 289 </div>
<div class="num"> 290 </div>
<div class="num"> 291 </div>
<div class="num"> 292 </div>
<div class="num"> 293 </div>
<div class="num"> 294 </div>
<div class="num"> 295 </div>
<div class="num"> 296 </div>
<div class="num"> 297 </div>
<div class="num"> 298 </div>
<div class="num"> 299 </div>
<div class="num"> 300 </div>
<div class="num"> 301 </div>
<div class="num"> 302 </div>
<div class="num"> 303 </div>
<div class="num"> 304 </div>
<div class="num"> 305 </div>
<div class="num"> 306 </div>
<div class="num"> 307 </div>
<div class="num"> 308 </div>
<div class="num"> 309 </div>
<div class="num"> 310 </div>
<div class="num"> 311 </div>
<div class="num"> 312 </div>
<div class="num"> 313 </div>
<div class="num"> 314 </div>
<div class="num"> 315 </div>
<div class="num"> 316 </div>
<div class="num"> 317 </div>
<div class="num"> 318 </div>
<div class="num"> 319 </div>
<div class="num"> 320 </div>
<div class="num"> 321 </div>
<div class="num"> 322 </div>
<div class="num"> 323 </div>
<div class="num"> 324 </div>
<div class="num"> 325 </div>
<div class="num"> 326 </div>
<div class="num"> 327 </div>
<div class="num"> 328 </div>
<div class="num"> 329 </div>
<div class="num"> 330 </div>
<div class="num"> 331 </div>
<div class="num"> 332 </div>
<div class="num"> 333 </div>
<div class="num"> 334 </div>
<div class="num"> 335 </div>
<div class="num"> 336 </div>
<div class="num"> 337 </div>
<div class="num"> 338 </div>
<div class="num"> 339 </div>
<div class="num"> 340 </div>
<div class="num"> 341 </div>
<div class="num"> 342 </div>
<div class="num"> 343 </div>
<div class="num"> 344 </div>
<div class="num"> 345 </div>
<div class="num"> 346 </div>
<div class="num"> 347 </div>
<div class="num"> 348 </div>
<div class="num"> 349 </div>
<div class="num"> 350 </div>
<div class="num"> 351 </div>
<div class="num"> 352 </div>
<div class="num"> 353 </div>
<div class="num"> 354 </div>
<div class="num"> 355 </div>
<div class="num"> 356 </div>
<div class="num"> 357 </div>
<div class="num"> 358 </div>
<div class="num"> 359 </div>
<div class="num"> 360 </div>
<div class="num"> 361 </div>
<div class="num"> 362 </div>
<div class="num"> 363 </div>
<div class="num"> 364 </div>
<div class="num"> 365 </div>
<div class="num"> 366 </div>
<div class="num"> 367 </div>
<div class="num"> 368 </div>
<div class="num"> 369 </div>
<div class="num"> 370 </div>
<div class="num"> 371 </div>
<div class="num"> 372 </div>
<div class="num"> 373 </div>
<div class="num"> 374 </div>
<div class="num"> 375 </div>
<div class="num"> 376 </div>
<div class="num"> 377 </div>
<div class="num"> 378 </div>
<div class="num"> 379 </div>
<div class="num"> 380 </div>
<div class="num"> 381 </div>
<div class="num"> 382 </div>
<div class="num"> 383 </div>
<div class="num"> 384 </div>
<div class="num"> 385 </div>
<div class="num"> 386 </div>
<div class="num"> 387 </div>
<div class="num"> 388 </div>
<div class="num"> 389 </div>
<div class="num"> 390 </div>
<div class="num"> 391 </div>
<div class="num"> 392 </div>
<div class="num"> 393 </div>
<div class="num"> 394 </div>
<div class="num"> 395 </div>
<div class="num"> 396 </div>
<div class="num"> 397 </div>
<div class="num"> 398 </div>
<div class="num"> 399 </div>
<div class="num"> 400 </div>
<div class="num"> 401 </div>
<div class="num"> 402 </div>
<div class="num"> 403 </div>
<div class="num"> 404 </div>
<div class="num"> 405 </div>
<div class="num"> 406 </div>
<div class="num"> 407 </div>
<div class="num"> 408 </div>
<div class="num"> 409 </div>
<div class="num"> 410 </div>
<div class="num"> 411 </div>
<div class="num"> 412 </div>
<div class="num"> 413 </div>
<div class="num"> 414 </div>
<div class="num"> 415 </div>
<div class="num"> 416 </div>
<div class="num"> 417 </div>
<div class="num"> 418 </div>
<div class="num"> 419 </div>
<div class="num"> 420 </div>
<div class="num"> 421 </div>
<div class="num"> 422 </div>
<div class="num"> 423 </div>
<div class="num"> 424 </div>
<div class="num"> 425 </div>
<div class="num"> 426 </div>
<div class="num"> 427 </div>
<div class="num"> 428 </div>
<div class="num"> 429 </div>
<div class="num"> 430 </div>
<div class="num"> 431 </div>
<div class="num"> 432 </div>
<div class="num"> 433 </div>
<div class="num"> 434 </div>
<div class="num"> 435 </div>
<div class="num"> 436 </div>
<div class="num"> 437 </div>
<div class="num"> 438 </div>
<div class="num"> 439 </div>
<div class="num"> 440 </div>
<div class="num"> 441 </div>
<div class="num"> 442 </div>
<div class="num"> 443 </div>
<div class="num"> 444 </div>
<div class="num"> 445 </div>
<div class="num"> 446 </div>
<div class="num"> 447 </div>
<div class="num"> 448 </div>
<div class="num"> 449 </div>
<div class="num"> 450 </div>
<div class="num"> 451 </div>
<div class="num"> 452 </div>
<div class="num"> 453 </div>
<div class="num"> 454 </div>
<div class="num"> 455 </div>
<div class="num"> 456 </div>
<div class="num"> 457 </div>
<div class="num"> 458 </div>
<div class="num"> 459 </div>
<div class="num"> 460 </div>
<div class="num"> 461 </div>
<div class="num"> 462 </div>
<div class="num"> 463 </div>
<div class="num"> 464 </div>
<div class="num"> 465 </div>
<div class="num"> 466 </div>
<div class="num"> 467 </div>
<div class="num"> 468 </div>
<div class="num"> 469 </div>
<div class="num"> 470 </div>
<div class="num"> 471 </div>
<div class="num"> 472 </div>
<div class="num"> 473 </div>
<div class="num"> 474 </div>
<div class="num"> 475 </div>
<div class="num"> 476 </div>
<div class="num"> 477 </div>
<div class="num"> 478 </div>
<div class="num"> 479 </div>
<div class="num"> 480 </div>
<div class="num"> 481 </div>
<div class="num"> 482 </div>
<div class="num"> 483 </div>
<div class="num"> 484 </div>
<div class="num"> 485 </div>
<div class="num"> 486 </div>
<div class="num"> 487 </div>
<div class="num"> 488 </div>
<div class="num"> 489 </div>
<div class="num"> 490 </div>
<div class="num"> 491 </div>
<div class="num"> 492 </div>
<div class="num"> 493 </div>
<div class="num"> 494 </div>
<div class="num"> 495 </div>
<div class="num"> 496 </div>
<div class="num"> 497 </div>
<div class="num"> 498 </div>
<div class="num"> 499 </div>
<div class="num"> 500 </div>
<div class="num"> 501 </div>
<div class="num"> 502 </div>
<div class="num"> 503 </div>
<div class="num"> 504 </div>
<div class="num"> 505 </div>
<div class="num"> 506 </div>
<div class="num"> 507 </div>
<div class="num"> 508 </div>
<div class="num"> 509 </div>
<div class="num"> 510 </div>
<div class="num"> 511 </div>
<div class="num"> 512 </div>
<div class="num"> 513 </div>
<div class="num"> 514 </div>
<div class="num"> 515 </div>
<div class="num"> 516 </div>
<div class="num"> 517 </div>
<div class="num"> 518 </div>
<div class="num"> 519 </div>
<div class="num"> 520 </div>
<div class="num"> 521 </div>
<div class="num"> 522 </div>
<div class="num"> 523 </div>
<div class="num"> 524 </div>
<div class="num"> 525 </div>
<div class="num"> 526 </div>
<div class="num"> 527 </div>
<div class="num"> 528 </div>
<div class="num"> 529 </div>
<div class="num"> 530 </div>
<div class="num"> 531 </div>
<div class="num"> 532 </div>
<div class="num"> 533 </div>
<div class="num"> 534 </div>
<div class="num"> 535 </div>
<div class="num"> 536 </div>
<div class="num"> 537 </div>
<div class="num"> 538 </div>
<div class="num"> 539 </div>
<div class="num"> 540 </div>
<div class="num"> 541 </div>
<div class="num"> 542 </div>
<div class="num"> 543 </div>
<div class="num"> 544 </div>
<div class="num"> 545 </div>
<div class="num"> 546 </div>
<div class="num"> 547 </div>
<div class="num"> 548 </div>
<div class="num"> 549 </div>
<div class="num">     </div>
<div class="num"> 550 </div>
<div class="num"> 551 </div>
<div class="num"> 552 </div>
<div class="num"> 553 </div>
<div class="num"> 554 </div>
<div class="num"> 555 </div>
<div class="num"> 556 </div>
<div class="num"> 557 </div>
<div class="num"> 558 </div>
<div class="num"> 559 </div>
<div class="num"> 560 </div>
<div class="num"> 561 </div>
<div class="num"> 562 </div>
<div class="num"> 563 </div>
<div class="num"> 564 </div>
<div class="num"> 565 </div>
<div class="num"> 566 </div>
<div class="num"> 567 </div>
<div class="num"> 568 </div>
<div class="num"> 569 </div>
<div class="num"> 570 </div>
<div class="num"> 571 </div>
<div class="num"> 572 </div>
<div class="num"> 573 </div>
<div class="num"> 574 </div>
<div class="num"> 575 </div>
<div class="num"> 576 </div>
<div class="num"> 577 </div>
<div class="num"> 578 </div>
<div class="num"> 579 </div>
<div class="num"> 580 </div>
<div class="num"> 581 </div>
<div class="num"> 582 </div>
<div class="num"> 583 </div>
<div class="num"> 584 </div>
<div class="num"> 585 </div>
<div class="num"> 586 </div>
<div class="num"> 587 </div>
<div class="num"> 588 </div>
<div class="num"> 589 </div>
<div class="num"> 590 </div>
<div class="num"> 591 </div>
<div class="num"> 592 </div>
<div class="num"> 593 </div>
<div class="num"> 594 </div>
<div class="num"> 595 </div>
<div class="num"> 596 </div>
<div class="num"> 597 </div>
<div class="num"> 598 </div>
<div class="num"> 599 </div>
<div class="num"> 600 </div>
<div class="num"> 601 </div>
<div class="num"> 602 </div>
<div class="num"> 603 </div>
<div class="num"> 604 </div>
<div class="num"> 605 </div>
<div class="num"> 606 </div>
<div class="num"> 607 </div>
<div class="num"> 608 </div>
<div class="num"> 609 </div>
<div class="num"> 610 </div>
<div class="num"> 611 </div>
<div class="num"> 612 </div>
<div class="num"> 613 </div>
<div class="num"> 614 </div>
<div class="num"> 615 </div>
<div class="num"> 616 </div>
<div class="num"> 617 </div>
<div class="num"> 618 </div>
<div class="num"> 619 </div>
<div class="num"> 620 </div>
<div class="num"> 621 </div>
<div class="num"> 622 </div>
<div class="num"> 623 </div>
<div class="num"> 624 </div>
<div class="num"> 625 </div>
<div class="num"> 626 </div>
<div class="num"> 627 </div>
<div class="num"> 628 </div>
<div class="num"> 629 </div>
<div class="num"> 630 </div>
<div class="num"> 631 </div>
<div class="num"> 632 </div>
<div class="num"> 633 </div>
<div class="num"> 634 </div>
<div class="num"> 635 </div>
<div class="num"> 636 </div>
<div class="num"> 637 </div>
<div class="num"> 638 </div>
<div class="num"> 639 </div>
<div class="num"> 640 </div>
<div class="num"> 641 </div>
<div class="num"> 642 </div>
<div class="num"> 643 </div>
<div class="num"> 644 </div>
<div class="num"> 645 </div>
<div class="num"> 646 </div>
<div class="num"> 647 </div>
<div class="num"> 648 </div>
<div class="num"> 649 </div>
<div class="num"> 650 </div>
<div class="num"> 651 </div>
<div class="num"> 652 </div>
<div class="num"> 653 </div>
<div class="num"> 654 </div>
<div class="num"> 655 </div>
<div class="num"> 656 </div>
<div class="num"> 657 </div>
<div class="num"> 658 </div>
<div class="num"> 659 </div>
<div class="num"> 660 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 661 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 662 </div>
<div class="num"> 663 </div>
<div class="num"> 664 </div>
<div class="num"> 665 </div>
<div class="num"> 666 </div>
<div class="num"> 667 </div>
<div class="num"> 668 </div>
<div class="num"> 669 </div>
<div class="num"> 670 </div>
<div class="num"> 671 </div>
<div class="num"> 672 </div>
<div class="num"> 673 </div>
<div class="num"> 674 </div>
<div class="num"> 675 </div>
<div class="num"> 676 </div>
<div class="num"> 677 </div>
<div class="num"> 678 </div>
<div class="num"> 679 </div>
<div class="num"> 680 </div>
<div class="num"> 681 </div>
<div class="num"> 682 </div>
<div class="num"> 683 </div>
<div class="num"> 684 </div>
<div class="num"> 685 </div>
<div class="num"> 686 </div>
<div class="num"> 687 </div>
<div class="num"> 688 </div>
<div class="num"> 689 </div>
<div class="num"> 690 </div>
<div class="num"> 691 </div>
<div class="num"> 692 </div>
<div class="num"> 693 </div>
<div class="num"> 694 </div>
<div class="num"> 695 </div>
<div class="num"> 696 </div>
<div class="num"> 697 </div>
<div class="num"> 698 </div>
<div class="num"> 699 </div>
<div class="num"> 700 </div>
<div class="num"> 701 </div>
<div class="num"> 702 </div>
<div class="num"> 703 </div>
<div class="num"> 704 </div>
<div class="num"> 705 </div>
<div class="num"> 706 </div>
<div class="num"> 707 </div>
<div class="num"> 708 </div>
<div class="num"> 709 </div>
<div class="num"> 710 </div>
<div class="num"> 711 </div>
<div class="num"> 712 </div>
<div class="num"> 713 </div>
<div class="num"> 714 </div>
<div class="num"> 715 </div>
<div class="num"> 716 </div>
<div class="num"> 717 </div>
<div class="num"> 718 </div>
<div class="num"> 719 </div>
<div class="num"> 720 </div>
<div class="num"> 721 </div>
<div class="num"> 722 </div>
<div class="num"> 723 </div>
<div class="num"> 724 </div>
<div class="num"> 725 </div>
<div class="num"> 726 </div>
<div class="num"> 727 </div>
<div class="num"> 728 </div>
<div class="num"> 729 </div>
<div class="num"> 730 </div>
<div class="num"> 731 </div>
<div class="num"> 732 </div>
<div class="num"> 733 </div>
<div class="num"> 734 </div>
<div class="num"> 735 </div>
<div class="num"> 736 </div>
<div class="num"> 737 </div>
<div class="num"> 738 </div>
<div class="num"> 739 </div>
<div class="num"> 740 </div>
<div class="num"> 741 </div>
<div class="num"> 742 </div>
<div class="num"> 743 </div>
<div class="num"> 744 </div>
<div class="num"> 745 </div>
<div class="num"> 746 </div>
<div class="num"> 747 </div>
<div class="num"> 748 </div>
<div class="num"> 749 </div>
<div class="num"> 750 </div>
<div class="num"> 751 </div>
<div class="num"> 752 </div>
<div class="num">     </div>
<div class="num"> 753 </div>
<div class="num"> 754 </div>
<div class="num"> 755 </div>
<div class="num"> 756 </div>
<div class="num"> 757 </div>
<div class="num"> 758 </div>
<div class="num"> 759 </div>
<div class="num"> 760 </div>
<div class="num"> 761 </div>
<div class="num"> 762 </div>
<div class="num"> 763 </div>
<div class="num"> 764 </div>
<div class="num"> 765 </div>
<div class="num"> 766 </div>
<div class="num"> 767 </div>
<div class="num"> 768 </div>
<div class="num"> 769 </div>
<div class="num"> 770 </div>
<div class="num"> 771 </div>
<div class="num"> 772 </div>
<div class="num"> 773 </div>
<div class="num"> 774 </div>
<div class="num"> 775 </div>
<div class="num"> 776 </div>
<div class="num"> 777 </div>
<div class="num"> 778 </div>
<div class="num"> 779 </div>
<div class="num"> 780 </div>
<div class="num"> 781 </div>
<div class="num"> 782 </div>
<div class="num"> 783 </div>
<div class="num"> 784 </div>
<div class="num"> 785 </div>
<div class="num"> 786 </div>
<div class="num"> 787 </div>
<div class="num"> 788 </div>
<div class="num"> 789 </div>
<div class="num"> 790 </div>
<div class="num"> 791 </div>
<div class="num"> 792 </div>
<div class="num"> 793 </div>
<div class="num"> 794 </div>
<div class="num"> 795 </div>
<div class="num"> 796 </div>
<div class="num"> 797 </div>
<div class="num"> 798 </div>
<div class="num"> 799 </div>
<div class="num"> 800 </div>
<div class="num"> 801 </div>
<div class="num"> 802 </div>
<div class="num"> 803 </div>
<div class="num"> 804 </div>
<div class="num"> 805 </div>
<div class="num"> 806 </div>
<div class="num"> 807 </div>
<div class="num"> 808 </div>
<div class="num"> 809 </div>
<div class="num"> 810 </div>
<div class="num"> 811 </div>
<div class="num"> 812 </div>
<div class="num"> 813 </div>
<div class="num"> 814 </div>
<div class="num"> 815 </div>
<div class="num"> 816 </div>
<div class="num"> 817 </div>
<div class="num"> 818 </div>
<div class="num"> 819 </div>
<div class="num"> 820 </div>
<div class="num"> 821 </div>
<div class="num"> 822 </div>
<div class="num"> 823 </div>
<div class="num"> 824 </div>
<div class="num"> 825 </div>
<div class="num"> 826 </div>
<div class="num"> 827 </div>
<div class="num"> 828 </div>
<div class="num"> 829 </div>
<div class="num"> 830 </div>
<div class="num"> 831 </div>
<div class="num"> 832 </div>
<div class="num"> 833 </div>
<div class="num"> 834 </div>
<div class="num"> 835 </div>
<div class="num"> 836 </div>
<div class="num"> 837 </div>
<div class="num"> 838 </div>
<div class="num"> 839 </div>
<div class="num"> 840 </div>
<div class="num"> 841 </div>
<div class="num"> 842 </div>
<div class="num"> 843 </div>
<div class="num"> 844 </div>
<div class="num"> 845 </div>
<div class="num"> 846 </div>
<div class="num"> 847 </div>
<div class="num"> 848 </div>
<div class="num"> 849 </div>
<div class="num"> 850 </div>
<div class="num"> 851 </div>
<div class="num"> 852 </div>
<div class="num"> 853 </div>
<div class="num"> 854 </div>
<div class="num"> 855 </div>
<div class="num"> 856 </div>
<div class="num"> 857 </div>
<div class="num"> 858 </div>
<div class="num"> 859 </div>
<div class="num"> 860 </div>
<div class="num"> 861 </div>
<div class="num"> 862 </div>
<div class="num"> 863 </div>
<div class="num"> 864 </div>
<div class="num"> 865 </div>
<div class="num"> 866 </div>
<div class="num"> 867 </div>
<div class="num"> 868 </div>
<div class="num"> 869 </div>
<div class="num"> 870 </div>
<div class="num"> 871 </div>
<div class="num"> 872 </div>
<div class="num"> 873 </div>
<div class="num"> 874 </div>
<div class="num"> 875 </div>
<div class="num"> 876 </div>
<div class="num">     </div>
<div class="num"> 877 </div>
<div class="num"> 878 </div>
<div class="num"> 879 </div>
<div class="num"> 880 </div>
<div class="num"> 881 </div>
<div class="num"> 882 </div>
<div class="num"> 883 </div>
<div class="num"> 884 </div>
<div class="num"> 885 </div>
<div class="num"> 886 </div>
<div class="num"> 887 </div>
<div class="num"> 888 </div>
<div class="num"> 889 </div>
<div class="num"> 890 </div>
<div class="num"> 891 </div>
<div class="num"> 892 </div>
<div class="num"> 893 </div>
<div class="num"> 894 </div>
<div class="num"> 895 </div>
<div class="num"> 896 </div>
<div class="num"> 897 </div>
<div class="num"> 898 </div>
<div class="num"> 899 </div>
<div class="num"> 900 </div>
<div class="num"> 901 </div>
<div class="num"> 902 </div>
<div class="num"> 903 </div>
<div class="num"> 904 </div>
<div class="num"> 905 </div>
<div class="num"> 906 </div>
<div class="num"> 907 </div>
<div class="num"> 908 </div>
<div class="num"> 909 </div>
<div class="num"> 910 </div>
<div class="num"> 911 </div>
<div class="num"> 912 </div>
<div class="num"> 913 </div>
<div class="num"> 914 </div>
<div class="num"> 915 </div>
<div class="num"> 916 </div>
<div class="num"> 917 </div>
<div class="num"> 918 </div>
<div class="num"> 919 </div>
<div class="num"> 920 </div>
<div class="num"> 921 </div>
<div class="num"> 922 </div>
<div class="num"> 923 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 924 </div>
<div class="num"> 925 </div>
<div class="num"> 926 </div>
<div class="num"> 927 </div>
<div class="num"> 928 </div>
<div class="num"> 929 </div>
<div class="num"> 930 </div>
<div class="num"> 931 </div>
<div class="num"> 932 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 933 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 934 </div>
<div class="num"> 935 </div>
<div class="num"> 936 </div>
<div class="num"> 937 </div>
<div class="num"> 938 </div>
<div class="num"> 939 </div>
<div class="num"> 940 </div>
<div class="num"> 941 </div>
<div class="num"> 942 </div>
<div class="num"> 943 </div>
<div class="num"> 944 </div>
<div class="num"> 945 </div>
<div class="num"> 946 </div>
<div class="num"> 947 </div>
<div class="num"> 948 </div>
<div class="num"> 949 </div>
<div class="num"> 950 </div>
<div class="num"> 951 </div>
<div class="num"> 952 </div>
<div class="num"> 953 </div>
<div class="num"> 954 </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num">     </div>
<div class="num"> 955 </div>
<div class="num"> 956 </div>
<div class="num"> 957 </div>
<div class="num"> 958 </div>
<div class="num"> 959 </div>
<div class="num"> 960 </div>
<div class="num"> 961 </div>
<div class="num"> 962 </div>
<div class="num"> 963 </div>
<div class="num"> 964 </div>
<div class="num"> 965 </div>
<div class="num"> 966 </div>
<div class="num"> 967 </div>
<div class="num"> 968 </div>
<div class="num"> 969 </div>
<div class="num"> 970 </div>
<div class="num"> 971 </div>
<div class="num"> 972 </div>
<div class="num"> 973 </div>
<div class="num"> 974 </div>
<div class="num"> 975 </div>
<div class="num"> 976 </div>
<div class="num"> 977 </div>
<div class="num"> 978 </div>
<div class="num"> 979 </div>
<div class="num"> 980 </div>
<div class="num"> 981 </div>
<div class="num"> 982 </div>
<div class="num"> 983 </div>
<div class="num"> 984 </div>
<div class="num"> 985 </div>
<div class="num"> 986 </div>
<div class="num"> 987 </div>
<div class="num"> 988 </div>
<div class="num"> 989 </div>
<div class="num"> 990 </div>
<div class="num"> 991 </div>
<div class="num"> 992 </div>
<div class="num"> 993 </div>
<div class="num"> 994 </div>
<div class="num"> 995 </div>
<div class="num"> 996 </div>
<div class="num"> 997 </div>
<div class="num"> 998 </div>
<div class="num"> 999 </div>
<div class="num">1000 </div>
<div class="num">1001 </div>
<div class="num">1002 </div>
<div class="num">1003 </div>
<div class="num">1004 </div>
<div class="num">1005 </div>
<div class="num">1006 </div>
<div class="num">1007 </div>
<div class="num">1008 </div>
<div class="num">1009 </div>
<div class="num">1010 </div>
<div class="num">1011 </div>
<div class="num">1012 </div>
<div class="num">1013 </div>
<div class="num">1014 </div>
<div class="num">1015 </div>
<div class="num">1016 </div>
<div class="num">1017 </div>
<div class="num">1018 </div>
<div class="num">1019 </div>
<div class="num">1020 </div>
<div class="num">1021 </div>
<div class="num">1022 </div>
<div class="num">1023 </div>
<div class="num">1024 </div>
<div class="num">1025 </div>
<div class="num">1026 </div>
<div class="num">1027 </div>
<div class="num">1028 </div>
<div class="num">1029 </div>
<div class="num">1030 </div>
<div class="num">1031 </div>
<div class="num">1032 </div>
<div class="num">1033 </div>
<div class="num">1034 </div>
<div class="num">1035 </div>
<div class="num">1036 </div>
<div class="num">1037 </div>
<div class="num">1038 </div>
<div class="num">1039 </div>
<div class="num">1040 </div>
<div class="num">1041 </div>
<div class="num">1042 </div>
<div class="num">1043 </div>
<div class="num">1044 </div>
<div class="num">1045 </div>
<div class="num">1046 </div>
<div class="num">1047 </div>
<div class="num">1048 </div>
<div class="num">1049 </div>
<div class="num">1050 </div>
<div class="num">1051 </div>
<div class="num">1052 </div>
<div class="num">1053 </div>
<div class="num">1054 </div>
<div class="num">1055 </div>
<div class="num">1056 </div>
<div class="num">1057 </div>
<div class="num">1058 </div>
<div class="num">1059 </div>
<div class="num">1060 </div>
<div class="num">1061 </div>
<div class="num">1062 </div>
<div class="num">1063 </div>
<div class="num">1064 </div>
<div class="num">1065 </div>
<div class="num">1066 </div>
<div class="num">1067 </div>
<div class="num">1068 </div>

                            </td>
                            <td class="content">
                                <div class="l lc d1"><span class="sc">// Copyright </span><span class="sc2">(c) 2018 Tomochain</span></div>
<div class="l lc d1"> </div>
<div class="l li"><span class="si">//</span></div>
<div class="l lc d2"><span class="sc">// </span><span class="sc2">This program</span><span class="sc"> is free software: you can redistribute it and/or modify</span></div>
<div class="l li"><span class="si">// it under the terms of the GNU Lesser General Public License as published by</span></div>
<div class="l li"><span class="si">// the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="l li"><span class="si">// (at your option) any later version.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l lc d3"><span class="sc">// </span><span class="sc2">This program</span><span class="sc"> is distributed in the hope that it will be useful,</span></div>
<div class="l li"><span class="si">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="l li"><span class="si">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span></div>
<div class="l li"><span class="si">// GNU Lesser General Public License for more details.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l li"><span class="si">// You should have received a copy of the GNU Lesser General Public License</span></div>
<div class="l lc d4"><span class="sc">// along with </span><span class="sc2">this program</span><span class="sc">. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="l lg d4"> </div>
<div class="l lc d4"><span class="sc">// Package </span><span class="sc2">posv</span><span class="sc"> implements the proof-of-</span><span class="sc2">stake-voting</span><span class="sc"> consensus engine.</span></div>
<div class="l lc d4"><span class="sc">package </span><span class="sc2">posv</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">import (</span></div>
<div class="l li"><span class="si">    &quot;bytes&quot;</span></div>
<div class="l li"><span class="si">    &quot;errors&quot;</span></div>
<div class="l ld d5"><span class="sd">    &quot;fmt&quot;</span></div>
<div class="l li"><span class="si">    &quot;math/big&quot;</span></div>
<div class="l li"><span class="si">    &quot;math/rand&quot;</span></div>
<div class="l ld d6"><span class="sd">    &quot;strconv&quot;</span></div>
<div class="l li"><span class="si">    &quot;sync&quot;</span></div>
<div class="l li"><span class="si">    &quot;time&quot;</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/accounts&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/common&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/common/hexutil&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/consensus&quot;</span></div>
<div class="l ld d7"><span class="sd">    &quot;github.com/ethereum/go-ethereum/consensus/clique&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/consensus/misc&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/core/state&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/core/types&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/crypto&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/crypto/sha3&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/ethdb&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/log&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/params&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/rlp&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/rpc&quot;</span></div>
<div class="l lc d8"><span class="sc">    &quot;github.com/hashicorp/golang-lru&quot;</span></div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">const (</span></div>
<div class="l la d9"> </div>
<div class="l li"><span class="si">    inmemorySnapshots  = 128                    // Number of recent vote snapshots to keep in memory</span></div>
<div class="l li"><span class="si">    inmemorySignatures = 4096                   // Number of recent block signatures to keep in memory</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    wiggleTime         = 500 * time.Millisecond // Random delay (per signer) to allow concurrent signers</span></div>
<div class="l ld d10"><span class="sd">    M2ByteLength       = 4</span></div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l lc d11"><span class="sd">type Masternode struct {</span></div>
<div class="l lc d11"><span class="sc">    </span><span class="sd">Address common.Address</span></div>
<div class="l lc d11"><span class="sc">    </span><span class="sd">Stake   *big.Int</span></div>
<div class="l lc d11"><span class="sd">}</span></div>
<div class="l lg d11"> </div>
<div class="l lc d11"><span class="sc">// </span><span class="sc2">Posv</span><span class="sc"> proof-of-</span><span class="sc2">stake-voting</span><span class="sc"> protocol constants.</span></div>
<div class="l li"><span class="si">var (</span></div>
<div class="l li"><span class="si">    epochLength = uint64(30000) // Default number of blocks after which to checkpoint and reset the pending votes</span></div>
<div class="l ld d12"><span class="sd">    blockPeriod = uint64(15)    // Default minimum difference between two consecutive block's timestamps</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    extraVanity = 32 // Fixed number of extra-data prefix bytes reserved for signer vanity</span></div>
<div class="l li"><span class="si">    extraSeal   = 65 // Fixed number of extra-data suffix bytes reserved for signer seal</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    nonceAuthVote = hexutil.MustDecode(&quot;0xffffffffffffffff&quot;) // Magic nonce number to vote on adding a new signer</span></div>
<div class="l li"><span class="si">    nonceDropVote = hexutil.MustDecode(&quot;0x0000000000000000&quot;) // Magic nonce number to vote on removing a signer.</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    uncleHash = types.CalcUncleHash(nil) // Always Keccak256(RLP([])) as uncles are meaningless outside of PoW.</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    diffInTurn = big.NewInt(2) // Block difficulty for in-turn signatures</span></div>
<div class="l li"><span class="si">    diffNoTurn = big.NewInt(1) // Block difficulty for out-of-turn signatures</span></div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Various error messages to mark blocks invalid. These should be private to</span></div>
<div class="l li"><span class="si">// prevent engine specific errors from being referenced in the remainder of the</span></div>
<div class="l li"><span class="si">// codebase, inherently breaking if the engine is swapped out. Please put common</span></div>
<div class="l li"><span class="si">// error types into the consensus package.</span></div>
<div class="l li"><span class="si">var (</span></div>
<div class="l li"><span class="si">    // errUnknownBlock is returned when the list of signers is requested for a block</span></div>
<div class="l li"><span class="si">    // that is not part of the local blockchain.</span></div>
<div class="l li"><span class="si">    errUnknownBlock = errors.New(&quot;unknown block&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidCheckpointBeneficiary is returned if a checkpoint/epoch transition</span></div>
<div class="l li"><span class="si">    // block has a beneficiary set to non-zeroes.</span></div>
<div class="l li"><span class="si">    errInvalidCheckpointBeneficiary = errors.New(&quot;beneficiary in checkpoint block non-zero&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidVote is returned if a nonce value is something else that the two</span></div>
<div class="l li"><span class="si">    // allowed constants of 0x00..0 or 0xff..f.</span></div>
<div class="l li"><span class="si">    errInvalidVote = errors.New(&quot;vote nonce not 0x00..0 or 0xff..f&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidCheckpointVote is returned if a checkpoint/epoch transition block</span></div>
<div class="l li"><span class="si">    // has a vote nonce set to non-zeroes.</span></div>
<div class="l li"><span class="si">    errInvalidCheckpointVote = errors.New(&quot;vote nonce in checkpoint block non-zero&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errMissingVanity is returned if a block's extra-data section is shorter than</span></div>
<div class="l li"><span class="si">    // 32 bytes, which is required to store the signer vanity.</span></div>
<div class="l li"><span class="si">    errMissingVanity = errors.New(&quot;extra-data 32 byte vanity prefix missing&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errMissingSignature is returned if a block's extra-data section doesn't seem</span></div>
<div class="l li"><span class="si">    // to contain a 65 byte secp256k1 signature.</span></div>
<div class="l lc d13"><span class="sc">    errMissingSignature = errors.New(&quot;extra-data 65 byte </span><span class="sd">suffix</span><span class="sc"> signature missing&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errExtraSigners is returned if non-checkpoint block contain signer data in</span></div>
<div class="l li"><span class="si">    // their extra-data fields.</span></div>
<div class="l li"><span class="si">    errExtraSigners = errors.New(&quot;non-checkpoint block contains extra signer list&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidCheckpointSigners is returned if a checkpoint block contains an</span></div>
<div class="l lc d14"><span class="sc">    // invalid list of signers (i.e. non divisible by 20 bytes</span><span class="sc2">, or not the correct</span></div>
<div class="l lc d14"><span class="sc">    </span><span class="sd">// ones).</span></div>
<div class="l li"><span class="si">    errInvalidCheckpointSigners = errors.New(&quot;invalid signer list on checkpoint block&quot;)</span></div>
<div class="l li"> </div>
<div class="l lc d15"> </div>
<div class="l lc d15"> </div>
<div class="l lc d15"><span class="sc">    </span><span class="sc2">errInvalidCheckpointPenalties</span><span class="sc"> = errors.New(&quot;</span><span class="sc2">invalid penalty</span><span class="sc"> list on checkpoint block&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidMixDigest is returned if a block's mix digest is non-zero.</span></div>
<div class="l li"><span class="si">    errInvalidMixDigest = errors.New(&quot;non-zero mix digest&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidUncleHash is returned if a block contains an non-empty uncle list.</span></div>
<div class="l li"><span class="si">    errInvalidUncleHash = errors.New(&quot;non empty uncle hash&quot;)</span></div>
<div class="l li"> </div>
<div class="l lc d16"><span class="sc">    // errInvalidDifficulty is returned if the difficulty of a block </span><span class="sd">is not</span><span class="sc"> </span><span class="sc2">either</span></div>
<div class="l lc d16"><span class="sc">    </span><span class="sd">// of 1 or 2, or if the value does not match the turn of the signer.</span></div>
<div class="l li"><span class="si">    errInvalidDifficulty = errors.New(&quot;invalid difficulty&quot;)</span></div>
<div class="l li"> </div>
<div class="l la d17"> </div>
<div class="l la d17"> </div>
<div class="l la d17"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // ErrInvalidTimestamp is returned if the timestamp of a block is lower than</span></div>
<div class="l li"><span class="si">    // the previous block's timestamp + the minimum block period.</span></div>
<div class="l li"><span class="si">    ErrInvalidTimestamp = errors.New(&quot;invalid timestamp&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidVotingChain is returned if an authorization list is attempted to</span></div>
<div class="l li"><span class="si">    // be modified via out-of-range or non-contiguous headers.</span></div>
<div class="l li"><span class="si">    errInvalidVotingChain = errors.New(&quot;invalid voting chain&quot;)</span></div>
<div class="l li"> </div>
<div class="l lc d18"><span class="sc">    // </span><span class="sc2">errUnauthorized</span><span class="sc"> is returned if a header is signed by a non-authorized entity.</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sc2">errUnauthorized</span><span class="sc"> = errors.New(&quot;unauthorized&quot;)</span></div>
<div class="l lg d18"> </div>
<div class="l lc d18"><span class="sc">    </span><span class="sc2">errFailedDoubleValidation = errors.New(&quot;wrong pair of creator-validator in double validation&quot;)</span></div>
<div class="l lg d18"> </div>
<div class="l lc d18"><span class="sc">    </span><span class="sc2">// errWaitTransactions is returned if an empty block is attempted to be sealed</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sd">// on an instant chain (0 second period). It's important to refuse these as the</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sd">// block reward is zero, so an empty block just bloats the chain... fast.</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sd">errWaitTransactions = errors.New(&quot;waiting for transactions&quot;)</span></div>
<div class="l lg d18"> </div>
<div class="l lc d18"><span class="sc">    </span><span class="sd">ErrInvalidCheckpointValidators = errors.New(&quot;invalid validators list on checkpoint block&quot;)</span></div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// SignerFn is a signer callback function to request a hash to be signed by a</span></div>
<div class="l li"><span class="si">// backing account.</span></div>
<div class="l lc d19"><span class="sd">//</span><span class="sc">type SignerFn func(accounts.Account, []byte) ([]byte, error)</span></div>
<div class="l lg d19"> </div>
<div class="l lc d19"><span class="sc">// sigHash returns the hash which is used as input for the proof-of-</span><span class="sc2">stake-voting</span></div>
<div class="l li"><span class="si">// signing. It is the hash of the entire header apart from the 65 byte signature</span></div>
<div class="l li"><span class="si">// contained at the end of the extra data.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l li"><span class="si">// Note, the method requires the extra data to be at least 65 bytes, otherwise it</span></div>
<div class="l li"><span class="si">// panics. This is done to avoid accidentally using both forms (signature present</span></div>
<div class="l li"><span class="si">// or not), which could be abused to produce different hashes for the same header.</span></div>
<div class="l li"><span class="si">func sigHash(header *types.Header) (hash common.Hash) {</span></div>
<div class="l li"><span class="si">    hasher := sha3.NewKeccak256()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    rlp.Encode(hasher, []interface{}{</span></div>
<div class="l li"><span class="si">        header.ParentHash,</span></div>
<div class="l li"><span class="si">        header.UncleHash,</span></div>
<div class="l li"><span class="si">        header.Coinbase,</span></div>
<div class="l li"><span class="si">        header.Root,</span></div>
<div class="l li"><span class="si">        header.TxHash,</span></div>
<div class="l li"><span class="si">        header.ReceiptHash,</span></div>
<div class="l li"><span class="si">        header.Bloom,</span></div>
<div class="l li"><span class="si">        header.Difficulty,</span></div>
<div class="l li"><span class="si">        header.Number,</span></div>
<div class="l li"><span class="si">        header.GasLimit,</span></div>
<div class="l li"><span class="si">        header.GasUsed,</span></div>
<div class="l li"><span class="si">        header.Time,</span></div>
<div class="l li"><span class="si">        header.Extra[:len(header.Extra)-65], // Yes, this will panic if extra is too short</span></div>
<div class="l li"><span class="si">        header.MixDigest,</span></div>
<div class="l li"><span class="si">        header.Nonce,</span></div>
<div class="l li"><span class="si">    })</span></div>
<div class="l li"><span class="si">    hasher.Sum(hash[:0])</span></div>
<div class="l li"><span class="si">    return hash</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l lg"> </div>
<div class="l ld d20"><span class="sd">func SigHash(header *types.Header) (hash common.Hash) {</span></div>
<div class="l ld d20"><span class="sd">    return sigHash(header)</span></div>
<div class="l ld d20"><span class="sd">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// ecrecover extracts the Ethereum account address from a signed header.</span></div>
<div class="l li"><span class="si">func ecrecover(header *types.Header, sigcache *lru.ARCCache) (common.Address, error) {</span></div>
<div class="l li"><span class="si">    // If the signature's already cached, return that</span></div>
<div class="l li"><span class="si">    hash := header.Hash()</span></div>
<div class="l li"><span class="si">    if address, known := sigcache.Get(hash); known {</span></div>
<div class="l li"><span class="si">        return address.(common.Address), nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Retrieve the signature from the header extra-data</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraSeal {</span></div>
<div class="l li"><span class="si">        return common.Address{}, errMissingSignature</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    signature := header.Extra[len(header.Extra)-extraSeal:]</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Recover the public key and the Ethereum address</span></div>
<div class="l li"><span class="si">    pubkey, err := crypto.Ecrecover(sigHash(header).Bytes(), signature)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return common.Address{}, err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    var signer common.Address</span></div>
<div class="l li"><span class="si">    copy(signer[:], crypto.Keccak256(pubkey[1:])[12:])</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    sigcache.Add(hash, signer)</span></div>
<div class="l li"><span class="si">    return signer, nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l lc d21"><span class="sc">// </span><span class="sc2">Posv</span><span class="sc"> is the proof-of-</span><span class="sc2">stake-voting</span><span class="sc"> consensus engine proposed to support the</span></div>
<div class="l li"><span class="si">// Ethereum testnet following the Ropsten attacks.</span></div>
<div class="l lc d22"><span class="sc">type </span><span class="sc2">Posv</span><span class="sc"> struct {</span></div>
<div class="l lc d22"><span class="sc">    config *params.</span><span class="sc2">PosvConfig</span><span class="sc"> // Consensus engine configuration parameters</span></div>
<div class="l li"><span class="si">    db     ethdb.Database     // Database to store and retrieve snapshot checkpoints</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    recents             *lru.ARCCache // Snapshots for recent block to speed up reorgs</span></div>
<div class="l li"><span class="si">    signatures          *lru.ARCCache // Signatures of recent blocks to speed up mining</span></div>
<div class="l ld d23"><span class="sd">    validatorSignatures *lru.ARCCache // Signatures of recent blocks to speed up mining</span></div>
<div class="l ld d23"><span class="sd">    verifiedHeaders     *lru.ARCCache</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    proposals           map[common.Address]bool // Current list of proposals we are pushing</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    signer common.Address  // Ethereum address of the signing key</span></div>
<div class="l lc d24"><span class="sc">    signFn </span><span class="sd">clique.</span><span class="sc">SignerFn // Signer function to authorize hashes with</span></div>
<div class="l li"><span class="si">    lock   sync.RWMutex    // Protects the signer fields</span></div>
<div class="l li"> </div>
<div class="l lc d25"><span class="sc">    </span><span class="sc2">HookReward    func(chain consensus.ChainReader, state *state.StateDB, header *types.Header) error</span></div>
<div class="l lc d25"><span class="sc">    </span><span class="sc2">HookPenalty   func(chain consensus.ChainReader, blockNumberEpoc uint64) ([]common.Address, error)</span></div>
<div class="l lc d25"><span class="sc">    </span><span class="sd">HookValidator func(header *types.Header, signers []common.Address) error</span></div>
<div class="l lc d25"><span class="sc">    </span><span class="sd">HookVerifyMNs func(header *types.Header, signers []common.Address) error</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l lc d26"><span class="sc">// New creates a </span><span class="sc2">Posv</span><span class="sc"> proof-of-</span><span class="sc2">stake-voting</span><span class="sc"> consensus engine with the initial</span></div>
<div class="l li"><span class="si">// signers set to the ones provided by the user.</span></div>
<div class="l lc d27"><span class="sc">func New(config *params.</span><span class="sc2">PosvConfig</span><span class="sc">, db ethdb.Database) *</span><span class="sc2">Posv</span><span class="sc"> {</span></div>
<div class="l li"><span class="si">    // Set any missing consensus parameters to their defaults</span></div>
<div class="l li"><span class="si">    conf := *config</span></div>
<div class="l li"><span class="si">    if conf.Epoch == 0 {</span></div>
<div class="l li"><span class="si">        conf.Epoch = epochLength</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Allocate the snapshot caches and create the engine</span></div>
<div class="l li"><span class="si">    recents, _ := lru.NewARC(inmemorySnapshots)</span></div>
<div class="l lc d28"><span class="sc">    signatures, _ := lru.NewARC(</span><span class="sc2">inmemorySnapshots</span><span class="sc">)</span></div>
<div class="l lc d28"><span class="sc">    </span><span class="sd">validatorSignatures, _ := lru.NewARC(inmemorySnapshots)</span></div>
<div class="l lc d28"><span class="sc">    </span><span class="sc2">verifiedHeaders, _ := lru.NewARC(inmemorySnapshots)</span></div>
<div class="l lc d28"><span class="sc">    </span><span class="sd">return &amp;Posv{</span></div>
<div class="l li"><span class="si">        config:              &amp;conf,</span></div>
<div class="l li"><span class="si">        db:                  db,</span></div>
<div class="l li"><span class="si">        recents:             recents,</span></div>
<div class="l li"><span class="si">        signatures:          signatures,</span></div>
<div class="l ld d29"><span class="sd">        verifiedHeaders:     verifiedHeaders,</span></div>
<div class="l ld d29"><span class="sd">        validatorSignatures: validatorSignatures,</span></div>
<div class="l li"><span class="si">        proposals:           make(map[common.Address]bool),</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Author implements consensus.Engine, returning the Ethereum address recovered</span></div>
<div class="l li"><span class="si">// from the signature in the header's extra-data section.</span></div>
<div class="l lc d30"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) Author(header *types.Header) (common.Address, error) {</span></div>
<div class="l li"><span class="si">    return ecrecover(header, c.signatures)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifyHeader checks whether a header conforms to the consensus rules.</span></div>
<div class="l lc d31"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) VerifyHeader(chain consensus.ChainReader, header *types.Header, seal bool) error {</span></div>
<div class="l lc d31"><span class="sc">    return c.</span><span class="sc2">verifyHeaderWithCache</span><span class="sc">(chain, header, nil)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifyHeaders is similar to VerifyHeader, but verifies a batch of headers. The</span></div>
<div class="l li"><span class="si">// method returns a quit channel to abort the operations and a results channel to</span></div>
<div class="l li"><span class="si">// retrieve the async verifications (the order is that of the input slice).</span></div>
<div class="l lc d32"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) VerifyHeaders(chain consensus.ChainReader, headers []*types.Header, seals []bool) (chan&lt;- struct{}, &lt;-chan error) {</span></div>
<div class="l li"><span class="si">    abort := make(chan struct{})</span></div>
<div class="l li"><span class="si">    results := make(chan error, len(headers))</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    go func() {</span></div>
<div class="l li"><span class="si">        for i, header := range headers {</span></div>
<div class="l lc d33"><span class="sc">            err := c.</span><span class="sc2">verifyHeaderWithCache</span><span class="sc">(chain, header, headers[:i])</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">            select {</span></div>
<div class="l li"><span class="si">            case &lt;-abort:</span></div>
<div class="l li"><span class="si">                return</span></div>
<div class="l li"><span class="si">            case results &lt;- err:</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }()</span></div>
<div class="l li"><span class="si">    return abort, results</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l lg"> </div>
<div class="l ld d34"><span class="sd">func (c *Posv) verifyHeaderWithCache(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l ld d34"><span class="sd">    _, check := c.verifiedHeaders.Get(header.Hash())</span></div>
<div class="l ld d34"><span class="sd">    if check {</span></div>
<div class="l ld d34"><span class="sd">        return nil</span></div>
<div class="l ld d34"><span class="sd">    }</span></div>
<div class="l ld d34"><span class="sd">    err := c.verifyHeader(chain, header, parents)</span></div>
<div class="l ld d34"><span class="sd">    if err == nil {</span></div>
<div class="l ld d34"><span class="sd">        c.verifiedHeaders.Add(header.Hash(), true)</span></div>
<div class="l ld d34"><span class="sd">    }</span></div>
<div class="l ld d34"><span class="sd">    return err</span></div>
<div class="l ld d34"><span class="sd">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// verifyHeader checks whether a header conforms to the consensus rules.The</span></div>
<div class="l li"><span class="si">// caller may optionally pass in a batch of parents (ascending order) to avoid</span></div>
<div class="l li"><span class="si">// looking those up from the database. This is useful for concurrently verifying</span></div>
<div class="l li"><span class="si">// a batch of new headers.</span></div>
<div class="l lc d35"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) verifyHeader(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l li"><span class="si">    if header.Number == nil {</span></div>
<div class="l li"><span class="si">        return errUnknownBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Don't waste time checking blocks from the future</span></div>
<div class="l li"><span class="si">    if header.Time.Cmp(big.NewInt(time.Now().Unix())) &gt; 0 {</span></div>
<div class="l li"><span class="si">        return consensus.ErrFutureBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Checkpoint blocks need to enforce zero beneficiary</span></div>
<div class="l li"><span class="si">    checkpoint := (number % c.config.Epoch) == 0</span></div>
<div class="l li"><span class="si">    if checkpoint &amp;&amp; header.Coinbase != (common.Address{}) {</span></div>
<div class="l li"><span class="si">        return errInvalidCheckpointBeneficiary</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l lg"> </div>
<div class="l li"><span class="si">    // Nonces must be 0x00..0 or 0xff..f, zeroes enforced on checkpoints</span></div>
<div class="l li"><span class="si">    if !bytes.Equal(header.Nonce[:], nonceAuthVote) &amp;&amp; !bytes.Equal(header.Nonce[:], nonceDropVote) {</span></div>
<div class="l li"><span class="si">        return errInvalidVote</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if checkpoint &amp;&amp; !bytes.Equal(header.Nonce[:], nonceDropVote) {</span></div>
<div class="l li"><span class="si">        return errInvalidCheckpointVote</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Check that the extra-data contains both the vanity and signature</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraVanity {</span></div>
<div class="l li"><span class="si">        return errMissingVanity</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraVanity+extraSeal {</span></div>
<div class="l li"><span class="si">        return errMissingSignature</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the extra-data contains a signer list on checkpoint, but none otherwise</span></div>
<div class="l li"><span class="si">    signersBytes := len(header.Extra) - extraVanity - extraSeal</span></div>
<div class="l li"><span class="si">    if !checkpoint &amp;&amp; signersBytes != 0 {</span></div>
<div class="l li"><span class="si">        return errExtraSigners</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if checkpoint &amp;&amp; signersBytes%common.AddressLength != 0 {</span></div>
<div class="l li"><span class="si">        return errInvalidCheckpointSigners</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the mix digest is zero as we don't have fork protection currently</span></div>
<div class="l li"><span class="si">    if header.MixDigest != (common.Hash{}) {</span></div>
<div class="l li"><span class="si">        return errInvalidMixDigest</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the block doesn't contain any uncles which are meaningless in PoA</span></div>
<div class="l li"><span class="si">    if header.UncleHash != uncleHash {</span></div>
<div class="l li"><span class="si">        return errInvalidUncleHash</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the block's difficulty is meaningful (may not be correct at this point)</span></div>
<div class="l li"><span class="si">    if number &gt; 0 {</span></div>
<div class="l li"><span class="si">        if header.Difficulty == nil || (header.Difficulty.Cmp(diffInTurn) != 0 &amp;&amp; header.Difficulty.Cmp(diffNoTurn) != 0) {</span></div>
<div class="l li"><span class="si">            return errInvalidDifficulty</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // If all checks passed, validate any special fields for hard forks</span></div>
<div class="l li"><span class="si">    if err := misc.VerifyForkHashes(chain.Config(), header, false); err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // All basic checks passed, verify cascading fields</span></div>
<div class="l li"><span class="si">    return c.verifyCascadingFields(chain, header, parents)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// verifyCascadingFields verifies all the header fields that are not standalone,</span></div>
<div class="l li"><span class="si">// rather depend on a batch of previous headers. The caller may optionally pass</span></div>
<div class="l li"><span class="si">// in a batch of parents (ascending order) to avoid looking those up from the</span></div>
<div class="l li"><span class="si">// database. This is useful for concurrently verifying a batch of new headers.</span></div>
<div class="l lc d36"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) verifyCascadingFields(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l li"><span class="si">    // The genesis block is the always valid dead-end</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    if number == 0 {</span></div>
<div class="l li"><span class="si">        return nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the block's timestamp isn't too close to it's parent</span></div>
<div class="l li"><span class="si">    var parent *types.Header</span></div>
<div class="l li"><span class="si">    if len(parents) &gt; 0 {</span></div>
<div class="l li"><span class="si">        parent = parents[len(parents)-1]</span></div>
<div class="l li"><span class="si">    } else {</span></div>
<div class="l li"><span class="si">        parent = chain.GetHeader(header.ParentHash, number-1)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if parent == nil || parent.Number.Uint64() != number-1 || parent.Hash() != header.ParentHash {</span></div>
<div class="l li"><span class="si">        return consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if parent.Time.Uint64()+c.config.Period &gt; header.Time.Uint64() {</span></div>
<div class="l li"><span class="si">        return ErrInvalidTimestamp</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d37"><span class="sd">    if header.Number.Uint64() &gt; c.config.Epoch &amp;&amp; len(header.Validator) == 0 {</span></div>
<div class="l ld d37"><span class="sd">        return consensus.ErrNoValidatorSignature</span></div>
<div class="l ld d37"><span class="sd">    }</span></div>
<div class="l li"><span class="si">    // Retrieve the snapshot needed to verify this header and cache it</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, parents)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // If the block is a checkpoint block, verify the signer list</span></div>
<div class="l li"><span class="si">    if number%c.config.Epoch == 0 {</span></div>
<div class="l lc d38"><span class="sc">        </span><span class="sc2">penPenalties</span><span class="sc"> := []common.</span><span class="sc2">Address{}</span></div>
<div class="l lc d38"><span class="sc">        </span><span class="sc2">if c.HookPenalty !</span><span class="sc">= </span><span class="sc2">nil</span><span class="sc"> {</span></div>
<div class="l lc d38"><span class="sc">            </span><span class="sc2">penPenalties, err = c.HookPenalty</span><span class="sc">(</span><span class="sc2">chain</span><span class="sc">, </span><span class="sc2">number</span><span class="sc">)</span></div>
<div class="l lc d38"><span class="sc">            </span><span class="sd">if err != nil {</span></div>
<div class="l lc d38"><span class="sc">                </span><span class="sd">return err</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l ld d39"><span class="sd">            for _, address := range penPenalties {</span></div>
<div class="l ld d39"><span class="sd">                log.Debug(&quot;Penalty Info&quot;, &quot;address&quot;, address, &quot;number&quot;, number)</span></div>
<div class="l ld d39"><span class="sd">            }</span></div>
<div class="l ld d39"><span class="sd">            bytePenalties := common.ExtractAddressToBytes(penPenalties)</span></div>
<div class="l ld d39"><span class="sd">            if !bytes.Equal(header.Penalties, bytePenalties) {</span></div>
<div class="l ld d39"><span class="sd">                return errInvalidCheckpointPenalties</span></div>
<div class="l ld d39"><span class="sd">            }</span></div>
<div class="l ld d39"><span class="sd">        }</span></div>
<div class="l ld d39"><span class="sd">        signers := snap.GetSigners()</span></div>
<div class="l ld d39"><span class="sd">        signers = common.RemoveItemFromArray(signers, penPenalties)</span></div>
<div class="l ld d39"><span class="sd">        for i := 1; i &lt;= common.LimitPenaltyEpoch; i++ {</span></div>
<div class="l ld d39"><span class="sd">            if number &gt; uint64(i)*c.config.Epoch {</span></div>
<div class="l ld d39"><span class="sd">                signers = RemovePenaltiesFromBlock(chain, signers, number-uint64(i)*c.config.Epoch)</span></div>
<div class="l ld d39"><span class="sd">            }</span></div>
<div class="l ld d39"><span class="sd">        }</span></div>
<div class="l ld d39"><span class="sd">        byteMasterNodes := common.ExtractAddressToBytes(signers)</span></div>
<div class="l li"><span class="si">        extraSuffix := len(header.Extra) - extraSeal</span></div>
<div class="l lc d40"><span class="sc">        if !bytes.Equal(header.Extra[extraVanity:extraSuffix], </span><span class="sc2">byteMasterNodes</span><span class="sc">) {</span></div>
<div class="l lc d40"><span class="sc">            return </span><span class="sc2">errInvalidCheckpointSigners</span></div>
<div class="l lc d40"><span class="sc">        </span><span class="sd">}</span></div>
<div class="l lc d40"><span class="sc">        </span><span class="sd">if c.HookVerifyMNs != nil {</span></div>
<div class="l lc d40"><span class="sc">            </span><span class="sd">err := c.HookVerifyMNs(header, signers)</span></div>
<div class="l lc d40"><span class="sc">            </span><span class="sd">if err != nil {</span></div>
<div class="l lc d40"><span class="sc">                </span><span class="sd">return err</span></div>
<div class="l lc d40"><span class="sc">            </span><span class="sd">}</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // All basic checks passed, verify the seal and return</span></div>
<div class="l li"><span class="si">    return c.verifySeal(chain, header, parents)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l lg"> </div>
<div class="l ld d41"><span class="sd">func (c *Posv) GetSnapshot(chain consensus.ChainReader, header *types.Header) (*Snapshot, error) {</span></div>
<div class="l ld d41"><span class="sd">    number := header.Number.Uint64()</span></div>
<div class="l ld d41"><span class="sd">    log.Trace(&quot;take snapshot&quot;, &quot;number&quot;, number, &quot;hash&quot;, header.Hash())</span></div>
<div class="l ld d41"><span class="sd">    snap, err := c.snapshot(chain, number, header.Hash(), nil)</span></div>
<div class="l ld d41"><span class="sd">    if err != nil {</span></div>
<div class="l ld d41"><span class="sd">        return nil, err</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    return snap, nil</span></div>
<div class="l ld d41"><span class="sd">}</span></div>
<div class="l lg d41"> </div>
<div class="l ld d41"><span class="sd">func (c *Posv) StoreSnapshot(snap *Snapshot) error {</span></div>
<div class="l ld d41"><span class="sd">    return snap.store(c.db)</span></div>
<div class="l ld d41"><span class="sd">}</span></div>
<div class="l lg d41"> </div>
<div class="l ld d41"><span class="sd">func position(list []common.Address, x common.Address) int {</span></div>
<div class="l ld d41"><span class="sd">    for i, item := range list {</span></div>
<div class="l ld d41"><span class="sd">        if item == x {</span></div>
<div class="l ld d41"><span class="sd">            return i</span></div>
<div class="l ld d41"><span class="sd">        }</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    return -1</span></div>
<div class="l ld d41"><span class="sd">}</span></div>
<div class="l lg d41"> </div>
<div class="l ld d41"><span class="sd">func (c *Posv) GetMasternodes(chain consensus.ChainReader, header *types.Header) []common.Address {</span></div>
<div class="l ld d41"><span class="sd">    n := header.Number.Uint64()</span></div>
<div class="l ld d41"><span class="sd">    e := c.config.Epoch</span></div>
<div class="l ld d41"><span class="sd">    switch {</span></div>
<div class="l ld d41"><span class="sd">    case n%e == 0:</span></div>
<div class="l ld d41"><span class="sd">        return c.GetMasternodesFromCheckpointHeader(header, n, e)</span></div>
<div class="l ld d41"><span class="sd">    case n%e != 0:</span></div>
<div class="l ld d41"><span class="sd">        h := chain.GetHeaderByNumber(n - (n % e))</span></div>
<div class="l ld d41"><span class="sd">        return c.GetMasternodesFromCheckpointHeader(h, n, e)</span></div>
<div class="l ld d41"><span class="sd">    default:</span></div>
<div class="l ld d41"><span class="sd">        return []common.Address{}</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">}</span></div>
<div class="l lg d41"> </div>
<div class="l ld d41"><span class="sd">func (c *Posv) GetPeriod() uint64 { return c.config.Period }</span></div>
<div class="l lg d41"> </div>
<div class="l ld d41"><span class="sd">func WhoIsCreator(snap *Snapshot, header *types.Header) (common.Address, error) {</span></div>
<div class="l ld d41"><span class="sd">    if header.Number.Uint64() == 0 {</span></div>
<div class="l ld d41"><span class="sd">        return common.Address{}, errors.New(&quot;Don't take block 0&quot;)</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    m, err := ecrecover(header, snap.sigcache)</span></div>
<div class="l ld d41"><span class="sd">    if err != nil {</span></div>
<div class="l ld d41"><span class="sd">        return common.Address{}, err</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    return m, nil</span></div>
<div class="l ld d41"><span class="sd">}</span></div>
<div class="l lg d41"> </div>
<div class="l ld d41"><span class="sd">func YourTurn(masternodes []common.Address, snap *Snapshot, header *types.Header, cur common.Address) (int, int, bool, error) {</span></div>
<div class="l ld d41"><span class="sd">    if len(masternodes) == 0 {</span></div>
<div class="l ld d41"><span class="sd">        return -1, -1, true, nil</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    pre := common.Address{}</span></div>
<div class="l ld d41"><span class="sd">    // masternode[0] has chance to create block 1</span></div>
<div class="l ld d41"><span class="sd">    var err error</span></div>
<div class="l ld d41"><span class="sd">    preIndex := -1</span></div>
<div class="l ld d41"><span class="sd">    if header.Number.Uint64() != 0 {</span></div>
<div class="l ld d41"><span class="sd">        pre, err = WhoIsCreator(snap, header)</span></div>
<div class="l ld d41"><span class="sd">        if err != nil {</span></div>
<div class="l ld d41"><span class="sd">            return 0, 0, false, err</span></div>
<div class="l ld d41"><span class="sd">        }</span></div>
<div class="l ld d41"><span class="sd">        preIndex = position(masternodes, pre)</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    curIndex := position(masternodes, cur)</span></div>
<div class="l ld d41"><span class="sd">    log.Info(&quot;Masternodes cycle info&quot;, &quot;number of masternodes&quot;, len(masternodes), &quot;previous&quot;, pre, &quot;position&quot;, preIndex, &quot;current&quot;, cur, &quot;position&quot;, curIndex)</span></div>
<div class="l ld d41"><span class="sd">    for i, s := range masternodes {</span></div>
<div class="l ld d41"><span class="sd">        fmt.Printf(&quot;%d - %s\n&quot;, i, s.String())</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    if (preIndex+1)%len(masternodes) == curIndex {</span></div>
<div class="l ld d41"><span class="sd">        return preIndex, curIndex, true, nil</span></div>
<div class="l ld d41"><span class="sd">    }</span></div>
<div class="l ld d41"><span class="sd">    return preIndex, curIndex, false, nil</span></div>
<div class="l ld d41"><span class="sd">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// snapshot retrieves the authorization snapshot at a given point in time.</span></div>
<div class="l lc d42"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) snapshot(chain consensus.ChainReader, number uint64, hash common.Hash, parents []*types.Header) (*Snapshot, error) {</span></div>
<div class="l li"><span class="si">    // Search for a snapshot in memory or on disk for checkpoints</span></div>
<div class="l li"><span class="si">    var (</span></div>
<div class="l li"><span class="si">        headers []*types.Header</span></div>
<div class="l li"><span class="si">        snap    *Snapshot</span></div>
<div class="l li"><span class="si">    )</span></div>
<div class="l li"><span class="si">    for snap == nil {</span></div>
<div class="l li"><span class="si">        // If an in-memory snapshot was found, use that</span></div>
<div class="l li"><span class="si">        if s, ok := c.recents.Get(hash); ok {</span></div>
<div class="l li"><span class="si">            snap = s.(*Snapshot)</span></div>
<div class="l li"><span class="si">            break</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        // If an on-disk checkpoint snapshot can be found, use that</span></div>
<div class="l lc d43"><span class="sc">        </span><span class="sc2">// checkpoint snapshot</span><span class="sc"> = </span><span class="sc2">checkpoint - gap</span></div>
<div class="l lc d43"><span class="sc">        </span><span class="sd">if (number+c.config.Gap)%c.config.Epoch == 0 {</span></div>
<div class="l li"><span class="si">            if s, err := loadSnapshot(c.config, c.signatures, c.db, hash); err == nil {</span></div>
<div class="l lc d44"><span class="sc">                log.Trace(&quot;Loaded voting snapshot </span><span class="sc2">form</span><span class="sc"> disk&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash)</span></div>
<div class="l li"><span class="si">                snap = s</span></div>
<div class="l li"><span class="si">                break</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l lc d45"><span class="sc">        // If we're at block </span><span class="sd">zero</span><span class="sc">, make a snapshot</span></div>
<div class="l lc d45"><span class="sc">        if number == 0 {</span></div>
<div class="l lc d45"><span class="sc">            </span><span class="sc2">genesis</span><span class="sc"> := chain.GetHeaderByNumber(</span><span class="sc2">0</span><span class="sc">)</span></div>
<div class="l lc d45"><span class="sc">            if </span><span class="sc2">err := c.VerifyHeader(chain, genesis, false); err</span><span class="sc"> != nil {</span></div>
<div class="l lc d45"><span class="sc">                </span><span class="sc2">return nil, err</span></div>
<div class="l lc d45"><span class="sc">            </span><span class="sd">}</span></div>
<div class="l lc d45"><span class="sc">            signers := make([]common.Address, (len(</span><span class="sc2">genesis</span><span class="sc">.Extra)-extraVanity-extraSeal)/common.AddressLength)</span></div>
<div class="l li"><span class="si">            for i := 0; i &lt; len(signers); i++ {</span></div>
<div class="l lc d46"><span class="sc">                copy(signers[i][:], </span><span class="sc2">genesis</span><span class="sc">.Extra[extraVanity+i*common.AddressLength:])</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l lc d47"><span class="sc">            snap = newSnapshot(c.config, c.signatures, </span><span class="sc2">0</span><span class="sc">, </span><span class="sd">genesis.</span><span class="sc2">Hash</span><span class="sd">()</span><span class="sc">, signers)</span></div>
<div class="l li"><span class="si">            if err := snap.store(c.db); err != nil {</span></div>
<div class="l li"><span class="si">                return nil, err</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l lc d48"><span class="sc">            log.</span><span class="sc2">Trace</span><span class="sc">(&quot;Stored </span><span class="sc2">genesis voting</span><span class="sc"> snapshot to disk&quot;)</span></div>
<div class="l li"><span class="si">            break</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l la d49"> </div>
<div class="l li"><span class="si">        // No snapshot for this header, gather the header and move backward</span></div>
<div class="l li"><span class="si">        var header *types.Header</span></div>
<div class="l li"><span class="si">        if len(parents) &gt; 0 {</span></div>
<div class="l li"><span class="si">            // If we have explicit parents, pick from there (enforced)</span></div>
<div class="l li"><span class="si">            header = parents[len(parents)-1]</span></div>
<div class="l li"><span class="si">            if header.Hash() != hash || header.Number.Uint64() != number {</span></div>
<div class="l li"><span class="si">                return nil, consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">            parents = parents[:len(parents)-1]</span></div>
<div class="l li"><span class="si">        } else {</span></div>
<div class="l li"><span class="si">            // No explicit parents (or no more left), reach out to the database</span></div>
<div class="l li"><span class="si">            header = chain.GetHeader(hash, number)</span></div>
<div class="l li"><span class="si">            if header == nil {</span></div>
<div class="l li"><span class="si">                return nil, consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        headers = append(headers, header)</span></div>
<div class="l li"><span class="si">        number, hash = number-1, header.ParentHash</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Previous snapshot found, apply any pending headers on top of it</span></div>
<div class="l li"><span class="si">    for i := 0; i &lt; len(headers)/2; i++ {</span></div>
<div class="l li"><span class="si">        headers[i], headers[len(headers)-1-i] = headers[len(headers)-1-i], headers[i]</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    snap, err := snap.apply(headers)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return nil, err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    c.recents.Add(snap.Hash, snap)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // If we've generated a new checkpoint snapshot, save to disk</span></div>
<div class="l lc d50"><span class="sc">    if </span><span class="sd">(</span><span class="sc">snap.Number</span><span class="sd">+c.config.Gap)</span><span class="sc">%</span><span class="sc2">c.config.Epoch</span><span class="sc"> == 0 {</span></div>
<div class="l li"><span class="si">        if err = snap.store(c.db); err != nil {</span></div>
<div class="l li"><span class="si">            return nil, err</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        log.Trace(&quot;Stored voting snapshot to disk&quot;, &quot;number&quot;, snap.Number, &quot;hash&quot;, snap.Hash)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return snap, err</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifyUncles implements consensus.Engine, always returning an error for any</span></div>
<div class="l li"><span class="si">// uncles as this consensus mechanism doesn't permit uncles.</span></div>
<div class="l lc d51"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) VerifyUncles(chain consensus.ChainReader, block *types.Block) error {</span></div>
<div class="l li"><span class="si">    if len(block.Uncles()) &gt; 0 {</span></div>
<div class="l li"><span class="si">        return errors.New(&quot;uncles not allowed&quot;)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifySeal implements consensus.Engine, checking whether the signature contained</span></div>
<div class="l li"><span class="si">// in the header satisfies the consensus protocol requirements.</span></div>
<div class="l lc d52"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) VerifySeal(chain consensus.ChainReader, header *types.Header) error {</span></div>
<div class="l li"><span class="si">    return c.verifySeal(chain, header, nil)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// verifySeal checks whether the signature contained in the header satisfies the</span></div>
<div class="l li"><span class="si">// consensus protocol requirements. The method accepts an optional list of parent</span></div>
<div class="l li"><span class="si">// headers that aren't yet part of the local blockchain to generate the snapshots</span></div>
<div class="l li"><span class="si">// from.</span></div>
<div class="l lc d53"><span class="sd">// verifySeal also checks the pair of creator-validator set in the header satisfies</span></div>
<div class="l lc d53"><span class="sd">// the double validation.</span></div>
<div class="l lc d53"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) verifySeal(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l li"><span class="si">    // Verifying the genesis block is not supported</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    if number == 0 {</span></div>
<div class="l li"><span class="si">        return errUnknownBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Retrieve the snapshot needed to verify this header and cache it</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, parents)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Resolve the authorization key and check against signers</span></div>
<div class="l lc d54"><span class="sc">    </span><span class="sc2">creator</span><span class="sc">, err := ecrecover(header, c.signatures)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">masternodes := c.GetMasternodes(chain, header)</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">mstring := []string{}</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">for _, m := range masternodes {</span></div>
<div class="l lc d55"><span class="sc">        </span><span class="sd">mstring = append(mstring, m.String())</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">}</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">nstring := []string{}</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">for _, n := range snap.GetSigners() {</span></div>
<div class="l lc d55"><span class="sc">        </span><span class="sd">nstring = append(nstring, n.String())</span></div>
<div class="l lc d55"><span class="sc">    </span><span class="sd">}</span></div>
<div class="l lc d55"><span class="sc">    if _, ok := snap.Signers[</span><span class="sc2">creator</span><span class="sc">]; !ok {</span></div>
<div class="l lc d55"><span class="sc">        </span><span class="sc2">valid := false</span></div>
<div class="l lc d55"><span class="sc">        </span><span class="sd">for _, m := range masternodes {</span></div>
<div class="l lc d55"><span class="sc">            </span><span class="sd">if m == creator {</span></div>
<div class="l lc d55"><span class="sc">                </span><span class="sd">valid = true</span></div>
<div class="l lc d55"><span class="sc">                </span><span class="sd">break</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l ld d56"><span class="sd">        }</span></div>
<div class="l ld d56"><span class="sd">        if !valid {</span></div>
<div class="l ld d56"><span class="sd">            log.Debug(&quot;Unauthorized creator found&quot;, &quot;block number&quot;, number, &quot;creator&quot;, creator.String(), &quot;masternodes&quot;, mstring, &quot;snapshot from parent block&quot;, nstring)</span></div>
<div class="l ld d56"><span class="sd">            return errUnauthorized</span></div>
<div class="l ld d56"><span class="sd">        }</span></div>
<div class="l ld d56"><span class="sd">    }</span></div>
<div class="l ld d56"><span class="sd">    if len(masternodes) &gt; 1 {</span></div>
<div class="l li"><span class="si">        for seen, recent := range snap.Recents {</span></div>
<div class="l lc d57"><span class="sc">            if recent == </span><span class="sc2">creator</span><span class="sc"> {</span></div>
<div class="l li"><span class="si">                // Signer is among recents, only fail if the current block doesn't shift it out</span></div>
<div class="l lc d58"><span class="sc">                </span><span class="sd">// There is only case that we don't allow signer to create two continuous blocks.</span></div>
<div class="l lc d58"><span class="sc">                if limit := uint64(2); seen &gt; number-limit {</span></div>
<div class="l lc d58"><span class="sc">                    </span><span class="sc2">// Only take into account the non-epoch blocks</span></div>
<div class="l lc d58"><span class="sc">                    </span><span class="sd">if number%c.config.Epoch != 0 {</span></div>
<div class="l lc d58"><span class="sc">                        </span><span class="sd">return errUnauthorized</span></div>
<div class="l li"><span class="si">                    }</span></div>
<div class="l li"><span class="si">                }</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l la d59"> </div>
<div class="l la d59"> </div>
<div class="l la d59"> </div>
<div class="l la d59"> </div>
<div class="l la d59"> </div>
<div class="l li"><span class="si">        }</span></div>
<div class="l la d60"> </div>
<div class="l la d60"> </div>
<div class="l li"><span class="si">    }</span></div>
<div class="l lg"> </div>
<div class="l ld d61"><span class="sd">    // header must contain validator info following double validation design</span></div>
<div class="l ld d61"><span class="sd">    // start checking from epoch 2nd.</span></div>
<div class="l ld d61"><span class="sd">    if header.Number.Uint64() &gt; c.config.Epoch {</span></div>
<div class="l ld d61"><span class="sd">        validator, err := c.RecoverValidator(header)</span></div>
<div class="l ld d61"><span class="sd">        if err != nil {</span></div>
<div class="l ld d61"><span class="sd">            return err</span></div>
<div class="l ld d61"><span class="sd">        }</span></div>
<div class="l lg d61"> </div>
<div class="l ld d61"><span class="sd">        // verify validator</span></div>
<div class="l ld d61"><span class="sd">        assignedValidator, err := c.GetValidator(creator, chain, header)</span></div>
<div class="l ld d61"><span class="sd">        if err != nil {</span></div>
<div class="l ld d61"><span class="sd">            return err</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l ld d62"><span class="sd">        if validator != assignedValidator {</span></div>
<div class="l ld d62"><span class="sd">            log.Debug(&quot;Bad block detected. Header contains wrong pair of creator-validator&quot;, &quot;creator&quot;, creator, &quot;assigned validator&quot;, assignedValidator, &quot;wrong validator&quot;, validator)</span></div>
<div class="l ld d62"><span class="sd">            return errFailedDoubleValidation</span></div>
<div class="l ld d62"><span class="sd">        }</span></div>
<div class="l ld d62"><span class="sd">    }</span></div>
<div class="l li"><span class="si">    return nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l lg"> </div>
<div class="l ld d63"><span class="sd">func (c *Posv) GetValidator(creator common.Address, chain consensus.ChainReader, header *types.Header) (common.Address, error) {</span></div>
<div class="l ld d63"><span class="sd">    epoch := c.config.Epoch</span></div>
<div class="l ld d63"><span class="sd">    no := header.Number.Uint64()</span></div>
<div class="l ld d63"><span class="sd">    cpNo := no</span></div>
<div class="l ld d63"><span class="sd">    if no%epoch != 0 {</span></div>
<div class="l ld d63"><span class="sd">        cpNo = no - (no % epoch)</span></div>
<div class="l ld d63"><span class="sd">    }</span></div>
<div class="l ld d63"><span class="sd">    if cpNo == 0 {</span></div>
<div class="l ld d63"><span class="sd">        return common.Address{}, nil</span></div>
<div class="l ld d63"><span class="sd">    }</span></div>
<div class="l ld d63"><span class="sd">    cpHeader := chain.GetHeaderByNumber(cpNo)</span></div>
<div class="l ld d63"><span class="sd">    if cpHeader == nil {</span></div>
<div class="l ld d63"><span class="sd">        if no%epoch == 0 {</span></div>
<div class="l ld d63"><span class="sd">            cpHeader = header</span></div>
<div class="l ld d63"><span class="sd">        } else {</span></div>
<div class="l ld d63"><span class="sd">            return common.Address{}, fmt.Errorf(&quot;couldn't find checkpoint header&quot;)</span></div>
<div class="l ld d63"><span class="sd">        }</span></div>
<div class="l ld d63"><span class="sd">    }</span></div>
<div class="l ld d63"><span class="sd">    m, err := GetM1M2FromCheckpointHeader(cpHeader)</span></div>
<div class="l ld d63"><span class="sd">    if err != nil {</span></div>
<div class="l ld d63"><span class="sd">        return common.Address{}, err</span></div>
<div class="l ld d63"><span class="sd">    }</span></div>
<div class="l ld d63"><span class="sd">    return m[creator], nil</span></div>
<div class="l ld d63"><span class="sd">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Prepare implements consensus.Engine, preparing all the consensus fields of the</span></div>
<div class="l li"><span class="si">// header for running the transactions on top.</span></div>
<div class="l lc d64"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) Prepare(chain consensus.ChainReader, header *types.Header) error {</span></div>
<div class="l li"><span class="si">    // If the block isn't a checkpoint, cast a random vote (good enough for now)</span></div>
<div class="l li"><span class="si">    header.Coinbase = common.Address{}</span></div>
<div class="l li"><span class="si">    header.Nonce = types.BlockNonce{}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    // Assemble the voting snapshot to check which votes make sense</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, nil)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if number%c.config.Epoch != 0 {</span></div>
<div class="l li"><span class="si">        c.lock.RLock()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">        // Gather all the proposals that make sense voting on</span></div>
<div class="l li"><span class="si">        addresses := make([]common.Address, 0, len(c.proposals))</span></div>
<div class="l li"><span class="si">        for address, authorize := range c.proposals {</span></div>
<div class="l li"><span class="si">            if snap.validVote(address, authorize) {</span></div>
<div class="l li"><span class="si">                addresses = append(addresses, address)</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        // If there's pending proposals, cast a vote on them</span></div>
<div class="l li"><span class="si">        if len(addresses) &gt; 0 {</span></div>
<div class="l li"><span class="si">            header.Coinbase = addresses[rand.Intn(len(addresses))]</span></div>
<div class="l li"><span class="si">            if c.proposals[header.Coinbase] {</span></div>
<div class="l li"><span class="si">                copy(header.Nonce[:], nonceAuthVote)</span></div>
<div class="l li"><span class="si">            } else {</span></div>
<div class="l li"><span class="si">                copy(header.Nonce[:], nonceDropVote)</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        c.lock.RUnlock()</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Set the correct difficulty</span></div>
<div class="l lc d65"><span class="sc">    header.Difficulty = </span><span class="sc2">big.NewInt</span><span class="sc">(</span><span class="sc2">1</span><span class="sc">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Ensure the extra data has all it's components</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraVanity {</span></div>
<div class="l li"><span class="si">        header.Extra = append(header.Extra, bytes.Repeat([]byte{0x00}, extraVanity-len(header.Extra))...)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    header.Extra = header.Extra[:extraVanity]</span></div>
<div class="l ld d66"><span class="sd">    signers := snap.GetSigners()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    if number%c.config.Epoch == 0 {</span></div>
<div class="l lc d67"><span class="sc">        </span><span class="sd">if c.HookPenalty != nil {</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">penSigners, err := c.HookPenalty(chain, number)</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">if err != nil {</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">return err</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">}</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">if len(penSigners) &gt; 0 {</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">// Keep remove penalty signer out of signer list.</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">signers = common.RemoveItemFromArray(signers, penSigners)</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">for _, address := range penSigners {</span></div>
<div class="l lc d67"><span class="sc">                    </span><span class="sd">log.Debug(&quot;Penalty Info&quot;, &quot;address&quot;, address, &quot;number&quot;, number)</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">}</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">header.Penalties = common.ExtractAddressToBytes(penSigners)</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">}</span></div>
<div class="l lc d67"><span class="sc">        </span><span class="sd">}</span></div>
<div class="l lc d67"><span class="sc">        </span><span class="sd">// Prevent penaltied signer in 4 epocs ago jump into signer list.</span></div>
<div class="l lc d67"><span class="sc">        </span><span class="sd">for i := 1; i &lt;= common.LimitPenaltyEpoch; i++ {</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">if number &gt; uint64(i)*c.config.Epoch {</span></div>
<div class="l lc d67"><span class="sc">                </span><span class="sd">signers = RemovePenaltiesFromBlock(chain, signers, number-uint64(i)*c.config.Epoch)</span></div>
<div class="l lc d67"><span class="sc">            </span><span class="sd">}</span></div>
<div class="l lc d67"><span class="sc">        </span><span class="sd">}</span></div>
<div class="l lc d67"><span class="sc">        for _, signer := range signers {</span></div>
<div class="l li"><span class="si">            header.Extra = append(header.Extra, signer[:]...)</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    header.Extra = append(header.Extra, make([]byte, extraSeal)...)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Mix digest is reserved for now, set to empty</span></div>
<div class="l li"><span class="si">    header.MixDigest = common.Hash{}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Ensure the timestamp has the correct delay</span></div>
<div class="l li"><span class="si">    parent := chain.GetHeader(header.ParentHash, number-1)</span></div>
<div class="l li"><span class="si">    if parent == nil {</span></div>
<div class="l li"><span class="si">        return consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    header.Time = new(big.Int).Add(parent.Time, new(big.Int).SetUint64(c.config.Period))</span></div>
<div class="l li"><span class="si">    if header.Time.Int64() &lt; time.Now().Unix() {</span></div>
<div class="l li"><span class="si">        header.Time = big.NewInt(time.Now().Unix())</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d68"><span class="sd">    if c.HookValidator != nil {</span></div>
<div class="l ld d68"><span class="sd">        c.HookValidator(header, signers)</span></div>
<div class="l ld d68"><span class="sd">        if err != nil {</span></div>
<div class="l ld d68"><span class="sd">            return err</span></div>
<div class="l ld d68"><span class="sd">        }</span></div>
<div class="l ld d68"><span class="sd">    }</span></div>
<div class="l li"><span class="si">    return nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l lg"> </div>
<div class="l ld d69"><span class="sd">func (c *Posv) UpdateMasternodes(chain consensus.ChainReader, header *types.Header, ms []Masternode) error {</span></div>
<div class="l ld d69"><span class="sd">    number := header.Number.Uint64()</span></div>
<div class="l ld d69"><span class="sd">    log.Trace(&quot;take snapshot&quot;, &quot;number&quot;, number, &quot;hash&quot;, header.Hash())</span></div>
<div class="l ld d69"><span class="sd">    // get snapshot</span></div>
<div class="l ld d69"><span class="sd">    snap, err := c.snapshot(chain, number, header.Hash(), nil)</span></div>
<div class="l ld d69"><span class="sd">    if err != nil {</span></div>
<div class="l ld d69"><span class="sd">        return err</span></div>
<div class="l ld d69"><span class="sd">    }</span></div>
<div class="l ld d69"><span class="sd">    currentSigners := snap.GetSigners()</span></div>
<div class="l ld d69"><span class="sd">    proposedSigners := make(map[common.Address]struct{})</span></div>
<div class="l ld d69"><span class="sd">    // count all addresses in ms to be masternode</span></div>
<div class="l ld d69"><span class="sd">    for _, m := range ms {</span></div>
<div class="l ld d69"><span class="sd">        proposedSigners[m.Address] = struct{}{}</span></div>
<div class="l ld d69"><span class="sd">        snap.Signers[m.Address] = struct{}{}</span></div>
<div class="l ld d69"><span class="sd">    }</span></div>
<div class="l ld d69"><span class="sd">    // deactivate current masternodes which aren't in ms</span></div>
<div class="l ld d69"><span class="sd">    for _, s := range currentSigners {</span></div>
<div class="l ld d69"><span class="sd">        if _, ok := proposedSigners[s]; !ok {</span></div>
<div class="l ld d69"><span class="sd">            delete(snap.Signers, s)</span></div>
<div class="l ld d69"><span class="sd">        }</span></div>
<div class="l ld d69"><span class="sd">    }</span></div>
<div class="l ld d69"><span class="sd">    nm := []string{}</span></div>
<div class="l ld d69"><span class="sd">    newSigners := snap.GetSigners()</span></div>
<div class="l ld d69"><span class="sd">    for _, n := range newSigners {</span></div>
<div class="l ld d69"><span class="sd">        nm = append(nm, n.String())</span></div>
<div class="l ld d69"><span class="sd">    }</span></div>
<div class="l ld d69"><span class="sd">    c.recents.Add(snap.Hash, snap)</span></div>
<div class="l ld d69"><span class="sd">    log.Info(&quot;New set of masternodes has been updated to snapshot&quot;, &quot;number&quot;, snap.Number, &quot;hash&quot;, snap.Hash, &quot;new masternodes&quot;, nm)</span></div>
<div class="l ld d69"><span class="sd">    return nil</span></div>
<div class="l ld d69"><span class="sd">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Finalize implements consensus.Engine, ensuring no uncles are set, nor block</span></div>
<div class="l li"><span class="si">// rewards given, and returns the final block.</span></div>
<div class="l lc d70"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) Finalize(chain consensus.ChainReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, receipts []*types.Receipt) (*types.Block, error) {</span></div>
<div class="l lc d70"><span class="sc">    </span><span class="sd">// set block reward</span></div>
<div class="l lc d70"><span class="sc">    </span><span class="sd">// FIXME: unit Ether could be too plump</span></div>
<div class="l lc d70"><span class="sc">    </span><span class="sd">number := header.Number.Uint64()</span></div>
<div class="l lc d70"><span class="sc">    </span><span class="sd">rCheckpoint := chain.Config().Posv.RewardCheckpoint</span></div>
<div class="l lg d70"> </div>
<div class="l lc d70"><span class="sc">    </span><span class="sd">if c.HookReward != nil &amp;&amp; number%rCheckpoint == 0 {</span></div>
<div class="l lc d70"><span class="sc">        </span><span class="sd">if err := c.HookReward(chain, state, header); err != nil {</span></div>
<div class="l lc d70"><span class="sc">            </span><span class="sd">return nil, err</span></div>
<div class="l lc d70"><span class="sc">        </span><span class="sd">}</span></div>
<div class="l lc d70"><span class="sc">    </span><span class="sd">}</span></div>
<div class="l lg"> </div>
<div class="l li"><span class="si">    // No block rewards in PoA, so the state remains as is and uncles are dropped</span></div>
<div class="l li"><span class="si">    header.Root = state.IntermediateRoot(chain.Config().IsEIP158(header.Number))</span></div>
<div class="l li"><span class="si">    header.UncleHash = types.CalcUncleHash(nil)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Assemble and return the final block for sealing</span></div>
<div class="l li"><span class="si">    return types.NewBlock(header, txs, nil, receipts), nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Authorize injects a private key into the consensus engine to mint new blocks</span></div>
<div class="l li"><span class="si">// with.</span></div>
<div class="l lc d71"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) Authorize(signer common.Address, signFn </span><span class="sd">clique.</span><span class="sc">SignerFn) {</span></div>
<div class="l li"><span class="si">    c.lock.Lock()</span></div>
<div class="l li"><span class="si">    defer c.lock.Unlock()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    c.signer = signer</span></div>
<div class="l li"><span class="si">    c.signFn = signFn</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Seal implements consensus.Engine, attempting to create a sealed block using</span></div>
<div class="l li"><span class="si">// the local signing credentials.</span></div>
<div class="l lc d72"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) Seal(chain consensus.ChainReader, block *types.Block, stop &lt;-chan struct{}) </span><span class="sd">(*types.Block,</span><span class="sc"> error</span><span class="sd">)</span><span class="sc"> {</span></div>
<div class="l li"><span class="si">    header := block.Header()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Sealing the genesis block is not supported</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    if number == 0 {</span></div>
<div class="l lc d73"><span class="sc">        return </span><span class="sd">nil,</span><span class="sc"> errUnknownBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // For 0-period chains, refuse to seal empty blocks (no reward but would spin sealing)</span></div>
<div class="l li"><span class="si">    if c.config.Period == 0 &amp;&amp; len(block.Transactions()) == 0 {</span></div>
<div class="l lc d74"><span class="sc">        </span><span class="sc2">return nil</span><span class="sc">, </span><span class="sc2">errWaitTransactions</span></div>
<div class="l lc d74"> </div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Don't hold the signer fields for the entire sealing procedure</span></div>
<div class="l li"><span class="si">    c.lock.RLock()</span></div>
<div class="l li"><span class="si">    signer, signFn := c.signer, c.signFn</span></div>
<div class="l li"><span class="si">    c.lock.RUnlock()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Bail out if we're unauthorized to sign a block</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, nil)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l lc d75"><span class="sc">        return </span><span class="sd">nil,</span><span class="sc"> err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d76"><span class="sd">    masternodes := c.GetMasternodes(chain, header)</span></div>
<div class="l li"><span class="si">    if _, authorized := snap.Signers[signer]; !authorized {</span></div>
<div class="l lc d77"><span class="sc">        </span><span class="sd">valid := false</span></div>
<div class="l lc d77"><span class="sc">        </span><span class="sd">for _, m := range masternodes {</span></div>
<div class="l lc d77"><span class="sc">            </span><span class="sd">if m == signer {</span></div>
<div class="l lc d77"><span class="sc">                </span><span class="sd">valid = true</span></div>
<div class="l lc d77"><span class="sc">                </span><span class="sd">break</span></div>
<div class="l lc d77"><span class="sc">            </span><span class="sd">}</span></div>
<div class="l lc d77"><span class="sc">        </span><span class="sd">}</span></div>
<div class="l lc d77"><span class="sc">        </span><span class="sd">if !valid {</span></div>
<div class="l lc d77"><span class="sc">            return </span><span class="sd">nil,</span><span class="sc"> </span><span class="sc2">errUnauthorized</span></div>
<div class="l lc d77"><span class="sc">        </span><span class="sd">}</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // If we're amongst the recent signers, wait for the next block</span></div>
<div class="l ld d78"><span class="sd">    // only check recent signers if there are more than one signer.</span></div>
<div class="l ld d78"><span class="sd">    if len(masternodes) &gt; 1 {</span></div>
<div class="l li"><span class="si">        for seen, recent := range snap.Recents {</span></div>
<div class="l li"><span class="si">            if recent == signer {</span></div>
<div class="l li"><span class="si">                // Signer is among recents, only wait if the current block doesn't shift it out</span></div>
<div class="l lc d79"><span class="sc">                </span><span class="sd">// There is only case that we don't allow signer to create two continuous blocks.</span></div>
<div class="l lc d79"><span class="sc">                if limit := uint64(2); number &lt; limit || seen &gt; number-limit {</span></div>
<div class="l lc d79"><span class="sc">                    </span><span class="sd">// Only take into account the non-epoch blocks</span></div>
<div class="l lc d79"><span class="sc">                    </span><span class="sd">if number%c.config.Epoch != 0 {</span></div>
<div class="l lc d79"><span class="sc">                        </span><span class="sd">log.Info(&quot;Debugging&quot;, &quot;len(masternodes)&quot;, len(masternodes), &quot;number&quot;, number, &quot;limit&quot;, limit, &quot;seen&quot;, seen, &quot;recent&quot;, recent.String(), &quot;snap.Recents&quot;, snap.Recents)</span></div>
<div class="l li"><span class="si">                        log.Info(&quot;Signed recently, must wait for others&quot;)</span></div>
<div class="l lc d80"><span class="sc">                        </span><span class="sd">&lt;-stop</span></div>
<div class="l lc d80"><span class="sc">                        return nil</span><span class="sd">, nil</span></div>
<div class="l lc d80"><span class="sc">                    </span><span class="sd">}</span></div>
<div class="l lc d80"><span class="sc">                </span><span class="sd">}</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l lc d81"><span class="sc">    </span><span class="sc2">select {</span></div>
<div class="l lc d81"><span class="sc">    </span><span class="sc2">case &lt;-stop</span><span class="sc">:</span></div>
<div class="l lc d81"><span class="sc">        </span><span class="sc2">return nil, nil</span></div>
<div class="l lc d81"><span class="sc">    </span><span class="sc2">default:</span></div>
<div class="l lc d81"> </div>
<div class="l lc d81"> </div>
<div class="l lc d81"> </div>
<div class="l lc d81"> </div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Sign all the things!</span></div>
<div class="l li"><span class="si">    sighash, err := signFn(accounts.Account{Address: signer}, sigHash(header).Bytes())</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l lc d82"><span class="sc">        return </span><span class="sd">nil,</span><span class="sc"> err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    copy(header.Extra[len(header.Extra)-extraSeal:], sighash)</span></div>
<div class="l lg"> </div>
<div class="l lc d83"><span class="sc">    </span><span class="sc2">return block</span><span class="sc">.</span><span class="sd">WithSeal(header), nil</span></div>
<div class="l lc d83"> </div>
<div class="l lc d83"> </div>
<div class="l lc d83"> </div>
<div class="l lc d83"> </div>
<div class="l lc d83"> </div>
<div class="l lc d83"> </div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l la d84"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// CalcDifficulty is the difficulty adjustment algorithm. It returns the difficulty</span></div>
<div class="l li"><span class="si">// that a new block should have based on the previous blocks in the chain and the</span></div>
<div class="l li"><span class="si">// current signer.</span></div>
<div class="l lc d85"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) CalcDifficulty(chain consensus.ChainReader, time uint64, parent *types.Header) *big.Int {</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, parent.Number.Uint64(), parent.Hash(), nil)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return CalcDifficulty(snap, c.signer)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// CalcDifficulty is the difficulty adjustment algorithm. It returns the difficulty</span></div>
<div class="l li"><span class="si">// that a new block should have based on the previous blocks in the chain and the</span></div>
<div class="l li"><span class="si">// current signer.</span></div>
<div class="l li"><span class="si">func CalcDifficulty(snap *Snapshot, signer common.Address) *big.Int {</span></div>
<div class="l li"><span class="si">    if snap.inturn(snap.Number+1, signer) {</span></div>
<div class="l li"><span class="si">        return new(big.Int).Set(diffInTurn)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return new(big.Int).Set(diffNoTurn)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l la d86"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// APIs implements consensus.Engine, returning the user facing RPC API to allow</span></div>
<div class="l li"><span class="si">// controlling the signer voting.</span></div>
<div class="l lc d87"><span class="sc">func (c *</span><span class="sc2">Posv</span><span class="sc">) APIs(chain consensus.ChainReader) []rpc.API {</span></div>
<div class="l li"><span class="si">    return []rpc.API{{</span></div>
<div class="l lc d88"><span class="sc">        Namespace: &quot;</span><span class="sc2">posv</span><span class="sc">&quot;,</span></div>
<div class="l li"><span class="si">        Version:   &quot;1.0&quot;,</span></div>
<div class="l lc d89"><span class="sc">        Service:   &amp;API{chain: chain, </span><span class="sc2">posv</span><span class="sc">: c},</span></div>
<div class="l li"><span class="si">        Public:    false,</span></div>
<div class="l li"><span class="si">    }}</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">func (c *Posv) RecoverSigner(header *types.Header) (common.Address, error) {</span></div>
<div class="l ld d90"><span class="sd">    return ecrecover(header, c.signatures)</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">func (c *Posv) RecoverValidator(header *types.Header) (common.Address, error) {</span></div>
<div class="l ld d90"><span class="sd">    // If the signature's already cached, return that</span></div>
<div class="l ld d90"><span class="sd">    hash := header.Hash()</span></div>
<div class="l ld d90"><span class="sd">    if address, known := c.validatorSignatures.Get(hash); known {</span></div>
<div class="l ld d90"><span class="sd">        return address.(common.Address), nil</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    // Retrieve the signature from the header.Validator</span></div>
<div class="l ld d90"><span class="sd">    // len equals 65 bytes</span></div>
<div class="l ld d90"><span class="sd">    if len(header.Validator) != extraSeal {</span></div>
<div class="l ld d90"><span class="sd">        return common.Address{}, consensus.ErrFailValidatorSignature</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    // Recover the public key and the Ethereum address</span></div>
<div class="l ld d90"><span class="sd">    pubkey, err := crypto.Ecrecover(sigHash(header).Bytes(), header.Validator)</span></div>
<div class="l ld d90"><span class="sd">    if err != nil {</span></div>
<div class="l ld d90"><span class="sd">        return common.Address{}, err</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    var signer common.Address</span></div>
<div class="l ld d90"><span class="sd">    copy(signer[:], crypto.Keccak256(pubkey[1:])[12:])</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">    c.validatorSignatures.Add(hash, signer)</span></div>
<div class="l ld d90"><span class="sd">    return signer, nil</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">// Get master nodes over extra data of previous checkpoint block.</span></div>
<div class="l ld d90"><span class="sd">func (c *Posv) GetMasternodesFromCheckpointHeader(preCheckpointHeader *types.Header, n, e uint64) []common.Address {</span></div>
<div class="l ld d90"><span class="sd">    if preCheckpointHeader == nil {</span></div>
<div class="l ld d90"><span class="sd">        log.Info(&quot;Previous checkpoint's header is empty&quot;, &quot;block number&quot;, n, &quot;epoch&quot;, e)</span></div>
<div class="l ld d90"><span class="sd">        return []common.Address{}</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    masternodes := make([]common.Address, (len(preCheckpointHeader.Extra)-extraVanity-extraSeal)/common.AddressLength)</span></div>
<div class="l ld d90"><span class="sd">    for i := 0; i &lt; len(masternodes); i++ {</span></div>
<div class="l ld d90"><span class="sd">        copy(masternodes[i][:], preCheckpointHeader.Extra[extraVanity+i*common.AddressLength:])</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    return masternodes</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">// Extract validators from byte array.</span></div>
<div class="l ld d90"><span class="sd">func RemovePenaltiesFromBlock(chain consensus.ChainReader, signers []common.Address, epochNumber uint64) []common.Address {</span></div>
<div class="l ld d90"><span class="sd">    if epochNumber &lt;= 0 {</span></div>
<div class="l ld d90"><span class="sd">        return signers</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    header := chain.GetHeaderByNumber(epochNumber)</span></div>
<div class="l ld d90"><span class="sd">    block := chain.GetBlock(header.Hash(), epochNumber)</span></div>
<div class="l ld d90"><span class="sd">    penalties := block.Penalties()</span></div>
<div class="l ld d90"><span class="sd">    if penalties != nil {</span></div>
<div class="l ld d90"><span class="sd">        prevPenalties := common.ExtractAddressFromBytes(penalties)</span></div>
<div class="l ld d90"><span class="sd">        signers = common.RemoveItemFromArray(signers, prevPenalties)</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    return signers</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">// Get masternodes address from checkpoint Header.</span></div>
<div class="l ld d90"><span class="sd">func GetMasternodesFromCheckpointHeader(checkpointHeader *types.Header) []common.Address {</span></div>
<div class="l ld d90"><span class="sd">    masternodes := make([]common.Address, (len(checkpointHeader.Extra)-extraVanity-extraSeal)/common.AddressLength)</span></div>
<div class="l ld d90"><span class="sd">    for i := 0; i &lt; len(masternodes); i++ {</span></div>
<div class="l ld d90"><span class="sd">        copy(masternodes[i][:], checkpointHeader.Extra[extraVanity+i*common.AddressLength:])</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    return masternodes</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">// Get m2 list from checkpoint block.</span></div>
<div class="l ld d90"><span class="sd">func GetM1M2FromCheckpointHeader(checkpointHeader *types.Header) (map[common.Address]common.Address, error) {</span></div>
<div class="l ld d90"><span class="sd">    if checkpointHeader.Number.Uint64()%common.EpocBlockRandomize != 0 {</span></div>
<div class="l ld d90"><span class="sd">        return nil, errors.New(&quot;This block is not checkpoint block epoc.&quot;)</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    m1m2 := map[common.Address]common.Address{}</span></div>
<div class="l ld d90"><span class="sd">    // Get signers from this block.</span></div>
<div class="l ld d90"><span class="sd">    masternodes := GetMasternodesFromCheckpointHeader(checkpointHeader)</span></div>
<div class="l ld d90"><span class="sd">    validators := ExtractValidatorsFromBytes(checkpointHeader.Validators)</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">    if len(validators) &lt; len(masternodes) {</span></div>
<div class="l ld d90"><span class="sd">        return nil, errors.New(&quot;len(m2) is less than len(m1)&quot;)</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    if len(masternodes) &gt; 0 {</span></div>
<div class="l ld d90"><span class="sd">        for i, m1 := range masternodes {</span></div>
<div class="l ld d90"><span class="sd">            m1m2[m1] = masternodes[validators[i]%int64(len(masternodes))]</span></div>
<div class="l ld d90"><span class="sd">        }</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l ld d90"><span class="sd">    return m1m2, nil</span></div>
<div class="l ld d90"><span class="sd">}</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">// Extract validators from byte array.</span></div>
<div class="l ld d90"><span class="sd">func ExtractValidatorsFromBytes(byteValidators []byte) []int64 {</span></div>
<div class="l ld d90"><span class="sd">    lenValidator := len(byteValidators) / M2ByteLength</span></div>
<div class="l ld d90"><span class="sd">    var validators []int64</span></div>
<div class="l ld d90"><span class="sd">    for i := 0; i &lt; lenValidator; i++ {</span></div>
<div class="l ld d90"><span class="sd">        trimByte := bytes.Trim(byteValidators[i*M2ByteLength:(i+1)*M2ByteLength], &quot;\x00&quot;)</span></div>
<div class="l ld d90"><span class="sd">        intNumber, err := strconv.Atoi(string(trimByte))</span></div>
<div class="l ld d90"><span class="sd">        if err != nil {</span></div>
<div class="l ld d90"><span class="sd">            log.Error(&quot;Can not convert string to integer&quot;, &quot;error&quot;, err)</span></div>
<div class="l ld d90"><span class="sd">            return []int64{}</span></div>
<div class="l ld d90"><span class="sd">        }</span></div>
<div class="l ld d90"><span class="sd">        validators = append(validators, int64(intNumber))</span></div>
<div class="l ld d90"><span class="sd">    }</span></div>
<div class="l lg d90"> </div>
<div class="l ld d90"><span class="sd">    return validators</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>

                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="pane2" class="pane" style="">
                <div id="title2" class="title" style="" title="https://raw.githubusercontent.com/ethereum/go-ethereum/master/consensus/clique/clique.go">https://raw.githubusercontent.com/ethereum/go-ethereum/master/consensus/clique/clique.go</div>
                <div id="file2" class="file" style=" ">
                    <table class="panes">
                        <tr>
                            <td class="diffBar" style="display: none;">
                                <div class="diffs"></div>
                            </td>
                            <td class="nums">
                                <div class="num">  1 </div>
<div class="num">  2 </div>
<div class="num">  3 </div>
<div class="num">  4 </div>
<div class="num">  5 </div>
<div class="num">  6 </div>
<div class="num">  7 </div>
<div class="num">  8 </div>
<div class="num">  9 </div>
<div class="num"> 10 </div>
<div class="num"> 11 </div>
<div class="num"> 12 </div>
<div class="num"> 13 </div>
<div class="num"> 14 </div>
<div class="num"> 15 </div>
<div class="num"> 16 </div>
<div class="num"> 17 </div>
<div class="num"> 18 </div>
<div class="num"> 19 </div>
<div class="num"> 20 </div>
<div class="num"> 21 </div>
<div class="num"> 22 </div>
<div class="num">    </div>
<div class="num"> 23 </div>
<div class="num"> 24 </div>
<div class="num">    </div>
<div class="num"> 25 </div>
<div class="num"> 26 </div>
<div class="num"> 27 </div>
<div class="num"> 28 </div>
<div class="num"> 29 </div>
<div class="num"> 30 </div>
<div class="num"> 31 </div>
<div class="num">    </div>
<div class="num"> 32 </div>
<div class="num"> 33 </div>
<div class="num"> 34 </div>
<div class="num"> 35 </div>
<div class="num"> 36 </div>
<div class="num"> 37 </div>
<div class="num"> 38 </div>
<div class="num"> 39 </div>
<div class="num"> 40 </div>
<div class="num"> 41 </div>
<div class="num"> 42 </div>
<div class="num"> 43 </div>
<div class="num"> 44 </div>
<div class="num"> 45 </div>
<div class="num"> 46 </div>
<div class="num"> 47 </div>
<div class="num"> 48 </div>
<div class="num"> 49 </div>
<div class="num"> 50 </div>
<div class="num">    </div>
<div class="num"> 51 </div>
<div class="num"> 52 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num"> 53 </div>
<div class="num"> 54 </div>
<div class="num"> 55 </div>
<div class="num">    </div>
<div class="num"> 56 </div>
<div class="num"> 57 </div>
<div class="num"> 58 </div>
<div class="num"> 59 </div>
<div class="num"> 60 </div>
<div class="num"> 61 </div>
<div class="num"> 62 </div>
<div class="num"> 63 </div>
<div class="num"> 64 </div>
<div class="num"> 65 </div>
<div class="num"> 66 </div>
<div class="num"> 67 </div>
<div class="num"> 68 </div>
<div class="num"> 69 </div>
<div class="num"> 70 </div>
<div class="num"> 71 </div>
<div class="num"> 72 </div>
<div class="num"> 73 </div>
<div class="num"> 74 </div>
<div class="num"> 75 </div>
<div class="num"> 76 </div>
<div class="num"> 77 </div>
<div class="num"> 78 </div>
<div class="num"> 79 </div>
<div class="num"> 80 </div>
<div class="num"> 81 </div>
<div class="num"> 82 </div>
<div class="num"> 83 </div>
<div class="num"> 84 </div>
<div class="num"> 85 </div>
<div class="num"> 86 </div>
<div class="num"> 87 </div>
<div class="num"> 88 </div>
<div class="num"> 89 </div>
<div class="num"> 90 </div>
<div class="num"> 91 </div>
<div class="num"> 92 </div>
<div class="num"> 93 </div>
<div class="num"> 94 </div>
<div class="num"> 95 </div>
<div class="num"> 96 </div>
<div class="num"> 97 </div>
<div class="num"> 98 </div>
<div class="num"> 99 </div>
<div class="num">100 </div>
<div class="num">101 </div>
<div class="num">102 </div>
<div class="num">103 </div>
<div class="num">    </div>
<div class="num">104 </div>
<div class="num">105 </div>
<div class="num">106 </div>
<div class="num">107 </div>
<div class="num">108 </div>
<div class="num">109 </div>
<div class="num">110 </div>
<div class="num">111 </div>
<div class="num">112 </div>
<div class="num">113 </div>
<div class="num">114 </div>
<div class="num">115 </div>
<div class="num">116 </div>
<div class="num">    </div>
<div class="num">117 </div>
<div class="num">118 </div>
<div class="num">119 </div>
<div class="num">120 </div>
<div class="num">121 </div>
<div class="num">122 </div>
<div class="num">123 </div>
<div class="num">124 </div>
<div class="num">125 </div>
<div class="num">126 </div>
<div class="num">127 </div>
<div class="num">128 </div>
<div class="num">129 </div>
<div class="num">130 </div>
<div class="num">131 </div>
<div class="num">132 </div>
<div class="num">133 </div>
<div class="num">134 </div>
<div class="num">135 </div>
<div class="num">136 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">137 </div>
<div class="num">138 </div>
<div class="num">139 </div>
<div class="num">140 </div>
<div class="num">141 </div>
<div class="num">142 </div>
<div class="num">143 </div>
<div class="num">144 </div>
<div class="num">145 </div>
<div class="num">146 </div>
<div class="num">147 </div>
<div class="num">148 </div>
<div class="num">149 </div>
<div class="num">150 </div>
<div class="num">151 </div>
<div class="num">152 </div>
<div class="num">153 </div>
<div class="num">154 </div>
<div class="num">155 </div>
<div class="num">156 </div>
<div class="num">157 </div>
<div class="num">158 </div>
<div class="num">159 </div>
<div class="num">160 </div>
<div class="num">161 </div>
<div class="num">162 </div>
<div class="num">163 </div>
<div class="num">164 </div>
<div class="num">165 </div>
<div class="num">166 </div>
<div class="num">167 </div>
<div class="num">168 </div>
<div class="num">169 </div>
<div class="num">170 </div>
<div class="num">171 </div>
<div class="num">172 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">173 </div>
<div class="num">174 </div>
<div class="num">175 </div>
<div class="num">176 </div>
<div class="num">177 </div>
<div class="num">178 </div>
<div class="num">179 </div>
<div class="num">180 </div>
<div class="num">181 </div>
<div class="num">182 </div>
<div class="num">183 </div>
<div class="num">184 </div>
<div class="num">185 </div>
<div class="num">186 </div>
<div class="num">187 </div>
<div class="num">188 </div>
<div class="num">189 </div>
<div class="num">190 </div>
<div class="num">191 </div>
<div class="num">192 </div>
<div class="num">193 </div>
<div class="num">194 </div>
<div class="num">195 </div>
<div class="num">196 </div>
<div class="num">197 </div>
<div class="num">198 </div>
<div class="num">199 </div>
<div class="num">200 </div>
<div class="num">201 </div>
<div class="num">202 </div>
<div class="num">203 </div>
<div class="num">204 </div>
<div class="num">205 </div>
<div class="num">206 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">207 </div>
<div class="num">208 </div>
<div class="num">209 </div>
<div class="num">210 </div>
<div class="num">211 </div>
<div class="num">212 </div>
<div class="num">213 </div>
<div class="num">214 </div>
<div class="num">215 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">216 </div>
<div class="num">217 </div>
<div class="num">218 </div>
<div class="num">219 </div>
<div class="num">220 </div>
<div class="num">221 </div>
<div class="num">222 </div>
<div class="num">223 </div>
<div class="num">224 </div>
<div class="num">225 </div>
<div class="num">226 </div>
<div class="num">227 </div>
<div class="num">228 </div>
<div class="num">229 </div>
<div class="num">230 </div>
<div class="num">    </div>
<div class="num">231 </div>
<div class="num">232 </div>
<div class="num">233 </div>
<div class="num">234 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">235 </div>
<div class="num">236 </div>
<div class="num">237 </div>
<div class="num">238 </div>
<div class="num">239 </div>
<div class="num">240 </div>
<div class="num">241 </div>
<div class="num">242 </div>
<div class="num">243 </div>
<div class="num">244 </div>
<div class="num">245 </div>
<div class="num">246 </div>
<div class="num">247 </div>
<div class="num">248 </div>
<div class="num">249 </div>
<div class="num">250 </div>
<div class="num">251 </div>
<div class="num">252 </div>
<div class="num">253 </div>
<div class="num">254 </div>
<div class="num">255 </div>
<div class="num">256 </div>
<div class="num">257 </div>
<div class="num">258 </div>
<div class="num">259 </div>
<div class="num">260 </div>
<div class="num">261 </div>
<div class="num">262 </div>
<div class="num">263 </div>
<div class="num">264 </div>
<div class="num">265 </div>
<div class="num">266 </div>
<div class="num">267 </div>
<div class="num">268 </div>
<div class="num">269 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">270 </div>
<div class="num">271 </div>
<div class="num">272 </div>
<div class="num">273 </div>
<div class="num">274 </div>
<div class="num">275 </div>
<div class="num">276 </div>
<div class="num">277 </div>
<div class="num">278 </div>
<div class="num">279 </div>
<div class="num">280 </div>
<div class="num">281 </div>
<div class="num">282 </div>
<div class="num">283 </div>
<div class="num">284 </div>
<div class="num">285 </div>
<div class="num">286 </div>
<div class="num">287 </div>
<div class="num">288 </div>
<div class="num">289 </div>
<div class="num">    </div>
<div class="num">290 </div>
<div class="num">291 </div>
<div class="num">292 </div>
<div class="num">293 </div>
<div class="num">294 </div>
<div class="num">295 </div>
<div class="num">296 </div>
<div class="num">297 </div>
<div class="num">298 </div>
<div class="num">299 </div>
<div class="num">300 </div>
<div class="num">301 </div>
<div class="num">302 </div>
<div class="num">303 </div>
<div class="num">304 </div>
<div class="num">305 </div>
<div class="num">306 </div>
<div class="num">307 </div>
<div class="num">308 </div>
<div class="num">309 </div>
<div class="num">310 </div>
<div class="num">311 </div>
<div class="num">312 </div>
<div class="num">313 </div>
<div class="num">314 </div>
<div class="num">315 </div>
<div class="num">316 </div>
<div class="num">317 </div>
<div class="num">318 </div>
<div class="num">319 </div>
<div class="num">320 </div>
<div class="num">321 </div>
<div class="num">322 </div>
<div class="num">323 </div>
<div class="num">324 </div>
<div class="num">325 </div>
<div class="num">326 </div>
<div class="num">327 </div>
<div class="num">328 </div>
<div class="num">329 </div>
<div class="num">330 </div>
<div class="num">331 </div>
<div class="num">332 </div>
<div class="num">333 </div>
<div class="num">334 </div>
<div class="num">335 </div>
<div class="num">336 </div>
<div class="num">337 </div>
<div class="num">338 </div>
<div class="num">339 </div>
<div class="num">340 </div>
<div class="num">341 </div>
<div class="num">342 </div>
<div class="num">343 </div>
<div class="num">344 </div>
<div class="num">345 </div>
<div class="num">346 </div>
<div class="num">347 </div>
<div class="num">348 </div>
<div class="num">349 </div>
<div class="num">350 </div>
<div class="num">351 </div>
<div class="num">352 </div>
<div class="num">353 </div>
<div class="num">354 </div>
<div class="num">355 </div>
<div class="num">356 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">357 </div>
<div class="num">358 </div>
<div class="num">359 </div>
<div class="num">360 </div>
<div class="num">361 </div>
<div class="num">362 </div>
<div class="num">363 </div>
<div class="num">364 </div>
<div class="num">365 </div>
<div class="num">366 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">367 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">368 </div>
<div class="num">369 </div>
<div class="num">370 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">371 </div>
<div class="num">372 </div>
<div class="num">373 </div>
<div class="num">374 </div>
<div class="num">375 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">376 </div>
<div class="num">377 </div>
<div class="num">378 </div>
<div class="num">379 </div>
<div class="num">380 </div>
<div class="num">381 </div>
<div class="num">382 </div>
<div class="num">383 </div>
<div class="num">384 </div>
<div class="num">385 </div>
<div class="num">386 </div>
<div class="num">387 </div>
<div class="num">388 </div>
<div class="num">389 </div>
<div class="num">390 </div>
<div class="num">391 </div>
<div class="num">    </div>
<div class="num">392 </div>
<div class="num">393 </div>
<div class="num">394 </div>
<div class="num">395 </div>
<div class="num">396 </div>
<div class="num">397 </div>
<div class="num">398 </div>
<div class="num">399 </div>
<div class="num">400 </div>
<div class="num">401 </div>
<div class="num">402 </div>
<div class="num">403 </div>
<div class="num">404 </div>
<div class="num">405 </div>
<div class="num">406 </div>
<div class="num">407 </div>
<div class="num">408 </div>
<div class="num">409 </div>
<div class="num">410 </div>
<div class="num">411 </div>
<div class="num">412 </div>
<div class="num">413 </div>
<div class="num">414 </div>
<div class="num">415 </div>
<div class="num">416 </div>
<div class="num">417 </div>
<div class="num">418 </div>
<div class="num">419 </div>
<div class="num">420 </div>
<div class="num">421 </div>
<div class="num">422 </div>
<div class="num">423 </div>
<div class="num">424 </div>
<div class="num">425 </div>
<div class="num">426 </div>
<div class="num">427 </div>
<div class="num">428 </div>
<div class="num">429 </div>
<div class="num">430 </div>
<div class="num">431 </div>
<div class="num">432 </div>
<div class="num">433 </div>
<div class="num">434 </div>
<div class="num">435 </div>
<div class="num">436 </div>
<div class="num">437 </div>
<div class="num">438 </div>
<div class="num">439 </div>
<div class="num">440 </div>
<div class="num">441 </div>
<div class="num">442 </div>
<div class="num">443 </div>
<div class="num">444 </div>
<div class="num">445 </div>
<div class="num">446 </div>
<div class="num">447 </div>
<div class="num">448 </div>
<div class="num">449 </div>
<div class="num">450 </div>
<div class="num">451 </div>
<div class="num">452 </div>
<div class="num">453 </div>
<div class="num">454 </div>
<div class="num">455 </div>
<div class="num">456 </div>
<div class="num">457 </div>
<div class="num">458 </div>
<div class="num">459 </div>
<div class="num">460 </div>
<div class="num">461 </div>
<div class="num">462 </div>
<div class="num">463 </div>
<div class="num">464 </div>
<div class="num">465 </div>
<div class="num">466 </div>
<div class="num">467 </div>
<div class="num">468 </div>
<div class="num">469 </div>
<div class="num">470 </div>
<div class="num">471 </div>
<div class="num">472 </div>
<div class="num">473 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">474 </div>
<div class="num">475 </div>
<div class="num">476 </div>
<div class="num">477 </div>
<div class="num">478 </div>
<div class="num">479 </div>
<div class="num">480 </div>
<div class="num">481 </div>
<div class="num">482 </div>
<div class="num">483 </div>
<div class="num">484 </div>
<div class="num">485 </div>
<div class="num">486 </div>
<div class="num">487 </div>
<div class="num">488 </div>
<div class="num">489 </div>
<div class="num">490 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">491 </div>
<div class="num">492 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">493 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">494 </div>
<div class="num">495 </div>
<div class="num">496 </div>
<div class="num">    </div>
<div class="num">497 </div>
<div class="num">498 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">499 </div>
<div class="num">500 </div>
<div class="num">501 </div>
<div class="num">502 </div>
<div class="num">503 </div>
<div class="num">504 </div>
<div class="num">505 </div>
<div class="num">506 </div>
<div class="num">507 </div>
<div class="num">508 </div>
<div class="num">509 </div>
<div class="num">510 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">511 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">512 </div>
<div class="num">513 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">514 </div>
<div class="num">515 </div>
<div class="num">516 </div>
<div class="num">517 </div>
<div class="num">518 </div>
<div class="num">519 </div>
<div class="num">520 </div>
<div class="num">521 </div>
<div class="num">522 </div>
<div class="num">523 </div>
<div class="num">524 </div>
<div class="num">525 </div>
<div class="num">526 </div>
<div class="num">527 </div>
<div class="num">528 </div>
<div class="num">529 </div>
<div class="num">530 </div>
<div class="num">531 </div>
<div class="num">532 </div>
<div class="num">533 </div>
<div class="num">534 </div>
<div class="num">535 </div>
<div class="num">536 </div>
<div class="num">537 </div>
<div class="num">538 </div>
<div class="num">539 </div>
<div class="num">540 </div>
<div class="num">541 </div>
<div class="num">542 </div>
<div class="num">543 </div>
<div class="num">544 </div>
<div class="num">545 </div>
<div class="num">546 </div>
<div class="num">547 </div>
<div class="num">548 </div>
<div class="num">549 </div>
<div class="num">550 </div>
<div class="num">551 </div>
<div class="num">552 </div>
<div class="num">553 </div>
<div class="num">554 </div>
<div class="num">555 </div>
<div class="num">556 </div>
<div class="num">    </div>
<div class="num">557 </div>
<div class="num">558 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">559 </div>
<div class="num">560 </div>
<div class="num">561 </div>
<div class="num">562 </div>
<div class="num">563 </div>
<div class="num">564 </div>
<div class="num">565 </div>
<div class="num">566 </div>
<div class="num">567 </div>
<div class="num">568 </div>
<div class="num">569 </div>
<div class="num">570 </div>
<div class="num">571 </div>
<div class="num">572 </div>
<div class="num">573 </div>
<div class="num">574 </div>
<div class="num">575 </div>
<div class="num">576 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">577 </div>
<div class="num">578 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">579 </div>
<div class="num">580 </div>
<div class="num">581 </div>
<div class="num">582 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">583 </div>
<div class="num">584 </div>
<div class="num">585 </div>
<div class="num">586 </div>
<div class="num">587 </div>
<div class="num">588 </div>
<div class="num">589 </div>
<div class="num">590 </div>
<div class="num">591 </div>
<div class="num">592 </div>
<div class="num">593 </div>
<div class="num">594 </div>
<div class="num">595 </div>
<div class="num">596 </div>
<div class="num">597 </div>
<div class="num">598 </div>
<div class="num">599 </div>
<div class="num">600 </div>
<div class="num">601 </div>
<div class="num">602 </div>
<div class="num">603 </div>
<div class="num">604 </div>
<div class="num">605 </div>
<div class="num">606 </div>
<div class="num">607 </div>
<div class="num">608 </div>
<div class="num">609 </div>
<div class="num">610 </div>
<div class="num">611 </div>
<div class="num">612 </div>
<div class="num">613 </div>
<div class="num">614 </div>
<div class="num">615 </div>
<div class="num">616 </div>
<div class="num">617 </div>
<div class="num">618 </div>
<div class="num">619 </div>
<div class="num">620 </div>
<div class="num">621 </div>
<div class="num">622 </div>
<div class="num">623 </div>
<div class="num">624 </div>
<div class="num">625 </div>
<div class="num">    </div>
<div class="num">626 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">627 </div>
<div class="num">    </div>
<div class="num">628 </div>
<div class="num">629 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">630 </div>
<div class="num">631 </div>
<div class="num">632 </div>
<div class="num">    </div>
<div class="num">633 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">634 </div>
<div class="num">    </div>
<div class="num">635 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">636 </div>
<div class="num">637 </div>
<div class="num">638 </div>
<div class="num">639 </div>
<div class="num">640 </div>
<div class="num">641 </div>
<div class="num">642 </div>
<div class="num">643 </div>
<div class="num">644 </div>
<div class="num">645 </div>
<div class="num">646 </div>
<div class="num">647 </div>
<div class="num">648 </div>
<div class="num">649 </div>
<div class="num">650 </div>
<div class="num">651 </div>
<div class="num">652 </div>
<div class="num">653 </div>
<div class="num">    </div>
<div class="num">654 </div>
<div class="num">655 </div>
<div class="num">656 </div>
<div class="num">657 </div>
<div class="num">658 </div>
<div class="num">659 </div>
<div class="num">660 </div>
<div class="num">661 </div>
<div class="num">662 </div>
<div class="num">663 </div>
<div class="num">664 </div>
<div class="num">665 </div>
<div class="num">666 </div>
<div class="num">667 </div>
<div class="num">668 </div>
<div class="num">669 </div>
<div class="num">670 </div>
<div class="num">671 </div>
<div class="num">672 </div>
<div class="num">673 </div>
<div class="num">674 </div>
<div class="num">675 </div>
<div class="num">676 </div>
<div class="num">677 </div>
<div class="num">678 </div>
<div class="num">679 </div>
<div class="num">680 </div>
<div class="num">681 </div>
<div class="num">682 </div>
<div class="num">683 </div>
<div class="num">684 </div>
<div class="num">685 </div>
<div class="num">686 </div>
<div class="num">687 </div>
<div class="num">688 </div>
<div class="num">689 </div>
<div class="num">690 </div>
<div class="num">691 </div>
<div class="num">692 </div>
<div class="num">693 </div>
<div class="num">694 </div>
<div class="num">695 </div>
<div class="num">696 </div>
<div class="num">697 </div>
<div class="num">698 </div>
<div class="num">699 </div>
<div class="num">700 </div>
<div class="num">701 </div>
<div class="num">702 </div>
<div class="num">703 </div>
<div class="num">704 </div>
<div class="num">705 </div>
<div class="num">706 </div>
<div class="num">707 </div>
<div class="num">708 </div>
<div class="num">709 </div>
<div class="num">710 </div>
<div class="num">711 </div>
<div class="num">712 </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">    </div>
<div class="num">713 </div>
<div class="num">714 </div>

                            </td>
                            <td class="content">
                                <div class="l lc d1"><span class="sc">// Copyright </span><span class="sc2">2017 The go-ethereum Authors</span></div>
<div class="l lc d1"><span class="sa">// This file is part of the go-ethereum library.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l lc d2"><span class="sc">// </span><span class="sc2">The go-ethereum library</span><span class="sc"> is free software: you can redistribute it and/or modify</span></div>
<div class="l li"><span class="si">// it under the terms of the GNU Lesser General Public License as published by</span></div>
<div class="l li"><span class="si">// the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="l li"><span class="si">// (at your option) any later version.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l lc d3"><span class="sc">// </span><span class="sc2">The go-ethereum library</span><span class="sc"> is distributed in the hope that it will be useful,</span></div>
<div class="l li"><span class="si">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="l li"><span class="si">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span></div>
<div class="l li"><span class="si">// GNU Lesser General Public License for more details.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l li"><span class="si">// You should have received a copy of the GNU Lesser General Public License</span></div>
<div class="l lc d4"><span class="sc">// along with </span><span class="sc2">the go-ethereum library</span><span class="sc">. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="l lg d4"> </div>
<div class="l lc d4"><span class="sc">// Package </span><span class="sc2">clique</span><span class="sc"> implements the proof-of-</span><span class="sc2">authority</span><span class="sc"> consensus engine.</span></div>
<div class="l lc d4"><span class="sc">package </span><span class="sc2">clique</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">import (</span></div>
<div class="l li"><span class="si">    &quot;bytes&quot;</span></div>
<div class="l li"><span class="si">    &quot;errors&quot;</span></div>
<div class="l ld d5"> </div>
<div class="l li"><span class="si">    &quot;math/big&quot;</span></div>
<div class="l li"><span class="si">    &quot;math/rand&quot;</span></div>
<div class="l ld d6"> </div>
<div class="l li"><span class="si">    &quot;sync&quot;</span></div>
<div class="l li"><span class="si">    &quot;time&quot;</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/accounts&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/common&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/common/hexutil&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/consensus&quot;</span></div>
<div class="l ld d7"> </div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/consensus/misc&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/core/state&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/core/types&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/crypto&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/crypto/sha3&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/ethdb&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/log&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/params&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/rlp&quot;</span></div>
<div class="l li"><span class="si">    &quot;github.com/ethereum/go-ethereum/rpc&quot;</span></div>
<div class="l lc d8"><span class="sc">    </span><span class="sa">lru</span><span class="sc"> &quot;github.com/hashicorp/golang-lru&quot;</span></div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">const (</span></div>
<div class="l la d9"><span class="sa">    checkpointInterval = 1024 // Number of blocks after which to save the vote snapshot to the database</span></div>
<div class="l li"><span class="si">    inmemorySnapshots  = 128  // Number of recent vote snapshots to keep in memory</span></div>
<div class="l li"><span class="si">    inmemorySignatures = 4096 // Number of recent block signatures to keep in memory</span></div>
<div class="l lg"> </div>
<div class="l li"><span class="si">    wiggleTime = 500 * time.Millisecond // Random delay (per signer) to allow concurrent signers</span></div>
<div class="l ld d10"> </div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l lc d11"> </div>
<div class="l lc d11"> </div>
<div class="l lc d11"> </div>
<div class="l lc d11"> </div>
<div class="l lc d11"> </div>
<div class="l lc d11"><span class="sc">// </span><span class="sc2">Clique</span><span class="sc"> proof-of-</span><span class="sc2">authority</span><span class="sc"> protocol constants.</span></div>
<div class="l li"><span class="si">var (</span></div>
<div class="l li"><span class="si">    epochLength = uint64(30000) // Default number of blocks after which to checkpoint and reset the pending votes</span></div>
<div class="l ld d12"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">    extraVanity = 32 // Fixed number of extra-data prefix bytes reserved for signer vanity</span></div>
<div class="l li"><span class="si">    extraSeal   = 65 // Fixed number of extra-data suffix bytes reserved for signer seal</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    nonceAuthVote = hexutil.MustDecode(&quot;0xffffffffffffffff&quot;) // Magic nonce number to vote on adding a new signer</span></div>
<div class="l li"><span class="si">    nonceDropVote = hexutil.MustDecode(&quot;0x0000000000000000&quot;) // Magic nonce number to vote on removing a signer.</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    uncleHash = types.CalcUncleHash(nil) // Always Keccak256(RLP([])) as uncles are meaningless outside of PoW.</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    diffInTurn = big.NewInt(2) // Block difficulty for in-turn signatures</span></div>
<div class="l li"><span class="si">    diffNoTurn = big.NewInt(1) // Block difficulty for out-of-turn signatures</span></div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Various error messages to mark blocks invalid. These should be private to</span></div>
<div class="l li"><span class="si">// prevent engine specific errors from being referenced in the remainder of the</span></div>
<div class="l li"><span class="si">// codebase, inherently breaking if the engine is swapped out. Please put common</span></div>
<div class="l li"><span class="si">// error types into the consensus package.</span></div>
<div class="l li"><span class="si">var (</span></div>
<div class="l li"><span class="si">    // errUnknownBlock is returned when the list of signers is requested for a block</span></div>
<div class="l li"><span class="si">    // that is not part of the local blockchain.</span></div>
<div class="l li"><span class="si">    errUnknownBlock = errors.New(&quot;unknown block&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidCheckpointBeneficiary is returned if a checkpoint/epoch transition</span></div>
<div class="l li"><span class="si">    // block has a beneficiary set to non-zeroes.</span></div>
<div class="l li"><span class="si">    errInvalidCheckpointBeneficiary = errors.New(&quot;beneficiary in checkpoint block non-zero&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidVote is returned if a nonce value is something else that the two</span></div>
<div class="l li"><span class="si">    // allowed constants of 0x00..0 or 0xff..f.</span></div>
<div class="l li"><span class="si">    errInvalidVote = errors.New(&quot;vote nonce not 0x00..0 or 0xff..f&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidCheckpointVote is returned if a checkpoint/epoch transition block</span></div>
<div class="l li"><span class="si">    // has a vote nonce set to non-zeroes.</span></div>
<div class="l li"><span class="si">    errInvalidCheckpointVote = errors.New(&quot;vote nonce in checkpoint block non-zero&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errMissingVanity is returned if a block's extra-data section is shorter than</span></div>
<div class="l li"><span class="si">    // 32 bytes, which is required to store the signer vanity.</span></div>
<div class="l li"><span class="si">    errMissingVanity = errors.New(&quot;extra-data 32 byte vanity prefix missing&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errMissingSignature is returned if a block's extra-data section doesn't seem</span></div>
<div class="l li"><span class="si">    // to contain a 65 byte secp256k1 signature.</span></div>
<div class="l lc d13"><span class="sc">    errMissingSignature = errors.New(&quot;extra-data 65 byte signature </span><span class="sa">suffix</span><span class="sc"> missing&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errExtraSigners is returned if non-checkpoint block contain signer data in</span></div>
<div class="l li"><span class="si">    // their extra-data fields.</span></div>
<div class="l li"><span class="si">    errExtraSigners = errors.New(&quot;non-checkpoint block contains extra signer list&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidCheckpointSigners is returned if a checkpoint block contains an</span></div>
<div class="l lc d14"><span class="sc">    // invalid list of signers (i.e. non divisible by 20 bytes</span><span class="sc2">).</span></div>
<div class="l lc d14"> </div>
<div class="l li"><span class="si">    errInvalidCheckpointSigners = errors.New(&quot;invalid signer list on checkpoint block&quot;)</span></div>
<div class="l li"> </div>
<div class="l lc d15"><span class="sc">    </span><span class="sa">// errMismatchingCheckpointSigners is returned if a checkpoint block contains a</span></div>
<div class="l lc d15"><span class="sc">    </span><span class="sa">// list of signers different than the one the local node calculated.</span></div>
<div class="l lc d15"><span class="sc">    </span><span class="sc2">errMismatchingCheckpointSigners</span><span class="sc"> = errors.New(&quot;</span><span class="sc2">mismatching signer</span><span class="sc"> list on checkpoint block&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidMixDigest is returned if a block's mix digest is non-zero.</span></div>
<div class="l li"><span class="si">    errInvalidMixDigest = errors.New(&quot;non-zero mix digest&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidUncleHash is returned if a block contains an non-empty uncle list.</span></div>
<div class="l li"><span class="si">    errInvalidUncleHash = errors.New(&quot;non empty uncle hash&quot;)</span></div>
<div class="l li"> </div>
<div class="l lc d16"><span class="sc">    // errInvalidDifficulty is returned if the difficulty of a block </span><span class="sc2">neither</span><span class="sc"> </span><span class="sa">1 or 2.</span></div>
<div class="l lc d16"> </div>
<div class="l li"><span class="si">    errInvalidDifficulty = errors.New(&quot;invalid difficulty&quot;)</span></div>
<div class="l lg"> </div>
<div class="l la d17"><span class="sa">    // errWrongDifficulty is returned if the difficulty of a block doesn't match the</span></div>
<div class="l la d17"><span class="sa">    // turn of the signer.</span></div>
<div class="l la d17"><span class="sa">    errWrongDifficulty = errors.New(&quot;wrong difficulty&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // ErrInvalidTimestamp is returned if the timestamp of a block is lower than</span></div>
<div class="l li"><span class="si">    // the previous block's timestamp + the minimum block period.</span></div>
<div class="l li"><span class="si">    ErrInvalidTimestamp = errors.New(&quot;invalid timestamp&quot;)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // errInvalidVotingChain is returned if an authorization list is attempted to</span></div>
<div class="l li"><span class="si">    // be modified via out-of-range or non-contiguous headers.</span></div>
<div class="l li"><span class="si">    errInvalidVotingChain = errors.New(&quot;invalid voting chain&quot;)</span></div>
<div class="l li"> </div>
<div class="l lc d18"><span class="sc">    // </span><span class="sc2">errUnauthorizedSigner</span><span class="sc"> is returned if a header is signed by a non-authorized entity.</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sc2">errUnauthorizedSigner</span><span class="sc"> = errors.New(&quot;unauthorized </span><span class="sa">signer</span><span class="sc">&quot;)</span></div>
<div class="l lg d18"> </div>
<div class="l lc d18"><span class="sc">    </span><span class="sc2">// errRecentlySigned is returned if a header is signed by an authorized entity</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sa">// that already signed a header recently, thus is temporarily not allowed to.</span></div>
<div class="l lc d18"><span class="sc">    </span><span class="sc2">errRecentlySigned = errors.New(&quot;recently signed&quot;)</span></div>
<div class="l lc d18"> </div>
<div class="l lc d18"> </div>
<div class="l lc d18"> </div>
<div class="l lc d18"> </div>
<div class="l lc d18"> </div>
<div class="l li"><span class="si">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// SignerFn is a signer callback function to request a hash to be signed by a</span></div>
<div class="l li"><span class="si">// backing account.</span></div>
<div class="l lc d19"><span class="sc">type SignerFn func(accounts.Account, []byte) ([]byte, error)</span></div>
<div class="l lg d19"> </div>
<div class="l lc d19"><span class="sc">// sigHash returns the hash which is used as input for the proof-of-</span><span class="sc2">authority</span></div>
<div class="l li"><span class="si">// signing. It is the hash of the entire header apart from the 65 byte signature</span></div>
<div class="l li"><span class="si">// contained at the end of the extra data.</span></div>
<div class="l li"><span class="si">//</span></div>
<div class="l li"><span class="si">// Note, the method requires the extra data to be at least 65 bytes, otherwise it</span></div>
<div class="l li"><span class="si">// panics. This is done to avoid accidentally using both forms (signature present</span></div>
<div class="l li"><span class="si">// or not), which could be abused to produce different hashes for the same header.</span></div>
<div class="l li"><span class="si">func sigHash(header *types.Header) (hash common.Hash) {</span></div>
<div class="l li"><span class="si">    hasher := sha3.NewKeccak256()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    rlp.Encode(hasher, []interface{}{</span></div>
<div class="l li"><span class="si">        header.ParentHash,</span></div>
<div class="l li"><span class="si">        header.UncleHash,</span></div>
<div class="l li"><span class="si">        header.Coinbase,</span></div>
<div class="l li"><span class="si">        header.Root,</span></div>
<div class="l li"><span class="si">        header.TxHash,</span></div>
<div class="l li"><span class="si">        header.ReceiptHash,</span></div>
<div class="l li"><span class="si">        header.Bloom,</span></div>
<div class="l li"><span class="si">        header.Difficulty,</span></div>
<div class="l li"><span class="si">        header.Number,</span></div>
<div class="l li"><span class="si">        header.GasLimit,</span></div>
<div class="l li"><span class="si">        header.GasUsed,</span></div>
<div class="l li"><span class="si">        header.Time,</span></div>
<div class="l li"><span class="si">        header.Extra[:len(header.Extra)-65], // Yes, this will panic if extra is too short</span></div>
<div class="l li"><span class="si">        header.MixDigest,</span></div>
<div class="l li"><span class="si">        header.Nonce,</span></div>
<div class="l li"><span class="si">    })</span></div>
<div class="l li"><span class="si">    hasher.Sum(hash[:0])</span></div>
<div class="l li"><span class="si">    return hash</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l ld d20"> </div>
<div class="l ld d20"> </div>
<div class="l ld d20"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// ecrecover extracts the Ethereum account address from a signed header.</span></div>
<div class="l li"><span class="si">func ecrecover(header *types.Header, sigcache *lru.ARCCache) (common.Address, error) {</span></div>
<div class="l li"><span class="si">    // If the signature's already cached, return that</span></div>
<div class="l li"><span class="si">    hash := header.Hash()</span></div>
<div class="l li"><span class="si">    if address, known := sigcache.Get(hash); known {</span></div>
<div class="l li"><span class="si">        return address.(common.Address), nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Retrieve the signature from the header extra-data</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraSeal {</span></div>
<div class="l li"><span class="si">        return common.Address{}, errMissingSignature</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    signature := header.Extra[len(header.Extra)-extraSeal:]</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Recover the public key and the Ethereum address</span></div>
<div class="l li"><span class="si">    pubkey, err := crypto.Ecrecover(sigHash(header).Bytes(), signature)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return common.Address{}, err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    var signer common.Address</span></div>
<div class="l li"><span class="si">    copy(signer[:], crypto.Keccak256(pubkey[1:])[12:])</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    sigcache.Add(hash, signer)</span></div>
<div class="l li"><span class="si">    return signer, nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l lc d21"><span class="sc">// </span><span class="sc2">Clique</span><span class="sc"> is the proof-of-</span><span class="sc2">authority</span><span class="sc"> consensus engine proposed to support the</span></div>
<div class="l li"><span class="si">// Ethereum testnet following the Ropsten attacks.</span></div>
<div class="l lc d22"><span class="sc">type </span><span class="sc2">Clique</span><span class="sc"> struct {</span></div>
<div class="l lc d22"><span class="sc">    config *params.</span><span class="sc2">CliqueConfig</span><span class="sc"> // Consensus engine configuration parameters</span></div>
<div class="l li"><span class="si">    db     ethdb.Database       // Database to store and retrieve snapshot checkpoints</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    recents    *lru.ARCCache // Snapshots for recent block to speed up reorgs</span></div>
<div class="l li"><span class="si">    signatures *lru.ARCCache // Signatures of recent blocks to speed up mining</span></div>
<div class="l ld d23"> </div>
<div class="l ld d23"> </div>
<div class="l lg"> </div>
<div class="l li"><span class="si">    proposals map[common.Address]bool // Current list of proposals we are pushing</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    signer common.Address // Ethereum address of the signing key</span></div>
<div class="l lc d24"><span class="sc">    signFn SignerFn       // Signer function to authorize hashes with</span></div>
<div class="l li"><span class="si">    lock   sync.RWMutex   // Protects the signer fields</span></div>
<div class="l li"> </div>
<div class="l lc d25"><span class="sc">    </span><span class="sc2">// The fields below are for testing only</span></div>
<div class="l lc d25"><span class="sc">    </span><span class="sc2">fakeDiff bool // Skip difficulty verifications</span></div>
<div class="l lc d25"> </div>
<div class="l lc d25"> </div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l lc d26"><span class="sc">// New creates a </span><span class="sc2">Clique</span><span class="sc"> proof-of-</span><span class="sc2">authority</span><span class="sc"> consensus engine with the initial</span></div>
<div class="l li"><span class="si">// signers set to the ones provided by the user.</span></div>
<div class="l lc d27"><span class="sc">func New(config *params.</span><span class="sc2">CliqueConfig</span><span class="sc">, db ethdb.Database) *</span><span class="sc2">Clique</span><span class="sc"> {</span></div>
<div class="l li"><span class="si">    // Set any missing consensus parameters to their defaults</span></div>
<div class="l li"><span class="si">    conf := *config</span></div>
<div class="l li"><span class="si">    if conf.Epoch == 0 {</span></div>
<div class="l li"><span class="si">        conf.Epoch = epochLength</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Allocate the snapshot caches and create the engine</span></div>
<div class="l li"><span class="si">    recents, _ := lru.NewARC(inmemorySnapshots)</span></div>
<div class="l lc d28"><span class="sc">    signatures, _ := lru.NewARC(</span><span class="sc2">inmemorySignatures</span><span class="sc">)</span></div>
<div class="l lg d28"> </div>
<div class="l lc d28"><span class="sc">    </span><span class="sc2">return &amp;Clique{</span></div>
<div class="l lc d28"> </div>
<div class="l li"><span class="si">        config:     &amp;conf,</span></div>
<div class="l li"><span class="si">        db:         db,</span></div>
<div class="l li"><span class="si">        recents:    recents,</span></div>
<div class="l li"><span class="si">        signatures: signatures,</span></div>
<div class="l ld d29"> </div>
<div class="l ld d29"> </div>
<div class="l li"><span class="si">        proposals:  make(map[common.Address]bool),</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Author implements consensus.Engine, returning the Ethereum address recovered</span></div>
<div class="l li"><span class="si">// from the signature in the header's extra-data section.</span></div>
<div class="l lc d30"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) Author(header *types.Header) (common.Address, error) {</span></div>
<div class="l li"><span class="si">    return ecrecover(header, c.signatures)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifyHeader checks whether a header conforms to the consensus rules.</span></div>
<div class="l lc d31"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) VerifyHeader(chain consensus.ChainReader, header *types.Header, seal bool) error {</span></div>
<div class="l lc d31"><span class="sc">    return c.</span><span class="sc2">verifyHeader</span><span class="sc">(chain, header, nil)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifyHeaders is similar to VerifyHeader, but verifies a batch of headers. The</span></div>
<div class="l li"><span class="si">// method returns a quit channel to abort the operations and a results channel to</span></div>
<div class="l li"><span class="si">// retrieve the async verifications (the order is that of the input slice).</span></div>
<div class="l lc d32"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) VerifyHeaders(chain consensus.ChainReader, headers []*types.Header, seals []bool) (chan&lt;- struct{}, &lt;-chan error) {</span></div>
<div class="l li"><span class="si">    abort := make(chan struct{})</span></div>
<div class="l li"><span class="si">    results := make(chan error, len(headers))</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    go func() {</span></div>
<div class="l li"><span class="si">        for i, header := range headers {</span></div>
<div class="l lc d33"><span class="sc">            err := c.</span><span class="sc2">verifyHeader</span><span class="sc">(chain, header, headers[:i])</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">            select {</span></div>
<div class="l li"><span class="si">            case &lt;-abort:</span></div>
<div class="l li"><span class="si">                return</span></div>
<div class="l li"><span class="si">            case results &lt;- err:</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }()</span></div>
<div class="l li"><span class="si">    return abort, results</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l ld d34"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// verifyHeader checks whether a header conforms to the consensus rules.The</span></div>
<div class="l li"><span class="si">// caller may optionally pass in a batch of parents (ascending order) to avoid</span></div>
<div class="l li"><span class="si">// looking those up from the database. This is useful for concurrently verifying</span></div>
<div class="l li"><span class="si">// a batch of new headers.</span></div>
<div class="l lc d35"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) verifyHeader(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l li"><span class="si">    if header.Number == nil {</span></div>
<div class="l li"><span class="si">        return errUnknownBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Don't waste time checking blocks from the future</span></div>
<div class="l li"><span class="si">    if header.Time.Cmp(big.NewInt(time.Now().Unix())) &gt; 0 {</span></div>
<div class="l li"><span class="si">        return consensus.ErrFutureBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Checkpoint blocks need to enforce zero beneficiary</span></div>
<div class="l li"><span class="si">    checkpoint := (number % c.config.Epoch) == 0</span></div>
<div class="l li"><span class="si">    if checkpoint &amp;&amp; header.Coinbase != (common.Address{}) {</span></div>
<div class="l li"><span class="si">        return errInvalidCheckpointBeneficiary</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Nonces must be 0x00..0 or 0xff..f, zeroes enforced on checkpoints</span></div>
<div class="l li"><span class="si">    if !bytes.Equal(header.Nonce[:], nonceAuthVote) &amp;&amp; !bytes.Equal(header.Nonce[:], nonceDropVote) {</span></div>
<div class="l li"><span class="si">        return errInvalidVote</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if checkpoint &amp;&amp; !bytes.Equal(header.Nonce[:], nonceDropVote) {</span></div>
<div class="l li"><span class="si">        return errInvalidCheckpointVote</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Check that the extra-data contains both the vanity and signature</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraVanity {</span></div>
<div class="l li"><span class="si">        return errMissingVanity</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraVanity+extraSeal {</span></div>
<div class="l li"><span class="si">        return errMissingSignature</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the extra-data contains a signer list on checkpoint, but none otherwise</span></div>
<div class="l li"><span class="si">    signersBytes := len(header.Extra) - extraVanity - extraSeal</span></div>
<div class="l li"><span class="si">    if !checkpoint &amp;&amp; signersBytes != 0 {</span></div>
<div class="l li"><span class="si">        return errExtraSigners</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if checkpoint &amp;&amp; signersBytes%common.AddressLength != 0 {</span></div>
<div class="l li"><span class="si">        return errInvalidCheckpointSigners</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the mix digest is zero as we don't have fork protection currently</span></div>
<div class="l li"><span class="si">    if header.MixDigest != (common.Hash{}) {</span></div>
<div class="l li"><span class="si">        return errInvalidMixDigest</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the block doesn't contain any uncles which are meaningless in PoA</span></div>
<div class="l li"><span class="si">    if header.UncleHash != uncleHash {</span></div>
<div class="l li"><span class="si">        return errInvalidUncleHash</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the block's difficulty is meaningful (may not be correct at this point)</span></div>
<div class="l li"><span class="si">    if number &gt; 0 {</span></div>
<div class="l li"><span class="si">        if header.Difficulty == nil || (header.Difficulty.Cmp(diffInTurn) != 0 &amp;&amp; header.Difficulty.Cmp(diffNoTurn) != 0) {</span></div>
<div class="l li"><span class="si">            return errInvalidDifficulty</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // If all checks passed, validate any special fields for hard forks</span></div>
<div class="l li"><span class="si">    if err := misc.VerifyForkHashes(chain.Config(), header, false); err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // All basic checks passed, verify cascading fields</span></div>
<div class="l li"><span class="si">    return c.verifyCascadingFields(chain, header, parents)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// verifyCascadingFields verifies all the header fields that are not standalone,</span></div>
<div class="l li"><span class="si">// rather depend on a batch of previous headers. The caller may optionally pass</span></div>
<div class="l li"><span class="si">// in a batch of parents (ascending order) to avoid looking those up from the</span></div>
<div class="l li"><span class="si">// database. This is useful for concurrently verifying a batch of new headers.</span></div>
<div class="l lc d36"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) verifyCascadingFields(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l li"><span class="si">    // The genesis block is the always valid dead-end</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    if number == 0 {</span></div>
<div class="l li"><span class="si">        return nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Ensure that the block's timestamp isn't too close to it's parent</span></div>
<div class="l li"><span class="si">    var parent *types.Header</span></div>
<div class="l li"><span class="si">    if len(parents) &gt; 0 {</span></div>
<div class="l li"><span class="si">        parent = parents[len(parents)-1]</span></div>
<div class="l li"><span class="si">    } else {</span></div>
<div class="l li"><span class="si">        parent = chain.GetHeader(header.ParentHash, number-1)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if parent == nil || parent.Number.Uint64() != number-1 || parent.Hash() != header.ParentHash {</span></div>
<div class="l li"><span class="si">        return consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if parent.Time.Uint64()+c.config.Period &gt; header.Time.Uint64() {</span></div>
<div class="l li"><span class="si">        return ErrInvalidTimestamp</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d37"> </div>
<div class="l ld d37"> </div>
<div class="l ld d37"> </div>
<div class="l li"><span class="si">    // Retrieve the snapshot needed to verify this header and cache it</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, parents)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // If the block is a checkpoint block, verify the signer list</span></div>
<div class="l li"><span class="si">    if number%c.config.Epoch == 0 {</span></div>
<div class="l lc d38"><span class="sc">        </span><span class="sc2">signers</span><span class="sc"> := </span><span class="sa">make(</span><span class="sc">[]</span><span class="sa">byte, len(snap.Signers)*</span><span class="sc">common.</span><span class="sc2">AddressLength)</span></div>
<div class="l lc d38"><span class="sc">        </span><span class="sc2">for i, signer :</span><span class="sc">= </span><span class="sc2">range snap.signers()</span><span class="sc"> {</span></div>
<div class="l lc d38"><span class="sc">            </span><span class="sc2">copy</span><span class="sc">(</span><span class="sc2">signers[i*common.AddressLength:]</span><span class="sc">, </span><span class="sc2">signer[:]</span><span class="sc">)</span></div>
<div class="l lc d38"> </div>
<div class="l lc d38"> </div>
<div class="l li"><span class="si">        }</span></div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l ld d39"> </div>
<div class="l li"><span class="si">        extraSuffix := len(header.Extra) - extraSeal</span></div>
<div class="l lc d40"><span class="sc">        if !bytes.Equal(header.Extra[extraVanity:extraSuffix], </span><span class="sc2">signers</span><span class="sc">) {</span></div>
<div class="l lc d40"><span class="sc">            return </span><span class="sc2">errMismatchingCheckpointSigners</span></div>
<div class="l lc d40"> </div>
<div class="l lc d40"> </div>
<div class="l lc d40"> </div>
<div class="l lc d40"> </div>
<div class="l lc d40"> </div>
<div class="l lc d40"> </div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // All basic checks passed, verify the seal and return</span></div>
<div class="l li"><span class="si">    return c.verifySeal(chain, header, parents)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l ld d41"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// snapshot retrieves the authorization snapshot at a given point in time.</span></div>
<div class="l lc d42"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) snapshot(chain consensus.ChainReader, number uint64, hash common.Hash, parents []*types.Header) (*Snapshot, error) {</span></div>
<div class="l li"><span class="si">    // Search for a snapshot in memory or on disk for checkpoints</span></div>
<div class="l li"><span class="si">    var (</span></div>
<div class="l li"><span class="si">        headers []*types.Header</span></div>
<div class="l li"><span class="si">        snap    *Snapshot</span></div>
<div class="l li"><span class="si">    )</span></div>
<div class="l li"><span class="si">    for snap == nil {</span></div>
<div class="l li"><span class="si">        // If an in-memory snapshot was found, use that</span></div>
<div class="l li"><span class="si">        if s, ok := c.recents.Get(hash); ok {</span></div>
<div class="l li"><span class="si">            snap = s.(*Snapshot)</span></div>
<div class="l li"><span class="si">            break</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        // If an on-disk checkpoint snapshot can be found, use that</span></div>
<div class="l lc d43"><span class="sc">        </span><span class="sc2">if number%checkpointInterval</span><span class="sc"> =</span><span class="sc2">= 0 {</span></div>
<div class="l lc d43"> </div>
<div class="l li"><span class="si">            if s, err := loadSnapshot(c.config, c.signatures, c.db, hash); err == nil {</span></div>
<div class="l lc d44"><span class="sc">                log.Trace(&quot;Loaded voting snapshot </span><span class="sc2">from</span><span class="sc"> disk&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash)</span></div>
<div class="l li"><span class="si">                snap = s</span></div>
<div class="l li"><span class="si">                break</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l lc d45"><span class="sc">        // If we're at </span><span class="sa">an checkpoint</span><span class="sc"> block, make a snapshot </span><span class="sa">if it's known</span></div>
<div class="l lc d45"><span class="sc">        if number == 0 </span><span class="sa">|| (number%c.config.Epoch == 0 &amp;&amp; chain.GetHeaderByNumber(number-1) == nil)</span><span class="sc"> {</span></div>
<div class="l lc d45"><span class="sc">            </span><span class="sc2">checkpoint</span><span class="sc"> := chain.GetHeaderByNumber(</span><span class="sc2">number</span><span class="sc">)</span></div>
<div class="l lc d45"><span class="sc">            if </span><span class="sc2">checkpoint</span><span class="sc"> != nil {</span></div>
<div class="l lc d45"><span class="sc">                </span><span class="sc2">hash := checkpoint.Hash()</span></div>
<div class="l lg d45"> </div>
<div class="l lc d45"><span class="sc">                signers := make([]common.Address, (len(</span><span class="sc2">checkpoint</span><span class="sc">.Extra)-extraVanity-extraSeal)/common.AddressLength)</span></div>
<div class="l li"><span class="si">                for i := 0; i &lt; len(signers); i++ {</span></div>
<div class="l lc d46"><span class="sc">                    copy(signers[i][:], </span><span class="sc2">checkpoint</span><span class="sc">.Extra[extraVanity+i*common.AddressLength:])</span></div>
<div class="l li"><span class="si">                }</span></div>
<div class="l lc d47"><span class="sc">                snap = newSnapshot(c.config, c.signatures, </span><span class="sc2">number</span><span class="sc">, </span><span class="sc2">hash</span><span class="sc">, signers)</span></div>
<div class="l li"><span class="si">                if err := snap.store(c.db); err != nil {</span></div>
<div class="l li"><span class="si">                    return nil, err</span></div>
<div class="l li"><span class="si">                }</span></div>
<div class="l lc d48"><span class="sc">                log.</span><span class="sc2">Info</span><span class="sc">(&quot;Stored </span><span class="sc2">checkpoint</span><span class="sc"> snapshot to disk&quot;</span><span class="sa">, &quot;number&quot;, number, &quot;hash&quot;, hash</span><span class="sc">)</span></div>
<div class="l li"><span class="si">                break</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l la d49"><span class="sa">        }</span></div>
<div class="l li"><span class="si">        // No snapshot for this header, gather the header and move backward</span></div>
<div class="l li"><span class="si">        var header *types.Header</span></div>
<div class="l li"><span class="si">        if len(parents) &gt; 0 {</span></div>
<div class="l li"><span class="si">            // If we have explicit parents, pick from there (enforced)</span></div>
<div class="l li"><span class="si">            header = parents[len(parents)-1]</span></div>
<div class="l li"><span class="si">            if header.Hash() != hash || header.Number.Uint64() != number {</span></div>
<div class="l li"><span class="si">                return nil, consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">            parents = parents[:len(parents)-1]</span></div>
<div class="l li"><span class="si">        } else {</span></div>
<div class="l li"><span class="si">            // No explicit parents (or no more left), reach out to the database</span></div>
<div class="l li"><span class="si">            header = chain.GetHeader(hash, number)</span></div>
<div class="l li"><span class="si">            if header == nil {</span></div>
<div class="l li"><span class="si">                return nil, consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        headers = append(headers, header)</span></div>
<div class="l li"><span class="si">        number, hash = number-1, header.ParentHash</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Previous snapshot found, apply any pending headers on top of it</span></div>
<div class="l li"><span class="si">    for i := 0; i &lt; len(headers)/2; i++ {</span></div>
<div class="l li"><span class="si">        headers[i], headers[len(headers)-1-i] = headers[len(headers)-1-i], headers[i]</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    snap, err := snap.apply(headers)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return nil, err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    c.recents.Add(snap.Hash, snap)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // If we've generated a new checkpoint snapshot, save to disk</span></div>
<div class="l lc d50"><span class="sc">    if snap.Number%</span><span class="sc2">checkpointInterval</span><span class="sc"> == </span><span class="sa">0 &amp;&amp; len(headers) &gt;</span><span class="sc"> 0 {</span></div>
<div class="l li"><span class="si">        if err = snap.store(c.db); err != nil {</span></div>
<div class="l li"><span class="si">            return nil, err</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        log.Trace(&quot;Stored voting snapshot to disk&quot;, &quot;number&quot;, snap.Number, &quot;hash&quot;, snap.Hash)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return snap, err</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifyUncles implements consensus.Engine, always returning an error for any</span></div>
<div class="l li"><span class="si">// uncles as this consensus mechanism doesn't permit uncles.</span></div>
<div class="l lc d51"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) VerifyUncles(chain consensus.ChainReader, block *types.Block) error {</span></div>
<div class="l li"><span class="si">    if len(block.Uncles()) &gt; 0 {</span></div>
<div class="l li"><span class="si">        return errors.New(&quot;uncles not allowed&quot;)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// VerifySeal implements consensus.Engine, checking whether the signature contained</span></div>
<div class="l li"><span class="si">// in the header satisfies the consensus protocol requirements.</span></div>
<div class="l lc d52"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) VerifySeal(chain consensus.ChainReader, header *types.Header) error {</span></div>
<div class="l li"><span class="si">    return c.verifySeal(chain, header, nil)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// verifySeal checks whether the signature contained in the header satisfies the</span></div>
<div class="l li"><span class="si">// consensus protocol requirements. The method accepts an optional list of parent</span></div>
<div class="l li"><span class="si">// headers that aren't yet part of the local blockchain to generate the snapshots</span></div>
<div class="l li"><span class="si">// from.</span></div>
<div class="l lc d53"> </div>
<div class="l lc d53"> </div>
<div class="l lc d53"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) verifySeal(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {</span></div>
<div class="l li"><span class="si">    // Verifying the genesis block is not supported</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    if number == 0 {</span></div>
<div class="l li"><span class="si">        return errUnknownBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Retrieve the snapshot needed to verify this header and cache it</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, parents)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Resolve the authorization key and check against signers</span></div>
<div class="l lc d54"><span class="sc">    </span><span class="sc2">signer</span><span class="sc">, err := ecrecover(header, c.signatures)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"><span class="sc">    if _, ok := snap.Signers[</span><span class="sc2">signer</span><span class="sc">]; !ok {</span></div>
<div class="l lc d55"><span class="sc">        </span><span class="sc2">return errUnauthorizedSigner</span></div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l lc d55"> </div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d56"> </div>
<div class="l ld d56"> </div>
<div class="l ld d56"> </div>
<div class="l ld d56"> </div>
<div class="l ld d56"> </div>
<div class="l ld d56"> </div>
<div class="l ld d56"> </div>
<div class="l li"><span class="si">    for seen, recent := range snap.Recents {</span></div>
<div class="l lc d57"><span class="sc">        if recent == </span><span class="sc2">signer</span><span class="sc"> {</span></div>
<div class="l li"><span class="si">            // Signer is among recents, only fail if the current block doesn't shift it out</span></div>
<div class="l lc d58"> </div>
<div class="l lc d58"><span class="sc">            if limit := uint64(</span><span class="sa">len(snap.Signers)/</span><span class="sc">2 </span><span class="sa">+ 1</span><span class="sc">); seen &gt; number-limit {</span></div>
<div class="l lc d58"><span class="sc">                </span><span class="sc2">return errRecentlySigned</span></div>
<div class="l lc d58"> </div>
<div class="l lc d58"> </div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l la d59"><span class="sa">    // Ensure that the difficulty corresponds to the turn-ness of the signer</span></div>
<div class="l la d59"><span class="sa">    if !c.fakeDiff {</span></div>
<div class="l la d59"><span class="sa">        inturn := snap.inturn(header.Number.Uint64(), signer)</span></div>
<div class="l la d59"><span class="sa">        if inturn &amp;&amp; header.Difficulty.Cmp(diffInTurn) != 0 {</span></div>
<div class="l la d59"><span class="sa">            return errWrongDifficulty</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l la d60"><span class="sa">        if !inturn &amp;&amp; header.Difficulty.Cmp(diffNoTurn) != 0 {</span></div>
<div class="l la d60"><span class="sa">            return errWrongDifficulty</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l ld d61"> </div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d62"> </div>
<div class="l ld d62"> </div>
<div class="l ld d62"> </div>
<div class="l ld d62"> </div>
<div class="l ld d62"> </div>
<div class="l li"><span class="si">    return nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l ld d63"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Prepare implements consensus.Engine, preparing all the consensus fields of the</span></div>
<div class="l li"><span class="si">// header for running the transactions on top.</span></div>
<div class="l lc d64"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) Prepare(chain consensus.ChainReader, header *types.Header) error {</span></div>
<div class="l li"><span class="si">    // If the block isn't a checkpoint, cast a random vote (good enough for now)</span></div>
<div class="l li"><span class="si">    header.Coinbase = common.Address{}</span></div>
<div class="l li"><span class="si">    header.Nonce = types.BlockNonce{}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    // Assemble the voting snapshot to check which votes make sense</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, nil)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    if number%c.config.Epoch != 0 {</span></div>
<div class="l li"><span class="si">        c.lock.RLock()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">        // Gather all the proposals that make sense voting on</span></div>
<div class="l li"><span class="si">        addresses := make([]common.Address, 0, len(c.proposals))</span></div>
<div class="l li"><span class="si">        for address, authorize := range c.proposals {</span></div>
<div class="l li"><span class="si">            if snap.validVote(address, authorize) {</span></div>
<div class="l li"><span class="si">                addresses = append(addresses, address)</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        // If there's pending proposals, cast a vote on them</span></div>
<div class="l li"><span class="si">        if len(addresses) &gt; 0 {</span></div>
<div class="l li"><span class="si">            header.Coinbase = addresses[rand.Intn(len(addresses))]</span></div>
<div class="l li"><span class="si">            if c.proposals[header.Coinbase] {</span></div>
<div class="l li"><span class="si">                copy(header.Nonce[:], nonceAuthVote)</span></div>
<div class="l li"><span class="si">            } else {</span></div>
<div class="l li"><span class="si">                copy(header.Nonce[:], nonceDropVote)</span></div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">        c.lock.RUnlock()</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Set the correct difficulty</span></div>
<div class="l lc d65"><span class="sc">    header.Difficulty = </span><span class="sc2">CalcDifficulty</span><span class="sc">(</span><span class="sc2">snap, c.signer</span><span class="sc">)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Ensure the extra data has all it's components</span></div>
<div class="l li"><span class="si">    if len(header.Extra) &lt; extraVanity {</span></div>
<div class="l li"><span class="si">        header.Extra = append(header.Extra, bytes.Repeat([]byte{0x00}, extraVanity-len(header.Extra))...)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    header.Extra = header.Extra[:extraVanity]</span></div>
<div class="l ld d66"> </div>
<div class="l lg"> </div>
<div class="l li"><span class="si">    if number%c.config.Epoch == 0 {</span></div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"> </div>
<div class="l lc d67"><span class="sc">        for _, signer := range </span><span class="sa">snap.</span><span class="sc">signers</span><span class="sa">()</span><span class="sc"> {</span></div>
<div class="l li"><span class="si">            header.Extra = append(header.Extra, signer[:]...)</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    header.Extra = append(header.Extra, make([]byte, extraSeal)...)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Mix digest is reserved for now, set to empty</span></div>
<div class="l li"><span class="si">    header.MixDigest = common.Hash{}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Ensure the timestamp has the correct delay</span></div>
<div class="l li"><span class="si">    parent := chain.GetHeader(header.ParentHash, number-1)</span></div>
<div class="l li"><span class="si">    if parent == nil {</span></div>
<div class="l li"><span class="si">        return consensus.ErrUnknownAncestor</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    header.Time = new(big.Int).Add(parent.Time, new(big.Int).SetUint64(c.config.Period))</span></div>
<div class="l li"><span class="si">    if header.Time.Int64() &lt; time.Now().Unix() {</span></div>
<div class="l li"><span class="si">        header.Time = big.NewInt(time.Now().Unix())</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d68"> </div>
<div class="l ld d68"> </div>
<div class="l ld d68"> </div>
<div class="l ld d68"> </div>
<div class="l ld d68"> </div>
<div class="l ld d68"> </div>
<div class="l li"><span class="si">    return nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l ld d69"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Finalize implements consensus.Engine, ensuring no uncles are set, nor block</span></div>
<div class="l li"><span class="si">// rewards given, and returns the final block.</span></div>
<div class="l lc d70"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) Finalize(chain consensus.ChainReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, receipts []*types.Receipt) (*types.Block, error) {</span></div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l lc d70"> </div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // No block rewards in PoA, so the state remains as is and uncles are dropped</span></div>
<div class="l li"><span class="si">    header.Root = state.IntermediateRoot(chain.Config().IsEIP158(header.Number))</span></div>
<div class="l li"><span class="si">    header.UncleHash = types.CalcUncleHash(nil)</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Assemble and return the final block for sealing</span></div>
<div class="l li"><span class="si">    return types.NewBlock(header, txs, nil, receipts), nil</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Authorize injects a private key into the consensus engine to mint new blocks</span></div>
<div class="l li"><span class="si">// with.</span></div>
<div class="l lc d71"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) Authorize(signer common.Address, signFn SignerFn) {</span></div>
<div class="l li"><span class="si">    c.lock.Lock()</span></div>
<div class="l li"><span class="si">    defer c.lock.Unlock()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    c.signer = signer</span></div>
<div class="l li"><span class="si">    c.signFn = signFn</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// Seal implements consensus.Engine, attempting to create a sealed block using</span></div>
<div class="l li"><span class="si">// the local signing credentials.</span></div>
<div class="l lc d72"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) Seal(chain consensus.ChainReader, block *types.Block, </span><span class="sa">results chan&lt;- *types.Block,</span><span class="sc"> stop &lt;-chan struct{}) error {</span></div>
<div class="l li"><span class="si">    header := block.Header()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Sealing the genesis block is not supported</span></div>
<div class="l li"><span class="si">    number := header.Number.Uint64()</span></div>
<div class="l li"><span class="si">    if number == 0 {</span></div>
<div class="l lc d73"><span class="sc">        return errUnknownBlock</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // For 0-period chains, refuse to seal empty blocks (no reward but would spin sealing)</span></div>
<div class="l li"><span class="si">    if c.config.Period == 0 &amp;&amp; len(block.Transactions()) == 0 {</span></div>
<div class="l lc d74"><span class="sc">        </span><span class="sc2">log.Info(&quot;Sealing paused</span><span class="sc">, </span><span class="sc2">waiting for transactions&quot;)</span></div>
<div class="l lc d74"><span class="sc">        </span><span class="sa">return nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Don't hold the signer fields for the entire sealing procedure</span></div>
<div class="l li"><span class="si">    c.lock.RLock()</span></div>
<div class="l li"><span class="si">    signer, signFn := c.signer, c.signFn</span></div>
<div class="l li"><span class="si">    c.lock.RUnlock()</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">    // Bail out if we're unauthorized to sign a block</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, number-1, header.ParentHash, nil)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l lc d75"><span class="sc">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l ld d76"> </div>
<div class="l li"><span class="si">    if _, authorized := snap.Signers[signer]; !authorized {</span></div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"> </div>
<div class="l lc d77"><span class="sc">        return </span><span class="sc2">errUnauthorizedSigner</span></div>
<div class="l lc d77"> </div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // If we're amongst the recent signers, wait for the next block</span></div>
<div class="l ld d78"> </div>
<div class="l ld d78"> </div>
<div class="l li"><span class="si">    for seen, recent := range snap.Recents {</span></div>
<div class="l li"><span class="si">        if recent == signer {</span></div>
<div class="l li"><span class="si">            // Signer is among recents, only wait if the current block doesn't shift it out</span></div>
<div class="l lc d79"> </div>
<div class="l lc d79"><span class="sc">            if limit := uint64(</span><span class="sa">len(snap.Signers)/</span><span class="sc">2 </span><span class="sa">+ 1</span><span class="sc">); number &lt; limit || seen &gt; number-limit {</span></div>
<div class="l lc d79"> </div>
<div class="l lc d79"> </div>
<div class="l lc d79"> </div>
<div class="l li"><span class="si">                log.Info(&quot;Signed recently, must wait for others&quot;)</span></div>
<div class="l lc d80"> </div>
<div class="l lc d80"><span class="sc">                return nil</span></div>
<div class="l lc d80"> </div>
<div class="l lc d80"> </div>
<div class="l li"><span class="si">            }</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l lc d81"><span class="sc">    </span><span class="sc2">// Sweet, the protocol permits us to sign the block, wait for our time</span></div>
<div class="l lc d81"><span class="sc">    </span><span class="sc2">delay</span><span class="sc"> :</span><span class="sa">= time.Unix(header.Time.Int64(), 0).Sub(time.Now()) // nolint: gosimple</span></div>
<div class="l lc d81"><span class="sc">    </span><span class="sc2">if header.Difficulty.Cmp(diffNoTurn) == 0 {</span></div>
<div class="l lc d81"><span class="sc">        </span><span class="sc2">// It's not our turn explicitly to sign, delay it a bit</span></div>
<div class="l lc d81"><span class="sc">        </span><span class="sa">wiggle := time.Duration(len(snap.Signers)/2+1) * wiggleTime</span></div>
<div class="l lc d81"><span class="sc">        </span><span class="sa">delay += time.Duration(rand.Int63n(int64(wiggle)))</span></div>
<div class="l lg d81"> </div>
<div class="l lc d81"><span class="sc">        </span><span class="sa">log.Trace(&quot;Out-of-turn signing requested&quot;, &quot;wiggle&quot;, common.PrettyDuration(wiggle))</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    // Sign all the things!</span></div>
<div class="l li"><span class="si">    sighash, err := signFn(accounts.Account{Address: signer}, sigHash(header).Bytes())</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l lc d82"><span class="sc">        return err</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    copy(header.Extra[len(header.Extra)-extraSeal:], sighash)</span></div>
<div class="l li"> </div>
<div class="l lc d83"><span class="sc">    </span><span class="sc2">// Wait until sealing is terminated or delay timeout</span><span class="sc">.</span></div>
<div class="l lc d83"><span class="sc">    </span><span class="sa">log.Trace(&quot;Waiting for slot to sign and propagate&quot;, &quot;delay&quot;, common.PrettyDuration(delay))</span></div>
<div class="l lc d83"><span class="sc">    </span><span class="sa">go func() {</span></div>
<div class="l lc d83"><span class="sc">        </span><span class="sa">select {</span></div>
<div class="l lc d83"><span class="sc">        </span><span class="sa">case &lt;-stop:</span></div>
<div class="l lc d83"><span class="sc">            </span><span class="sa">return</span></div>
<div class="l lc d83"><span class="sc">        </span><span class="sa">case &lt;-time.After(delay):</span></div>
<div class="l li"><span class="si">        }</span></div>
<div class="l lg"> </div>
<div class="l la d84"><span class="sa">        select {</span></div>
<div class="l la d84"><span class="sa">        case results &lt;- block.WithSeal(header):</span></div>
<div class="l la d84"><span class="sa">        default:</span></div>
<div class="l la d84"><span class="sa">            log.Warn(&quot;Sealing result is not read by miner&quot;, &quot;sealhash&quot;, c.SealHash(header))</span></div>
<div class="l la d84"><span class="sa">        }</span></div>
<div class="l la d84"><span class="sa">    }()</span></div>
<div class="l lg d84"> </div>
<div class="l la d84"><span class="sa">    return nil</span></div>
<div class="l la d84"><span class="sa">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// CalcDifficulty is the difficulty adjustment algorithm. It returns the difficulty</span></div>
<div class="l li"><span class="si">// that a new block should have based on the previous blocks in the chain and the</span></div>
<div class="l li"><span class="si">// current signer.</span></div>
<div class="l lc d85"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) CalcDifficulty(chain consensus.ChainReader, time uint64, parent *types.Header) *big.Int {</span></div>
<div class="l li"><span class="si">    snap, err := c.snapshot(chain, parent.Number.Uint64(), parent.Hash(), nil)</span></div>
<div class="l li"><span class="si">    if err != nil {</span></div>
<div class="l li"><span class="si">        return nil</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return CalcDifficulty(snap, c.signer)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// CalcDifficulty is the difficulty adjustment algorithm. It returns the difficulty</span></div>
<div class="l li"><span class="si">// that a new block should have based on the previous blocks in the chain and the</span></div>
<div class="l li"><span class="si">// current signer.</span></div>
<div class="l li"><span class="si">func CalcDifficulty(snap *Snapshot, signer common.Address) *big.Int {</span></div>
<div class="l li"><span class="si">    if snap.inturn(snap.Number+1, signer) {</span></div>
<div class="l li"><span class="si">        return new(big.Int).Set(diffInTurn)</span></div>
<div class="l li"><span class="si">    }</span></div>
<div class="l li"><span class="si">    return new(big.Int).Set(diffNoTurn)</span></div>
<div class="l li"><span class="si">}</span></div>
<div class="l lg"> </div>
<div class="l la d86"><span class="sa">// SealHash returns the hash of a block prior to it being sealed.</span></div>
<div class="l la d86"><span class="sa">func (c *Clique) SealHash(header *types.Header) common.Hash {</span></div>
<div class="l la d86"><span class="sa">    return sigHash(header)</span></div>
<div class="l la d86"><span class="sa">}</span></div>
<div class="l lg d86"> </div>
<div class="l la d86"><span class="sa">// Close implements consensus.Engine. It's a noop for clique as there are no background threads.</span></div>
<div class="l la d86"><span class="sa">func (c *Clique) Close() error {</span></div>
<div class="l la d86"><span class="sa">    return nil</span></div>
<div class="l la d86"><span class="sa">}</span></div>
<div class="l li"> </div>
<div class="l li"><span class="si">// APIs implements consensus.Engine, returning the user facing RPC API to allow</span></div>
<div class="l li"><span class="si">// controlling the signer voting.</span></div>
<div class="l lc d87"><span class="sc">func (c *</span><span class="sc2">Clique</span><span class="sc">) APIs(chain consensus.ChainReader) []rpc.API {</span></div>
<div class="l li"><span class="si">    return []rpc.API{{</span></div>
<div class="l lc d88"><span class="sc">        Namespace: &quot;</span><span class="sc2">clique</span><span class="sc">&quot;,</span></div>
<div class="l li"><span class="si">        Version:   &quot;1.0&quot;,</span></div>
<div class="l lc d89"><span class="sc">        Service:   &amp;API{chain: chain, </span><span class="sc2">clique</span><span class="sc">: c},</span></div>
<div class="l li"><span class="si">        Public:    false,</span></div>
<div class="l li"><span class="si">    }}</span></div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l ld d90"> </div>
<div class="l li"><span class="si">}</span></div>
<div class="l li"> </div>

                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div id="inspector" style="display: none;">
            <div class="left line">
                <table id="inspectorLeft" class="inspectorLine">
                    <tr>
                        <td class="diffBar" style="display: none;"></td>
                        <td class="nums">
                            <div class="num"></div>
                        </td>
                        <td class="content">
                            <div id="inspectorLeftContent"></div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="right line">
                <table id="inspectorRight" class="inspectorLine">
                    <tr>
                        <td class="diffBar" style="display: none;"></td>
                        <td class="nums">
                            <div class="num"></div>
                        </td>
                        <td class="content">
                            <div id="inspectorRightContent"></div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div id="legend">
            <div id="numDiffs"><b>90 differences</b>: 529 lines, 225 inline differences in 192 changed lines</div><div id="colors"><div class="sa" title="Added lines: 30, inline additions in changed lines: 33">Added(30,33)</div><div class="sd" title="Deleted lines: 307, inline deletions in changed lines: 105">Deleted(307,105)</div><div class="sc" title="Changed lines: 192">Changed(192)</div><div class="sc2" title="Inline changes in changed lines: 87">Changed in changed(87)</div><div class="sig" title="Ignored lines and line parts">Ignored</div></div>
        </div>

        <div id="generated_by">
            Generated on December 4, 2018, 8:44 PM by <a href="http://www.prestosoft.com/edp_examdiffpro.asp?ref=diffreport" target="_blank">ExamDiff Pro</a> 10.0.1.2.
        </div>
    </div>
</body>

</html>
